<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad - Administración (Ingresos)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir menú">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="#" class="active">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administración</a></li>
                        <li><a href="trazabilidades.html" class="nav-admin-only">Trazabilidades</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspección</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>

               
            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main class="actividad-page actividadlist-wrap">
        <!-- Tarjetas resumen -->
        <section class="dashboard-cards" style="margin-bottom: 0.75rem;">
            <div class="dash-card">
                <div class="dash-card-label">Ingresos acumulados (visibles)</div>
                <div class="dash-card-value" id="adm-total-ingresos">$0</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Rentas acumuladas (visibles)</div>
                <div class="dash-card-value" id="adm-total-rentas">$0</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Ticket promedio (visibles)</div>
                <div class="dash-card-value" id="adm-ticket-promedio">$0</div>
            </div>
        </section>

        <!-- Filtro, edición en lote, filtros de estado, contador y ayuda -->
        <section class="actividad-toolbar" style="margin-bottom: 0.75rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; justify-content:space-between;">
            <div class="actividad-toolbar-left" style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                <input type="search" id="adm-buscar" placeholder="Buscar por cliente, equipo, OS, factura..." style="min-width: 260px;">

                <div style="display:flex; flex-direction:column; font-size:0.75rem; color:#4b5563;">
                    <label for="adm-filtro-estado">Estado</label>
                    <select id="adm-filtro-estado" style="font-size:0.8rem; padding:0.2rem 0.35rem; min-width:130px;">
                        <option value="TODOS">Todos</option>
                        <option value="ABIERTO">Solo abiertos</option>
                        <option value="PARCIAL">Solo parciales</option>
                        <option value="FINAL">Solo finales</option>
                    </select>
                </div>

                <!-- Controles de edición en lote -->
                <div style="display:flex; flex-wrap:wrap; gap:0.25rem; align-items:flex-end;">
                    <div style="display:flex; flex-direction:column;">
                        <label for="adm-lote-fecha" style="font-size:0.75rem; color:#4b5563;">Fecha term. lote (dd/mm/aa)</label>
                        <input type="text" id="adm-lote-fecha" placeholder="__/__/__" maxlength="8" style="font-size:0.8rem; padding:0.2rem 0.35rem; width:100px;">
                    </div>
                    <button type="button" id="adm-aplicar-fecha-lote" style="font-size:0.75rem; padding:0.3rem 0.5rem;">Aplicar fecha a selección</button>

                    <div style="display:flex; flex-direction:column; margin-left:0.5rem;">
                        <label for="adm-lote-precio" style="font-size:0.75rem; color:#4b5563;">Precio lote</label>
                        <input type="number" id="adm-lote-precio" min="0" step="1" style="font-size:0.8rem; padding:0.2rem 0.35rem; width:100px;">
                    </div>
                    <button type="button" id="adm-aplicar-precio-lote" style="font-size:0.75rem; padding:0.3rem 0.5rem;">Aplicar precio a selección</button>
                </div>
            </div>
            <div class="actividad-toolbar-right" style="font-size: 0.85rem; color:#4b5563; display:flex; gap:0.5rem; align-items:center;">
                <button id="adm-btn-ayuda" type="button" style="font-size:0.8rem; padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; cursor:pointer;">
                    Ver ayuda
                </button>
                <span id="adm-contador">0 registros</span>
            </div>
        </section>

        <!-- Panel de ayuda / tutorial, visible solo cuando el usuario lo activa -->
        <section id="adm-ayuda-panel" style="display:none; margin:0 0.75rem 0.75rem; padding:0.75rem 1rem; background:#ecfeff; border:1px solid #bae6fd; border-radius:0.5rem; font-size:0.85rem; color:#0f172a; max-width:1000px;">
            <h2 style="margin:0 0 0.4rem; font-size:0.95rem; font-weight:600;">Cómo usar esta vista de administración</h2>
            <ol style="margin:0 0 0.5rem 1.25rem; padding:0; list-style:decimal;">
                <li style="margin-bottom:0.25rem;">Arriba se muestran los totales de ingresos y ticket promedio de los registros visibles.</li>
                <li style="margin-bottom:0.25rem;">Usa el buscador y los filtros de equipo / inicio para acotar los registros.</li>
                <li style="margin-bottom:0.25rem;">Selecciona filas, áreas o ubicaciones completas con los checkboxes de la izquierda.</li>
                <li style="margin-bottom:0.25rem;">Aplica fecha de terminación o precio en lote usando los controles de la barra superior.</li>
                <li style="margin-bottom:0.25rem;">Edita OC y terminación directamente en la tabla; los cambios se guardan al salir del campo.</li>
            </ol>
            <p style="margin:0; font-size:0.8rem; color:#475569;">Tip: las actividades abiertas se muestran primero en la tabla para que puedas enfocarte en lo que sigue en servicio.</p>
        </section>

        <!-- Tabla editable -->
        <section class="detalle-equipo" style="padding: 0.75rem 0.75rem 1rem; max-width: 100%;">
            <div class="tabla-inspecciones-wrapper" style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.9rem; min-width:900px;">
                    <thead>
                        <tr style="background:#f3f4f6;">
                            <th style="text-align:center; padding:0.4rem; width:32px;">
                                <input type="checkbox" id="adm-select-todos" title="Seleccionar / deseleccionar todos">
                            </th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Cliente</th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Área</th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Ubicación</th>
                            <th id="adm-th-equipo" style="text-align:left; padding:0.4rem; cursor:pointer;">Equipo / Activo</th>
                            <th style="text-align:left; padding:0.4rem;">Descripción</th>
                            <th id="adm-th-inicio" style="text-align:left; padding:0.4rem; cursor:pointer;">Inicio del servicio</th>
                            <th style="text-align:left; padding:0.4rem;">Parcial / Final</th>
                            <th style="text-align:left; padding:0.4rem;">Días en servicio</th>
                            <th style="text-align:left; padding:0.4rem;">Precio</th>
                            <th style="text-align:left; padding:0.4rem;">Ingreso acumulado</th>
                            <th style="text-align:left; padding:0.4rem;">OS</th>
                            <th style="text-align:left; padding:0.4rem;">OC</th>
                            <th style="text-align:left; padding:0.4rem;">Factura</th>
                            <th style="text-align:left; padding:0.4rem;">Acciones</th>
                        </tr>
                    </thead>
                    <thead>
                        <tr style="background:#f9fafb;">
                            <th></th>
                            <th style="display:none;"></th>
                            <th style="display:none;"></th>
                            <th style="display:none;"></th>
                            <th style="padding:0.2rem 0.4rem;">
                                <input type="text" id="adm-filtro-equipo" placeholder="Filtrar equipo" style="width:100%; font-size:0.75rem; padding:0.15rem 0.3rem;">
                            </th>
                            <th style="padding:0.2rem 0.4rem;">
                                <input type="text" id="adm-filtro-descripcion" placeholder="Filtrar descripción" style="width:100%; font-size:0.75rem; padding:0.15rem 0.3rem;">
                            </th>
                            <th style="padding:0.2rem 0.4rem;">
                                <input type="text" id="adm-filtro-inicio" placeholder="Filtrar inicio (dd/mm/aa)" maxlength="8" style="width:100%; font-size:0.75rem; padding:0.15rem 0.3rem;">
                            </th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="adm-tbody-actividad">
                    </tbody>
                </table>
            </div>
            <p id="adm-msg-vacio" style="font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:none;">
                No hay registros de actividad todavía.
            </p>
        </section>
    </main>

    <!-- Modal simple para tabulador de períodos de facturación -->
    <div id="adm-modal-tabulador" style="position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:50;">
        <div style="background:white; max-width:900px; width:95%; max-height:90vh; overflow:auto; border-radius:0.5rem; box-shadow:0 10px 40px rgba(15,23,42,0.35); padding:1rem 1.25rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
                <div>
                    <h2 style="margin:0; font-size:1.1rem; font-weight:600; color:#111827;">Tabulador de facturación</h2>
                    <p id="adm-tabulador-header" style="margin:0.15rem 0 0; font-size:0.85rem; color:#4b5563;"></p>
                </div>
                <div>
                    <button id="adm-tabulador-imprimir" type="button" style="font-size:0.8rem; margin-right:0.5rem;">Imprimir</button>
                    <button id="adm-tabulador-cerrar" type="button" style="font-size:0.8rem;">Cerrar</button>
                </div>
            </div>

            <div style="margin-bottom:0.75rem; padding:0.75rem; background:#f9fafb; border-radius:0.5rem; border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 0.5rem; font-size:0.95rem; font-weight:500; color:#111827;">Nuevo período</h3>
                <div style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                    <div style="flex:1 1 120px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Inicio período</label>
                        <input id="adm-per-inicio" type="text" placeholder="__/__/__" maxlength="8" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:1 1 120px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Fin período</label>
                        <input id="adm-per-fin" type="text" placeholder="__/__/__" maxlength="8" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Tipo</label>
                        <select id="adm-per-tipo" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                            <option value="PARCIAL">PARCIAL</option>
                            <option value="FINAL">FINAL</option>
                        </select>
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Tarifa diaria</label>
                        <input id="adm-per-tarifa" type="number" min="0" step="1" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:0 0 80px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Días</label>
                        <input id="adm-per-dias" type="number" min="0" step="1" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;" disabled>
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Importe</label>
                        <input id="adm-per-importe" type="number" min="0" step="1" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;" disabled>
                    </div>
                    <div style="flex:1 1 140px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Factura</label>
                        <input id="adm-per-factura" type="text" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:1 1 140px;">
                        <label style="font-size:0.75rem; color:#4b5563;">OC</label>
                        <input id="adm-per-oc" type="text" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:2 1 220px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Observaciones</label>
                        <input id="adm-per-obs" type="text" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:0 0 auto;">
                        <button id="adm-per-guardar" type="button" style="margin-top:1rem; font-size:0.8rem;">Agregar período</button>
                    </div>
                </div>
            </div>

            <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                <thead>
                    <tr style="background:#f3f4f6;">
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Inicio</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Fin</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Días</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Tarifa diaria</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Importe</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Tipo</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">OC</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Factura</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Observaciones</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="adm-tabulador-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Inicialización de Firebase/Auth/Firestore para esta página -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCmutjS09d1hCjwlhuH0upkGr_TIVVBktc",
        authDomain: "xpct-tab.firebaseapp.com",
        projectId: "xpct-tab",
        storageBucket: "xpct-tab.firebasestorage.app",
        messagingSenderId: "614589989974",
        appId: "1:614589989974:web:e89a808180e4b563a8e7f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    const auth = getAuth(app);
    window.auth = auth;

    const ADMINS = [
        "the@unknownshoppers.com",
        "jalcz@pct.com"
    ];
    const INSPECTORES = [
        "inspector01@pct.com",
        "inspector02@pct.com"
    ];

    const emailSpan = document.getElementById('nav-user-email');
    const btnLogout = document.getElementById('btn-logout');

    // Mapa de descripcion por equipo desde invre.csv
    window.mapaDescripcionPorEquipoAdm = window.mapaDescripcionPorEquipoAdm || {};
    const mapaDescripcionPorEquipoAdm = window.mapaDescripcionPorEquipoAdm;

    (async () => {
        try {
            const resp = await fetch('docs/invre.csv');
            if (!resp.ok) return;
            const texto = await resp.text();
            const lineas = texto.split(/\r?\n/).filter(l => l.trim() !== '');
            if (!lineas.length) return;

            const parse = (window && window.parseCSVLine) ? window.parseCSVLine : null;
            if (!parse) return;

            const headers = parse(lineas[0]);
            const idxEquipo = headers.indexOf('EQUIPO / ACTIVO');
            const idxDesc = headers.indexOf('DESCRIPCION');
            if (idxEquipo < 0 || idxDesc < 0) return;

            lineas.slice(1).forEach(l => {
                const cols = parse(l);
                const eq = (cols[idxEquipo] || '').toString().trim();
                const desc = (cols[idxDesc] || '').toString().trim();
                if (!eq || !desc) return;
                if (!mapaDescripcionPorEquipoAdm[eq]) {
                    mapaDescripcionPorEquipoAdm[eq] = desc;
                }
            });
        } catch (e) {
            console.warn('No se pudo cargar invre.csv para descripciones (admin)', e);
        }
    })();

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        // Migración opcional: marcar terminaciones PARCIALES a partir de los períodos de facturación.
        // Uso sugerido: abrir consola en actividadmin.html y ejecutar
        //   marcarTerminacionesParcialesDesdePeriodos()
        // para sincronizar terminacionServicio en actividades que ya tienen períodos PARCIALES
        // pero siguen marcadas como ABIERTAS.
        async function marcarTerminacionesParcialesDesdePeriodos() {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible para migrar terminaciones parciales');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, query, where, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();

                // Parser local dd/mm/aa -> Date
                function parseFechaDdMmAaLocal(fechaTexto) {
                    if (!fechaTexto) return null;
                    const partes = fechaTexto.split('/');
                    if (partes.length !== 3) return null;
                    const dd = parseInt(partes[0], 10);
                    const mm = parseInt(partes[1], 10);
                    const aa = parseInt(partes[2], 10);
                    if (!dd || !mm || isNaN(aa)) return null;
                    const yyyy = 2000 + aa;
                    const d = new Date(yyyy, mm - 1, dd);
                    if (isNaN(d.getTime())) return null;
                    return d;
                }

                const colAct = collection(db, 'actividades');
                const snapAct = await getDocs(colAct);

                const candidatos = snapAct.docs
                    .map(d => ({ id: d.id, ...(d.data() || {}) }))
                    .filter(a => {
                        const tieneFin = (a.terminacionServicio || '').toString().trim() !== '';
                        const flagFinal = a.terminacionEsFinal === true;
                        // Solo actividades sin terminación o con terminación vacía y no marcadas como FINAL
                        return !tieneFin && !flagFinal;
                    });

                if (!candidatos.length) {
                    console.log('No se encontraron actividades candidatas a marcar como PARCIAL.');
                    return;
                }

                const colPer = collection(db, 'actividadPeriodos');
                let actualizados = 0;

                for (const act of candidatos) {
                    const qPer = query(colPer, where('actividadId', '==', act.id));
                    const snapPer = await getDocs(qPer);
                    if (snapPer.empty) continue;

                    // Tomar el último período por fecha de finPeriodo
                    const periodos = snapPer.docs
                        .map(d => d.data() || {})
                        .filter(p => (p.finPeriodo || '').toString().trim() !== '');
                    if (!periodos.length) continue;

                    periodos.sort((p1, p2) => {
                        const f1 = (p1.finPeriodo || '').toString();
                        const f2 = (p2.finPeriodo || '').toString();
                        const d1 = parseFechaDdMmAaLocal(f1) || new Date(2000, 0, 1);
                        const d2 = parseFechaDdMmAaLocal(f2) || new Date(2000, 0, 1);
                        return d1.getTime() - d2.getTime();
                    });

                    const ultimo = periodos[periodos.length - 1];
                    if (!ultimo || !(ultimo.finPeriodo || '').toString().trim()) continue;

                    const finUltimo = (ultimo.finPeriodo || '').toString().trim();

                    await updateDoc(doc(db, 'actividades', act.id), {
                        terminacionServicio: finUltimo,
                        terminacionEsFinal: false,
                    });
                    actualizados++;
                }

                console.log(`Marcado de terminaciones parciales completado. Actividades actualizadas: ${actualizados}`);
            } catch (e) {
                console.error('Error al marcar terminaciones parciales desde períodos', e);
            }
        }

        const email = (user.email || '').toLowerCase();
        if (emailSpan) emailSpan.textContent = email;

        window.isAdmin = ADMINS.includes(email);

        // Solo admins deben ver esta página
        if (!ADMINS.includes(email)) {
            if (INSPECTORES.includes(email)) {
                window.location.href = 'inspeccion.html';
            } else {
                window.location.href = 'login.html';
            }
        }

        // Migración de OS existentes al nuevo formato PCT-YY-XXX
        // Regla:
        //  - Para cada actividad con inicioServicio válido (dd/mm/aa), se toma YY del año.
        //  - Dentro de cada año, se asignan consecutivos 001, 002, 003... en orden de inicioServicio.
        //  - OS resultante: PCT-YY-XXX
        // Uso: abrir consola en actividadmin.html y ejecutar:
        //   migrarOsFormatoNuevo()
        async function migrarOsFormatoNuevo() {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible para migrar OS');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();

                // Parser local de fecha dd/mm/aa a Date (año base 2000+aa)
                function parseFechaDdMmAaLocal(fechaTexto) {
                    if (!fechaTexto) return null;
                    const partes = fechaTexto.split('/');
                    if (partes.length !== 3) return null;
                    const dd = parseInt(partes[0], 10);
                    const mm = parseInt(partes[1], 10);
                    const aa = parseInt(partes[2], 10);
                    if (!dd || !mm || isNaN(aa)) return null;
                    const yyyy = 2000 + aa;
                    const d = new Date(yyyy, mm - 1, dd);
                    if (isNaN(d.getTime())) return null;
                    return d;
                }

                const colAct = collection(db, 'actividades');
                const snapAct = await getDocs(colAct);

                const actividades = snapAct.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
                if (!actividades.length) {
                    console.log('No hay actividades para migrar OS.');
                    return;
                }

                // Agrupar por combinación cliente+ubicacion+año (YY) tomada de inicioServicio (dd/mm/aa)
                const porClave = new Map(); // clave = cliente|ubicacion|YY -> array de actividades
                actividades.forEach(act => {
                    const ini = (act.inicioServicio || '').toString();
                    const dIni = parseFechaDdMmAaLocal(ini);
                    if (!dIni) return;

                    const yy = String(dIni.getFullYear()).slice(-2);
                    const cli = (act.cliente || '').toString();
                    const ubi = (act.ubicacion || '').toString();
                    if (!cli || !ubi) return;

                    const clave = `${cli}||${ubi}||${yy}`;

                    if (!porClave.has(clave)) porClave.set(clave, []);
                    porClave.get(clave).push(act);
                });

                let totalActualizadas = 0;

                for (const [clave, lista] of porClave.entries()) {
                    const partesClave = clave.split('||');
                    const yy = partesClave[2] || '';

                    // Ordenar por fecha de inicio dentro de la combinación para asignar consecutivos estables
                    lista.sort((a, b) => {
                        const da = parseFechaDdMmAaLocal(a.inicioServicio || '') || new Date(2000, 0, 1);
                        const dbDate = parseFechaDdMmAaLocal(b.inicioServicio || '') || new Date(2000, 0, 1);
                        return da.getTime() - dbDate.getTime();
                    });

                    let consec = 0;
                    for (const act of lista) {
                        consec += 1;
                        const consecutivo = String(consec).padStart(3, '0');
                        const nuevaOs = `PCT-${yy}-${consecutivo}`;

                        // Solo actualizar si cambia, para minimizar escrituras
                        if ((act.os || '').toString().trim() === nuevaOs) continue;

                        await updateDoc(doc(db, 'actividades', act.id), { os: nuevaOs });
                        totalActualizadas += 1;
                    }
                }

                console.log(`Migración de OS completada. Actividades actualizadas: ${totalActualizadas}`);
            } catch (e) {
                console.error('Error al migrar OS a formato nuevo', e);
            }
        }

        // Marcado automático de terminaciones definitivas históricas.
        // Uso sugerido: abrir consola en actividadmin.html y ejecutar
        //   marcarTerminacionesFinalesDesdePeriodos()
        // para sincronizar terminacionEsFinal en actividades antiguas.
        async function marcarTerminacionesFinalesDesdePeriodos() {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible para migrar terminaciones finales');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, query, where, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();

                const colAct = collection(db, 'actividades');
                const snapAct = await getDocs(colAct);

                const candidatos = snapAct.docs
                    .map(d => ({ id: d.id, ...(d.data() || {}) }))
                    .filter(a => {
                        const tieneFin = (a.terminacionServicio || '').toString().trim() !== '';
                        const flagFinal = a.terminacionEsFinal === true;
                        return tieneFin && !flagFinal;
                    });

                if (!candidatos.length) {
                    console.log('No se encontraron actividades candidatas a marcar como FINAL.');
                    return;
                }

                const colPer = collection(db, 'actividadPeriodos');
                let actualizados = 0;

                for (const act of candidatos) {
                    const finServ = (act.terminacionServicio || '').toString().trim();
                    if (!finServ) continue;

                    const qPer = query(colPer, where('actividadId', '==', act.id));
                    const snapPer = await getDocs(qPer);
                    if (snapPer.empty) continue;

                    const tieneFinalCoincidente = snapPer.docs.some(d => {
                        const p = d.data() || {};
                        const tipo = (p.tipoPeriodo || '').toString().toUpperCase();
                        const finPer = (p.finPeriodo || '').toString().trim();
                        return tipo === 'FINAL' && finPer === finServ;
                    });

                    if (!tieneFinalCoincidente) continue;

                    await updateDoc(doc(db, 'actividades', act.id), { terminacionEsFinal: true });
                    actualizados++;
                }

                console.log(`Marcado de terminaciones definitivas completado. Actividades actualizadas: ${actualizados}`);
            } catch (e) {
                console.error('Error al marcar terminaciones finales desde períodos', e);
            }
        }

        async function migrarOcActividades() {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible para migrar OC');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();

                function parseFechaDdMmAaLocal(fechaTexto) {
                    if (!fechaTexto) return null;
                    const partes = fechaTexto.split('/');
                    if (partes.length !== 3) return null;
                    const dd = parseInt(partes[0], 10);
                    const mm = parseInt(partes[1], 10);
                    const aa = parseInt(partes[2], 10);
                    if (!dd || !mm || isNaN(aa)) return null;
                    const yyyy = 2000 + aa;
                    const d = new Date(yyyy, mm - 1, dd);
                    if (isNaN(d.getTime())) return null;
                    return d;
                }

                const colAct = collection(db, 'actividades');
                const snapAct = await getDocs(colAct);

                const actividades = snapAct.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
                if (!actividades.length) {
                    console.log('No hay actividades para migrar OC.');
                    return;
                }

                const porClave = new Map(); // clave = cliente||equipo||YY -> array de actividades
                actividades.forEach(act => {
                    const ini = (act.inicioServicio || '').toString();
                    const dIni = parseFechaDdMmAaLocal(ini);
                    if (!dIni) return;

                    const yy = String(dIni.getFullYear()).slice(-2);
                    const cli = (act.cliente || '').toString();
                    const eq = (act.equipo || '').toString();
                    if (!cli || !eq) return;

                    const clave = `${cli}||${eq}||${yy}`;

                    if (!porClave.has(clave)) porClave.set(clave, []);
                    porClave.get(clave).push(act);
                });

                let totalActualizadas = 0;

                for (const [clave, lista] of porClave.entries()) {
                    lista.sort((a, b) => {
                        const da = parseFechaDdMmAaLocal(a.inicioServicio || '') || new Date(2000, 0, 1);
                        const dbDate = parseFechaDdMmAaLocal(b.inicioServicio || '') || new Date(2000, 0, 1);
                        return da.getTime() - dbDate.getTime();
                    });

                    const partesClave = clave.split('||');
                    const yy = partesClave[2] || '';
                    const prefijo = `4301${yy}`;

                    let maxConsec = 0;
                    lista.forEach(act => {
                        const ocActual = (act.ordenSuministro || act.oc || '').toString().trim();
                        if (!ocActual.startsWith(prefijo)) return;
                        const sufijo = ocActual.slice(prefijo.length);
                        const num = parseInt(sufijo, 10);
                        if (!isNaN(num) && num > maxConsec) maxConsec = num;
                    });

                    let consec = maxConsec;
                    for (const act of lista) {
                        const ocActual = (act.ordenSuministro || act.oc || '').toString().trim();
                        if (ocActual) continue; // respetar OCs ya existentes, solo rellenar vacíos

                        consec += 1;
                        const consecutivo = String(consec).padStart(4, '0');
                        const nuevaOc = `${prefijo}${consecutivo}`;

                        await updateDoc(doc(db, 'actividades', act.id), { ordenSuministro: nuevaOc });
                        totalActualizadas += 1;
                    }
                }

                console.log(`Migración de OC completada. Actividades actualizadas: ${totalActualizadas}`);
            } catch (e) {
                console.error('Error al migrar OC en actividades', e);
            }
        }

        // Exponer funciones de migración en window para uso puntual desde consola
        window.migrarActividadesMultiEquipo = migrarActividadesMultiEquipo;
        window.marcarTerminacionesFinalesDesdePeriodos = marcarTerminacionesFinalesDesdePeriodos;
        window.marcarTerminacionesParcialesDesdePeriodos = marcarTerminacionesParcialesDesdePeriodos;
        window.migrarOsFormatoNuevo = migrarOsFormatoNuevo;
        window.migrarOcActividades = migrarOcActividades;
    });

    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } finally {
                window.location.href = 'login.html';
            }
        });
    }
    </script>

    <script src="nav.js"></script>
    <script src="utils.js"></script>

    <!-- Lógica de administración de actividades usando Firestore -->
    <script>
    (function() {
        let listaActividad = [];
        let filtroInicioServicio = '';
        let filtroEquipo = '';
        let filtroDescripcion = '';
        let filtroEstado = 'TODOS';
        // null = sin orden especial, 'asc' = más antiguo primero, 'desc' = más reciente primero
        let ordenInicioDir = null;
        // Orden por equipo / activo: null = sin orden, 'asc' / 'desc'
        let ordenEquipoDir = null;
        let ayudaActiva = false;

        function formatearMoneda(valor) {
            const n = Number(valor) || 0;
            return n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 });
        }

        // Convierte fecha en formato dd/mm/aa a objeto Date (año base 2000+aa)
        function parseFechaDdMmAa(fechaTexto) {
            if (!fechaTexto) return null;
            const partes = fechaTexto.split('/');
            if (partes.length !== 3) return null;
            const [ddStr, mmStr, aaStr] = partes;
            const dd = parseInt(ddStr, 10);
            const mm = parseInt(mmStr, 10);
            const aa = parseInt(aaStr, 10);
            if (!dd || !mm || isNaN(aa)) return null;
            const yyyy = 2000 + aa;
            const d = new Date(yyyy, mm - 1, dd);
            if (isNaN(d.getTime())) return null;
            return d;
        }

        // Autoformato para inputs dd/mm/aa (similar a pruebas)
        function formatearFechaDdMmAaInput(valor) {
            const soloDigitos = (valor || '').replace(/\D/g, '').slice(0, 6);
            let res = soloDigitos;
            if (soloDigitos.length >= 3 && soloDigitos.length <= 4) {
                res = soloDigitos.slice(0, 2) + '/' + soloDigitos.slice(2);
            } else if (soloDigitos.length >= 5) {
                res =
                    soloDigitos.slice(0, 2) +
                    '/' +
                    soloDigitos.slice(2, 4) +
                    '/' +
                    soloDigitos.slice(4);
            }
            return res;
        }

        async function cargarActividadDesdeFirestore() {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible en actividadmin');
                listaActividad = [];
                renderTabla();
                return;
            }

            try {
                const { getFirestore, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();
                const colRef = collection(db, 'actividades');
                const snap = await getDocs(colRef);
                listaActividad = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error al cargar actividades desde Firestore (admin)', e);
                listaActividad = [];
            }

            renderTabla();
        }

        async function actualizarActividadEnFirestore(id, cambios) {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible para actualizar');
                return;
            }

            try {
                const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();
                const ref = doc(db, 'actividades', id);
                await updateDoc(ref, cambios);
            } catch (e) {
                console.error('Error al actualizar actividad en Firestore', e);
            }
        }

        // MIGRACIÓN OPCIONAL: convertir documentos con `equipos` (array) en 1 doc por equipo
        // Uso: abrir consola en actividadmin.html y ejecutar: migrarActividadesMultiEquipo()
        async function migrarActividadesMultiEquipo() {
            if (!window.db) {
                console.warn('Firestore (window.db) no está disponible para migrar');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, addDoc, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();
                const colRef = collection(db, 'actividades');
                const snap = await getDocs(colRef);

                let migrados = 0;

                for (const d of snap.docs) {
                    const data = d.data() || {};
                    const equiposArr = Array.isArray(data.equipos) && data.equipos.length > 1
                        ? data.equipos
                        : null;

                    if (!equiposArr) continue; // nada que migrar

                    const {
                        equipos,
                        equipo,
                        ...resto
                    } = data;

                    for (const equipoNombre of equiposArr) {
                        const nuevo = {
                            ...resto,
                            equipo: equipoNombre,
                        };
                        await addDoc(colRef, nuevo);
                    }

                    await deleteDoc(doc(db, 'actividades', d.id));
                    migrados++;
                }

                console.log(`Migración completa. Documentos origen eliminados: ${migrados}`);
                await cargarActividadDesdeFirestore();
            } catch (e) {
                console.error('Error durante la migración de actividades multi-equipo', e);
            }
        }

        function renderTabla() {
            const tbody = document.getElementById('adm-tbody-actividad');
            const msgVacio = document.getElementById('adm-msg-vacio');
            const lblCont = document.getElementById('adm-contador');
            const inputBuscar = document.getElementById('adm-buscar');
            const spanIngresos = document.getElementById('adm-total-ingresos');
            const spanRentas = document.getElementById('adm-total-rentas');
            const spanTicket = document.getElementById('adm-ticket-promedio');

            if (!tbody) return;

            const listaBase = Array.isArray(listaActividad) ? listaActividad : [];
            let filtro = (inputBuscar?.value || '').toLowerCase().trim();

            tbody.innerHTML = '';

            if (!listaBase.length) {
                msgVacio.style.display = 'block';
                lblCont.textContent = '0 registros';
                spanIngresos.textContent = '$0';
                spanRentas.textContent = '$0';
                spanTicket.textContent = '$0';
                return;
            }

            msgVacio.style.display = 'none';

            let totalIngresos = 0;
            let totalRentas = 0;
            let sumaPrecios = 0;
            let cuentaPrecios = 0;
            let visibles = 0;

            // Aplicar filtros por inicio de servicio, equipo, descripción y estado
            const listaFiltrada = listaBase.filter(reg => {
                // Filtro por estado
                if (filtroEstado && filtroEstado !== 'TODOS') {
                    const finTxt = (reg.terminacionServicio || '').toString().trim();
                    let estado = 'ABIERTO';
                    if (finTxt) {
                        estado = reg.terminacionEsFinal ? 'FINAL' : 'PARCIAL';
                    }
                    if (estado !== filtroEstado) return false;
                }

                if (filtroInicioServicio) {
                    const ini = (reg.inicioServicio || '').toString();
                    if (!ini.startsWith(filtroInicioServicio)) return false;
                }

                if (filtroEquipo) {
                    const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                        ? reg.equipos
                        : (reg.equipo ? [reg.equipo] : []);
                    const matchEquipo = equiposArr.some(eq =>
                        (eq || '').toString().toLowerCase().includes(filtroEquipo)
                    );
                    if (!matchEquipo) return false;
                }

                if (filtroDescripcion) {
                    const descBase = (reg.descripcion || '').toString().toLowerCase();
                    const mapaDesc = (window.mapaDescripcionPorEquipoAdm || {});

                    let matchDesc = false;

                    if (descBase && descBase.includes(filtroDescripcion)) {
                        matchDesc = true;
                    } else {
                        const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                            ? reg.equipos
                            : (reg.equipo ? [reg.equipo] : []);
                        matchDesc = equiposArr.some(eq => {
                            const descInv = (mapaDesc[eq] || '').toString().toLowerCase();
                            return descInv.includes(filtroDescripcion);
                        });
                    }

                    if (!matchDesc) return false;
                }

                return true;
            });

            // Ordenar para agrupar visualmente, dando prioridad a actividades abiertas (sin terminación)
            const listaOrdenada = [...listaFiltrada].sort((a, b) => {
                const estadoPeso = (reg) => {
                    const fin = (reg.terminacionServicio || '').toString().trim();
                    if (!fin) return 0; // abierta
                    return reg.terminacionEsFinal ? 2 : 1; // parcial (1) / final (2)
                };

                const ea = estadoPeso(a);
                const eb = estadoPeso(b);
                if (ea !== eb) return ea - eb;

                const iniA = parseFechaDdMmAa(a.inicioServicio || '');
                const iniB = parseFechaDdMmAa(b.inicioServicio || '');
                const ta = iniA ? iniA.getTime() : 0;
                const tb = iniB ? iniB.getTime() : 0;

                if (ordenInicioDir === 'asc' && ta !== tb) {
                    return ta - tb;
                }
                if (ordenInicioDir === 'desc' && ta !== tb) {
                    return tb - ta;
                }

                if (ordenEquipoDir) {
                    const eqA = (a.equipo || (Array.isArray(a.equipos) && a.equipos.length ? a.equipos[0] : '') || '').toString().toUpperCase();
                    const eqB = (b.equipo || (Array.isArray(b.equipos) && b.equipos.length ? b.equipos[0] : '') || '').toString().toUpperCase();
                    if (eqA !== eqB) {
                        if (ordenEquipoDir === 'asc') return eqA < eqB ? -1 : 1;
                        return eqA > eqB ? -1 : 1;
                    }
                }

                const ca = (a.cliente || '').toString().toUpperCase();
                const cb = (b.cliente || '').toString().toUpperCase();
                if (ca < cb) return -1;
                if (ca > cb) return 1;
                const aa = (a.areaCliente || '').toString().toUpperCase();
                const ab = (b.areaCliente || '').toString().toUpperCase();
                if (aa < ab) return -1;
                if (aa > ab) return 1;
                const ua = (a.ubicacion || '').toString().toUpperCase();
                const ub = (b.ubicacion || '').toString().toUpperCase();
                if (ua < ub) return -1;
                if (ua > ub) return 1;
                return 0;
            });

            let clienteActual = '';
            let areaActual = '';
            let ubicacionActual = '';

            listaOrdenada.forEach((reg) => {
                const id = reg.id;
                const cliente = reg.cliente || '';
                const area = reg.areaCliente || '';
                const ubicacion = reg.ubicacion || '';
                // Inicio y terminación se guardan como texto dd/mm/aa
                const inicioTexto = reg.inicioServicio || '';
                const termTexto = reg.terminacionServicio || '';
                const os = reg.os || '';
                const oc = reg.ordenSuministro || '';
                const factura = reg.factura || '';
                const precio = Number(reg.precio || 0);
                const descripcionBase = reg.descripcion || '';

                const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                    ? reg.equipos
                    : (reg.equipo ? [reg.equipo] : []);

                const precioPorEquipo = equiposArr.length ? (precio / equiposArr.length) : precio;

                // Calcular días efectivos en servicio:
                // - Si hay terminación, días entre inicio y terminación (servicio cerrado).
                // - Si no hay terminación, días entre inicio y hoy (servicio abierto).
                let dias = 0;
                const dInicio = parseFechaDdMmAa(inicioTexto);
                const dFin = termTexto ? parseFechaDdMmAa(termTexto) : new Date();
                if (dInicio && dFin) {
                    const diffMs = dFin.getTime() - dInicio.getTime();
                    const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    if (diffDias >= 0) dias = diffDias; // si inicio es hoy, días = 0
                }

                const termInput = termTexto || '';

                equiposArr.forEach(equipoNombre => {
                    const mapaDesc = (window.mapaDescripcionPorEquipoAdm || {});
                    const descEfectiva = descripcionBase || mapaDesc[equipoNombre] || '';
                    const textoBuscar = `${cliente} ${area} ${ubicacion} ${equipoNombre} ${descEfectiva} ${os} ${factura}`.toLowerCase();
                    if (filtro && !textoBuscar.includes(filtro)) {
                        return;
                    }

                    visibles += 1;

                    const ingresoEquipo = precioPorEquipo * (dias || 0);
                    totalIngresos += ingresoEquipo;
                    totalRentas += ingresoEquipo;

                    if (precioPorEquipo > 0) {
                        sumaPrecios += precioPorEquipo;
                        cuentaPrecios += 1;
                    }

                    // Insertar encabezados de agrupación por cliente, área y ubicación cuando cambien
                    if (cliente && cliente !== clienteActual) {
                        clienteActual = cliente;
                        areaActual = '';
                        const trGrupoCliente = document.createElement('tr');
                        trGrupoCliente.innerHTML = `
                            <td colspan="14" style="padding:0.5rem 0.75rem; background:#111827; font-weight:700; font-size:0.9rem; color:#f9fafb; border-top:2px solid #0f172a; border-bottom:1px solid #0f172a; text-transform:uppercase; letter-spacing:0.03em;">
                                CLIENTE: ${clienteActual}
                            </td>
                        `;
                        tbody.appendChild(trGrupoCliente);
                    }

                    if (area && area !== areaActual) {
                        areaActual = area;
                        ubicacionActual = '';
                        const trGrupoArea = document.createElement('tr');
                        trGrupoArea.innerHTML = `
                            <td colspan="14" style="padding:0.4rem 0.75rem; background:#e5e7eb; font-weight:600; font-size:0.85rem; color:#111827; border-bottom:1px solid #cbd5e1; display:flex; align-items:center; gap:0.5rem; text-transform:uppercase; letter-spacing:0.02em;">
                                <input type="checkbox" class="adm-select-area" data-cliente="${cliente}" data-area="${areaActual}" title="Seleccionar área completa">
                                <span>Área: ${areaActual}</span>
                            </td>
                        `;
                        tbody.appendChild(trGrupoArea);
                    }

                    if (ubicacion && ubicacion !== ubicacionActual) {
                        ubicacionActual = ubicacion;
                        const trGrupoUbic = document.createElement('tr');
                        trGrupoUbic.innerHTML = `
                            <td colspan="14" style="padding:0.3rem 0.9rem; background:#f9fafb; font-weight:500; font-size:0.8rem; color:#4b5563; border-bottom:1px solid #e5e7eb; border-left:4px solid #9ca3af; display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" class="adm-select-ubic" data-cliente="${cliente}" data-area="${areaActual}" data-ubicacion="${ubicacionActual}" title="Seleccionar ubicación completa">
                                <span>Ubicación: ${ubicacionActual}</span>
                            </td>
                        `;
                        tbody.appendChild(trGrupoUbic);
                    }

                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:center;">
                            <input type="checkbox" class="adm-select-fila" data-id="${id}" data-cliente="${cliente}" data-area="${area}" data-ubicacion="${ubicacion}">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${cliente}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${area}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${ubicacion}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left;">
                            ${equipoNombre}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left; max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${descEfectiva}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <input type="text" class="adm-input-inicio" data-id="${id}" value="${inicioTexto}" placeholder="dd/mm/aa" maxlength="8" style="font-size:0.8rem; width:80px;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <input type="text" class="adm-input-term" data-id="${id}" value="${termInput}" placeholder="dd/mm/aa" maxlength="8" style="font-size:0.8rem; width:80px;">
                            ${(() => {
                                const finTxt = termTexto.trim();
                                if (!finTxt) {
                                    // ABIERTO: sin fecha de terminación, color naranja (alerta)
                                    return '<span style="margin-left:0.35rem; font-size:0.7rem; font-weight:600; color:#ea580c;">ABIERTO</span>';
                                }
                                const esFinal = reg.terminacionEsFinal;
                                // FINAL en rojo, PARCIAL en verde
                                const color = esFinal ? '#b91c1c' : '#16a34a';
                                const label = esFinal ? 'FINAL' : 'PARCIAL';
                                return `<span style="margin-left:0.35rem; font-size:0.7rem; font-weight:600; color:${color};">${label}</span>`;
                            })()}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left;">
                            ${dias || ''}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <input type="number" min="0" step="1" class="adm-input-precio" data-id="${id}"
                                   value="${precio || ''}" style="width:80px; font-size:0.8rem;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:right;">
                            ${ingresoEquipo ? formatearMoneda(ingresoEquipo) : ''}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left;">${os}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <input type="text" class="adm-input-oc" data-id="${id}" value="${oc || ''}" style="font-size:0.8rem; width:110px;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left;">${factura}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <button type="button" class="adm-btn-eliminar" data-id="${id}" style="font-size:0.75rem; color:#b91c1c;">
                                Eliminar
                            </button>
                        </td>
                    `;

                    // Guardar datos necesarios para el tabulador en el <tr>, para abrirlo al hacer clic en la fila
                    tr.setAttribute('data-id', id);
                    tr.setAttribute('data-cliente', cliente);
                    tr.setAttribute('data-area', area);
                    tr.setAttribute('data-ubicacion', ubicacion);
                    tr.setAttribute('data-equipo', equipoNombre);
                    tr.setAttribute('data-precioequipo', String(precioPorEquipo));
                    tr.setAttribute('data-os', os);
                    tr.setAttribute('data-inicio', inicioTexto);
                    tr.setAttribute('data-terminacion', termTexto);

                    tbody.appendChild(tr);
                });
            });

            lblCont.textContent = `${visibles} registro${visibles === 1 ? '' : 's'}`;
            spanIngresos.textContent = formatearMoneda(totalIngresos);
            spanRentas.textContent = formatearMoneda(totalRentas);
            spanTicket.textContent = cuentaPrecios ? formatearMoneda(sumaPrecios / cuentaPrecios) : '$0';

            // Autoformato dd/mm/aa y guardado automático en los inputs de inicio y terminación

            // INICIO DEL SERVICIO
            tbody.querySelectorAll('.adm-input-inicio').forEach(input => {
                input.addEventListener('input', () => {
                    const formateada = formatearFechaDdMmAaInput(input.value);
                    input.value = formateada;
                });

                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    if (!valor) {
                        // No permitimos dejar inicio en blanco; restaurar valor previo
                        input.value = regLocal.inicioServicio || '';
                        return;
                    }

                    const d = parseFechaDdMmAa(valor);
                    if (!d) {
                        alert('Formato de fecha de inicio inválido. Usa dd/mm/aa');
                        input.value = regLocal.inicioServicio || '';
                        return;
                    }

                    regLocal.inicioServicio = valor;
                    await actualizarActividadEnFirestore(id, { inicioServicio: valor });
                    renderTabla();
                });
            });

            // TERMINACIÓN DEL SERVICIO
            tbody.querySelectorAll('.adm-input-term').forEach(input => {
                input.addEventListener('input', () => {
                    const formateada = formatearFechaDdMmAaInput(input.value);
                    input.value = formateada;
                });

                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    if (!valor) {
                        // Quitar terminación
                        delete regLocal.terminacionServicio;
                        delete regLocal.terminacionEsFinal;
                        await actualizarActividadEnFirestore(id, { terminacionServicio: '', terminacionEsFinal: false });
                        renderTabla();
                        return;
                    }

                    const d = parseFechaDdMmAa(valor);
                    if (!d) {
                        alert('Formato de fecha inválido. Usa dd/mm/aa');
                        // restaurar valor previo si lo hubiera
                        input.value = regLocal.terminacionServicio || '';
                        return;
                    }

                    regLocal.terminacionServicio = valor;
                    // Editar desde esta vista se considera, por defecto, un fin PARCIAL (no definitivo)
                    regLocal.terminacionEsFinal = false;
                    await actualizarActividadEnFirestore(id, { terminacionServicio: valor, terminacionEsFinal: false });
                    renderTabla();
                });
            });

            // Guardado automático en blur para precio
            tbody.querySelectorAll('.adm-input-precio').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valorNum = Number(input.value || 0);
                    if (isNaN(valorNum) || valorNum < 0) {
                        alert('Indica un precio válido.');
                        const regLocalPrev = listaActividad.find(r => r.id === id);
                        input.value = regLocalPrev && typeof regLocalPrev.precio === 'number' ? regLocalPrev.precio : '';
                        return;
                    }

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.precio = valorNum;
                    await actualizarActividadEnFirestore(id, { precio: valorNum });
                    renderTabla();
                });
            });

            // Guardado automático en blur para OC (orden de compra / suministro) a nivel de actividad
            tbody.querySelectorAll('.adm-input-oc').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.ordenSuministro = valor;
                    await actualizarActividadEnFirestore(id, { ordenSuministro: valor });
                });
            });

            tbody.querySelectorAll('.adm-btn-eliminar').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (!id) return;

                    if (!confirm('¿Eliminar esta actividad? Esta acción no se puede deshacer.')) return;

                    try {
                        const { getFirestore, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                        const db = getFirestore();
                        const ref = doc(db, 'actividades', id);
                        await deleteDoc(ref);

                        listaActividad = listaActividad.filter(r => r.id !== id);
                        renderTabla();
                    } catch (e) {
                        console.error('Error al eliminar actividad en Firestore', e);
                    }
                });
            });
            // Lógica de selección múltiple (checkbox maestro y por área)
            const chkTodos = document.getElementById('adm-select-todos');
            if (chkTodos) {
                chkTodos.checked = false;
                chkTodos.addEventListener('change', () => {
                    const filas = tbody.querySelectorAll('.adm-select-fila');
                    filas.forEach(chk => {
                        chk.checked = chkTodos.checked;
                    });

                    // Sincronizar checkboxes de área
                    const areas = tbody.querySelectorAll('.adm-select-area');
                    areas.forEach(chkArea => {
                        chkArea.checked = chkTodos.checked;
                    });
                });
            }

            // Lógica de selección por área
            tbody.querySelectorAll('.adm-select-area').forEach(chkArea => {
                chkArea.addEventListener('change', () => {
                    const area = chkArea.getAttribute('data-area') || '';
                    const cliente = chkArea.getAttribute('data-cliente') || '';

                    const filasArea = tbody.querySelectorAll(`.adm-select-fila[data-area="${area}"][data-cliente="${cliente}"]`);
                    filasArea.forEach(chkFila => {
                        chkFila.checked = chkArea.checked;
                    });

                    // Actualizar estado del checkbox maestro
                    const todasFilas = tbody.querySelectorAll('.adm-select-fila');
                    const todasMarcadas = todasFilas.length > 0 && Array.from(todasFilas).every(chk => chk.checked);
                    if (chkTodos) {
                        chkTodos.checked = todasMarcadas;
                    }
                });
            });

            // Lógica de selección por ubicación
            tbody.querySelectorAll('.adm-select-ubic').forEach(chkUbic => {
                chkUbic.addEventListener('change', () => {
                    const ubic = chkUbic.getAttribute('data-ubicacion') || '';
                    const area = chkUbic.getAttribute('data-area') || '';
                    const cliente = chkUbic.getAttribute('data-cliente') || '';

                    // Marcar / desmarcar todas las filas de esa ubicación dentro del cliente/área
                    const filasUbic = tbody.querySelectorAll(
                        `.adm-select-fila[data-cliente="${cliente}"][data-area="${area}"][data-ubicacion="${ubic}"]`
                    );
                    filasUbic.forEach(chkFila => {
                        chkFila.checked = chkUbic.checked;
                    });

                    // Sincronizar checkbox de área: marcada si todas las filas del área están marcadas
                    const filasArea = tbody.querySelectorAll(
                        `.adm-select-fila[data-cliente="${cliente}"][data-area="${area}"]`
                    );
                    const todasAreaMarcadas =
                        filasArea.length > 0 && Array.from(filasArea).every(chk => chk.checked);

                    const chkArea = tbody.querySelector(
                        `.adm-select-area[data-cliente="${cliente}"][data-area="${area}"]`
                    );
                    if (chkArea) {
                        chkArea.checked = todasAreaMarcadas;
                    }

                    // Actualizar estado del checkbox maestro
                    const todasFilas = tbody.querySelectorAll('.adm-select-fila');
                    const todasMarcadas =
                        todasFilas.length > 0 && Array.from(todasFilas).every(chk => chk.checked);
                    if (chkTodos) {
                        chkTodos.checked = todasMarcadas;
                    }
                });
            });

            // Botones de edición en lote
            const btnFechaLote = document.getElementById('adm-aplicar-fecha-lote');
            const inputFechaLote = document.getElementById('adm-lote-fecha');
            const btnPrecioLote = document.getElementById('adm-aplicar-precio-lote');
            const inputPrecioLote = document.getElementById('adm-lote-precio');

            if (inputFechaLote) {
                inputFechaLote.addEventListener('input', () => {
                    const f = formatearFechaDdMmAaInput(inputFechaLote.value);
                    inputFechaLote.value = f;
                });
            }

            if (btnFechaLote && inputFechaLote) {
                btnFechaLote.addEventListener('click', async () => {
                    const valor = (inputFechaLote.value || '').trim();
                    if (!valor) {
                        alert('Indica una fecha en formato dd/mm/aa para aplicar en lote.');
                        return;
                    }

                    const d = parseFechaDdMmAa(valor);
                    if (!d) {
                        alert('Formato de fecha inválido. Usa dd/mm/aa');
                        return;
                    }

                    const seleccionados = Array.from(tbody.querySelectorAll('.adm-select-fila:checked'));
                    if (!seleccionados.length) {
                        alert('Selecciona al menos un registro para aplicar la fecha.');
                        return;
                    }

                    for (const chk of seleccionados) {
                        const id = chk.getAttribute('data-id');
                        if (!id) continue;

                        const inputTerm = tbody.querySelector(`.adm-input-term[data-id="${id}"]`);
                        if (inputTerm) {
                            inputTerm.value = valor;
                        }

                        const regLocal = listaActividad.find(r => r.id === id);
                        if (!regLocal) continue;

                        regLocal.terminacionServicio = valor;
                        await actualizarActividadEnFirestore(id, { terminacionServicio: valor });
                    }

                    renderTabla();
                });
            }

            if (btnPrecioLote && inputPrecioLote) {
                btnPrecioLote.addEventListener('click', async () => {
                    const valor = Number(inputPrecioLote.value || 0);
                    if (!valor || valor < 0) {
                        alert('Indica un precio válido para aplicar en lote.');
                        return;
                    }

                    const seleccionados = Array.from(tbody.querySelectorAll('.adm-select-fila:checked'));
                    if (!seleccionados.length) {
                        alert('Selecciona al menos un registro para aplicar el precio.');
                        return;
                    }

                    for (const chk of seleccionados) {
                        const id = chk.getAttribute('data-id');
                        if (!id) continue;

                        const inputPrecio = tbody.querySelector(`.adm-input-precio[data-id="${id}"]`);
                        if (inputPrecio) {
                            inputPrecio.value = valor;
                        }

                        const regLocal = listaActividad.find(r => r.id === id);
                        if (!regLocal) continue;

                        regLocal.precio = valor;
                        await actualizarActividadEnFirestore(id, { precio: valor });
                    }

                    renderTabla();
                });
            }

            const inputFiltroInicio = document.getElementById('adm-filtro-inicio');
            if (inputFiltroInicio) {
                inputFiltroInicio.addEventListener('input', () => {
                    const soloDigitos = (inputFiltroInicio.value || '').replace(/\D/g, '').slice(0, 6);
                    let formateado = soloDigitos;
                    if (soloDigitos.length >= 3 && soloDigitos.length <= 4) {
                        formateado = soloDigitos.slice(0, 2) + '/' + soloDigitos.slice(2);
                    } else if (soloDigitos.length >= 5) {
                        formateado =
                            soloDigitos.slice(0, 2) +
                            '/' +
                            soloDigitos.slice(2, 4) +
                            '/' +
                            soloDigitos.slice(4);
                    }
                    inputFiltroInicio.value = formateado;
                    filtroInicioServicio = formateado.trim();
                    renderTabla();
                });
            }

            const inputFiltroEquipo = document.getElementById('adm-filtro-equipo');
            if (inputFiltroEquipo) {
                inputFiltroEquipo.addEventListener('input', () => {
                    filtroEquipo = (inputFiltroEquipo.value || '').toLowerCase().trim();
                    renderTabla();
                });
            }

            const inputFiltroDescripcion = document.getElementById('adm-filtro-descripcion');
            if (inputFiltroDescripcion) {
                inputFiltroDescripcion.addEventListener('input', () => {
                    filtroDescripcion = (inputFiltroDescripcion.value || '').toLowerCase().trim();
                    renderTabla();
                });
            }

            const thInicio = document.getElementById('adm-th-inicio');
            if (thInicio) {
                thInicio.addEventListener('click', () => {
                    // Al ordenar por inicio, limpiar orden por equipo
                    ordenEquipoDir = null;
                    if (ordenInicioDir === 'asc') {
                        ordenInicioDir = 'desc';
                    } else if (ordenInicioDir === 'desc') {
                        ordenInicioDir = null; // sin orden especial, volver a agrupación base
                    } else {
                        ordenInicioDir = 'asc';
                    }
                    renderTabla();
                });
            }

            const thEquipo = document.getElementById('adm-th-equipo');
            if (thEquipo) {
                thEquipo.addEventListener('click', () => {
                    // Al ordenar por equipo, limpiar orden por inicio
                    ordenInicioDir = null;
                    if (ordenEquipoDir === 'asc') {
                        ordenEquipoDir = 'desc';
                    } else if (ordenEquipoDir === 'desc') {
                        ordenEquipoDir = null;
                    } else {
                        ordenEquipoDir = 'asc';
                    }
                    renderTabla();
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputBuscar = document.getElementById('adm-buscar');
            if (inputBuscar) {
                inputBuscar.addEventListener('input', () => {
                    renderTabla();
                });
            }

            const btnAyuda = document.getElementById('adm-btn-ayuda');
            const panelAyuda = document.getElementById('adm-ayuda-panel');
            if (btnAyuda && panelAyuda) {
                btnAyuda.addEventListener('click', () => {
                    ayudaActiva = !ayudaActiva;
                    panelAyuda.style.display = ayudaActiva ? 'block' : 'none';
                    btnAyuda.textContent = ayudaActiva ? 'Ocultar ayuda' : 'Ver ayuda';
                });
            }

            cargarActividadDesdeFirestore();
            // Exponer función de migración sólo para admins (uso desde consola)
            window.migrarActividadesMultiEquipo = migrarActividadesMultiEquipo;
        });
    })();
    </script>

    <!-- script.js para navbar, menús, etc. -->
    <script src="script.js"></script>
    <!-- Lógica de tabulador de períodos -->
    <script src="tabulador.js"></script>
</body>
</html>