<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazabilidades de equipos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir menú">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="#" class="active">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administración</a></li>
                        <li><a href="trazabilidades.html" class="nav-admin-only">Trazabilidades</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspección</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main class="actividad-page" style="max-width: 1200px; margin: 1rem auto;">
        <!-- Filtros de búsqueda para equipos -->
        <section style="margin-bottom: 0.75rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; justify-content:space-between;">
            <div style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                <input type="search" id="trz-buscar-equipo" placeholder="Buscar equipo / activo" style="min-width: 260px;">
                <input type="search" id="trz-buscar-cliente" placeholder="Buscar cliente" style="min-width: 220px;">
            </div>
            <div style="font-size: 0.85rem; color:#4b5563;">
                <span id="trz-contador-equipos">0 equipos</span>
            </div>
        </section>

        <!-- Layout: lista de equipos a la izquierda, trazabilidad a la derecha -->
        <section style="display:grid; grid-template-columns: minmax(260px, 340px) minmax(0, 1fr); gap:1rem; align-items:flex-start;">

            <!-- Lista de equipos con historial / historial OS -->
            <div style="border:1px solid #e5e7eb; border-radius:0.5rem; overflow:hidden; background:white;">
                <div style="padding:0.5rem 0.75rem; background:#f9fafb; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; gap:0.5rem; flex-wrap:wrap;">
                    <div>
                        <h2 id="trz-lista-titulo" style="margin:0; font-size:0.95rem; font-weight:600; color:#111827;">Equipos con historial</h2>
                        <p id="trz-lista-subtitulo" style="margin:0.15rem 0 0; font-size:0.8rem; color:#6b7280;">
                            Selecciona un equipo para ver su trazabilidad.
                        </p>
                    </div>
                    <div style="display:flex; gap:0.25rem; font-size:0.75rem; flex-wrap:wrap; align-items:center;">
                        <button id="trz-modo-equipo" type="button" style="padding:0.2rem 0.5rem; border-radius:0.25rem; border:1px solid #3b82f6; background:#3b82f6; color:white;">Por equipo</button>
                        <button id="trz-modo-os" type="button" style="padding:0.2rem 0.5rem; border-radius:0.25rem; border:1px solid #d1d5db; background:white; color:#374151;">Por OS</button>
                        <button id="trz-modo-cliente" type="button" style="padding:0.2rem 0.5rem; border-radius:0.25rem; border:1px solid #d1d5db; background:white; color:#374151;">Por cliente</button>
                        <button id="trz-modo-ubicacion" type="button" style="padding:0.2rem 0.5rem; border-radius:0.25rem; border:1px solid #d1d5db; background:white; color:#374151;">Por ubicación</button>
                        <button id="trz-modo-oc" type="button" style="padding:0.2rem 0.5rem; border-radius:0.25rem; border:1px solid #d1d5db; background:white; color:#374151;">Por OC</button>
                        <span style="width:1px; height:18px; background:#e5e7eb; margin:0 4px;"></span>
                        <button id="trz-btn-migrar-os" type="button" class="nav-admin-only" title="Unificar OS por cliente+ubicación (continuidad)" style="padding:0.2rem 0.5rem; border-radius:0.25rem; border:1px solid #d1d5db; background:#fff; color:#374151; display:none;">Migrar OS por ubicación</button>
                    </div>
                </div>
                <div style="max-height:65vh; overflow:auto;" id="trz-lista-equipos-wrapper">
                    <ul id="trz-lista-equipos" style="list-style:none; margin:0; padding:0; font-size:0.9rem;"></ul>
                    <p id="trz-msg-sin-equipos" style="display:none; padding:0.75rem; font-size:0.85rem; color:#6b7280;">
                        No se encontraron equipos con historial.
                    </p>
                </div>
            </div>

            <!-- Detalle de trazabilidad -->
            <div style="border:1px solid #e5e7eb; border-radius:0.5rem; overflow:hidden; background:white; min-height:220px;">
                <div style="padding:0.5rem 0.75rem; background:#f9fafb; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; gap:0.5rem; flex-wrap:wrap;">
                    <div>
                        <h2 id="trz-titulo-detalle" style="margin:0; font-size:0.95rem; font-weight:600; color:#111827;">Trazabilidad del equipo</h2>
                        <p id="trz-header-equipo" style="margin:0.15rem 0 0; font-size:0.8rem; color:#6b7280;">
                            Selecciona un equipo de la lista.
                        </p>
                    </div>
                    <div style="text-align:right; font-size:0.8rem; color:#4b5563;">
                        <div><span id="trz-resumen-ubicaciones">0 ubicaciones</span></div>
                        <div><span id="trz-resumen-periodo">Sin rango de fechas</span></div>
                    </div>
                </div>

                <div class="tabla-inspecciones-wrapper" style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.85rem; min-width:820px;">
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th style="padding:0.35rem; text-align:left;">Cliente</th>
                                <th style="padding:0.35rem; text-align:left;">Área</th>
                                <th style="padding:0.35rem; text-align:left;">Ubicación</th>
                                <th style="padding:0.35rem; text-align:left;">Equipo</th>
                                <th id="trz-th-inicio" style="padding:0.35rem; text-align:left; cursor:pointer;">Inicio servicio</th>
                                <th style="padding:0.35rem; text-align:left;">Fin servicio</th>
                                <th style="padding:0.35rem; text-align:right;">Días</th>
                                <th style="padding:0.35rem; text-align:left;">OS</th>
                                <th style="padding:0.35rem; text-align:left;">OC</th>
                                <th style="padding:0.35rem; text-align:left;">Factura</th>
                            </tr>
                        </thead>
                        <tbody id="trz-tbody"></tbody>
                    </table>
                </div>

                <p id="trz-msg-sin-traza" style="display:none; padding:0.75rem; font-size:0.85rem; color:#6b7280;">
                    No hay registros de trazabilidad para este equipo.
                </p>
            </div>
        </section>
    </main>

    <!-- Firebase + lógica de trazabilidad (por períodos) -->
    <script src="config.local.js"></script>
    <script type="module" src="firebase-init.js"></script>
    <script type="module">
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const db = window.db;
    const auth = window.auth;

    // Acceso por Custom Claims (Firebase): admin o director

    const emailSpan = document.getElementById('nav-user-email');
    const btnLogout = document.getElementById('btn-logout');

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        // Migración: unificar OS por cliente+ubicación con sesiones continuas
        window.migrarOsPorUbicacion = async function(lista) {
            const { getFirestore, doc, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
            const dbLocal = getFirestore();

            const up = (s) => (s || '').toString().trim().toUpperCase();
            const grupos = new Map(); // key = cliente||ubicacion -> actividades[]
            (Array.isArray(lista) ? lista : []).forEach(a => {
                const cli = up(a.cliente);
                const ubi = up(a.ubicacion);
                if (!cli || !ubi) return;
                const key = `${cli}||${ubi}`;
                if (!grupos.has(key)) grupos.set(key, []);
                grupos.get(key).push(a);
            });

            let cambios = 0;
            const pendientes = [];

            grupos.forEach((acts) => {
                // Construir eventos (+1 inicio, -1 fin+1 día) para detectar sesiones continuas
                const eventos = [];
                const registros = [];
                acts.forEach(a => {
                    const di = parseFechaDdMmAa(a.inicioServicio || '');
                    if (!di) return;
                    const df = parseFechaDdMmAa(a.terminacionServicio || '');
                    registros.push({ a, di, df });
                    eventos.push({ t: di.getTime(), d: +1 });
                    if (df) {
                        const dfp = new Date(df.getTime());
                        dfp.setDate(dfp.getDate() + 1);
                        eventos.push({ t: dfp.getTime(), d: -1 });
                    }
                });
                if (!eventos.length) return;

                eventos.sort((x, y) => (x.t - y.t) || (x.d - y.d));
                let c = 0, inicioMs = null;
                const sesiones = [];
                eventos.forEach(ev => {
                    const prev = c;
                    c += ev.d;
                    if (prev === 0 && c > 0) {
                        inicioMs = ev.t;
                    } else if (prev > 0 && c === 0 && inicioMs != null) {
                        sesiones.push({ inicioMs, finMs: ev.t });
                        inicioMs = null;
                    }
                });
                if (c > 0 && inicioMs != null) {
                    // sesión abierta hasta hoy+1
                    const hoy = new Date(); hoy.setHours(0,0,0,0);
                    const dfp = new Date(hoy.getTime()); dfp.setDate(dfp.getDate()+1);
                    sesiones.push({ inicioMs, finMs: dfp.getTime() });
                }

                // Determinar máximo consecutivo existente en el grupo
                let maxConsec = 0;
                acts.forEach(a => {
                    const os = (a.os || '').toString().trim();
                    const m = os.match(/^PCT-\d{2}-(\d{3})$/);
                    if (m) { const n = parseInt(m[1], 10); if (!isNaN(n) && n > maxConsec) maxConsec = n; }
                });

                sesiones.sort((a, b) => a.inicioMs - b.inicioMs);
                const osPorSesion = sesiones.map((s, idx) => {
                    const yy = new Date(s.inicioMs).getFullYear() % 100;
                    const consec = String(maxConsec + idx + 1).padStart(3, '0');
                    return { ...s, os: `PCT-${String(yy).padStart(2,'0')}-${consec}` };
                });

                // Calcular updates
                registros.forEach(({ a, di }) => {
                    const ses = osPorSesion.find(s => di.getTime() >= s.inicioMs && di.getTime() < s.finMs);
                    if (!ses) return;
                    const nuevaOs = ses.os;
                    const actual = (a.os || '').toString().trim();
                    if (nuevaOs && nuevaOs !== actual) {
                        pendientes.push({ id: a.id, os: nuevaOs, osPrev: actual });
                    }
                });
            });

            if (!pendientes.length) return { cambios: 0 };

            // Aplicar en batches
            let batch = writeBatch(dbLocal);
            let count = 0;
            for (const u of pendientes) {
                const ref = doc(dbLocal, 'actividades', u.id);
                batch.update(ref, { osPrev: u.osPrev || '', os: u.os });
                count++;
                cambios++;
                if (count % 400 === 0) { await batch.commit(); batch = writeBatch(dbLocal); }
            }
            await batch.commit();

            return { cambios };
        }

        const email = (user.email || '').toLowerCase();
        if (emailSpan) emailSpan.textContent = email;

        // Resolver rol desde Custom Claims
        let role = null;
        try {
            const tok = await user.getIdTokenResult(true);
            role = tok?.claims?.role || null;
        } catch {}
        const esAdmin = (role === 'admin');
        const esDirector = (role === 'director');
        window.isAdmin = esAdmin;
        window.isDirector = esDirector;
        if (!(esAdmin || esDirector)) {
            window.location.href = 'inspeccion.html';
            return;
        }

        inicializarTrazabilidades();
    });

    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } finally {
                window.location.href = 'login.html';
            }
        });
    }

    function parseFechaDdMmAa(fechaTexto) {
        if (!fechaTexto) return null;
        const partes = fechaTexto.split('/');
        if (partes.length !== 3) return null;
        const [ddStr, mmStr, aaStr] = partes;
        const dd = parseInt(ddStr, 10);
        const mm = parseInt(mmStr, 10);
        const aa = parseInt(aaStr, 10);
        if (!dd || !mm || isNaN(aa)) return null;
        const yyyy = 2000 + aa;
        const d = new Date(yyyy, mm - 1, dd);
        if (isNaN(d.getTime())) return null;
        return d;
    }

    function calcularDiasEntre(inicioStr, finStr) {
        const di = parseFechaDdMmAa(inicioStr);
        const df = parseFechaDdMmAa(finStr);
        if (!di || !df) return '';
        const ms = df.getTime() - di.getTime();
        if (!isFinite(ms) || ms < 0) return '';
        return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    async function inicializarTrazabilidades() {
        const inputBuscarEquipo   = document.getElementById('trz-buscar-equipo');
        const inputBuscarCliente  = document.getElementById('trz-buscar-cliente');
        const ulEquipos           = document.getElementById('trz-lista-equipos');
        const msgSinEquipos       = document.getElementById('trz-msg-sin-equipos');
        const lblContadorEquipos  = document.getElementById('trz-contador-equipos');
        const thInicio            = document.getElementById('trz-th-inicio');
        const btnModoEquipo       = document.getElementById('trz-modo-equipo');
        const btnModoOs           = document.getElementById('trz-modo-os');
        const btnModoCliente      = document.getElementById('trz-modo-cliente');
        const btnModoUbicacion    = document.getElementById('trz-modo-ubicacion');
        const btnModoOc           = document.getElementById('trz-modo-oc');
        const btnMigrarOs         = document.getElementById('trz-btn-migrar-os');
        const tituloLista         = document.getElementById('trz-lista-titulo');
        const subtituloLista      = document.getElementById('trz-lista-subtitulo');

        // Separar errores: Firestore vs DOM
        if (!window.db) {
            console.warn('Firestore (window.db) no está disponible en trazabilidades');
            return;
        }
        if (!ulEquipos) {
            console.warn('Elementos de UI de trazabilidades no encontrados en el DOM');
            return;
        }

        let listaActividades = [];
        let equiposAgrupados = [];
        let osAgrupadas = [];
        let clientesAgrupados = [];
        let ubicacionesAgrupadas = [];
        let ocAgrupadas = [];
        let equipoSeleccionado = null;
        let osSeleccionada = null;
        let clienteSeleccionado = null;
        let ubicacionSeleccionada = null;
        let ocSeleccionada = null;
        let periodosPorActividad = new Map(); // actividadId -> [periodos]
        let osPorActividad = new Map(); // actividadId -> OS calculada
        let ocPorPeriodo = new Map(); // periodoId -> OC calculada
        let sortDirInicio = 'asc'; // 'asc' o 'desc'
        let modoListado = 'equipo'; // 'equipo' | 'os' | 'cliente' | 'ubicacion' | 'oc'

        async function cargarActividades() {
            try {
                const { getFirestore, collection, getDocs } =
                    await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                const dbLocal = getFirestore();

                // Actividades
                const colAct = collection(dbLocal, 'actividades');
                const snapAct = await getDocs(colAct);
                listaActividades = snapAct.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));

                // Períodos de facturación / servicio
                const colPer = collection(dbLocal, 'actividadPeriodos');
                const snapPer = await getDocs(colPer);
                periodosPorActividad = new Map();
                snapPer.docs.forEach(d => {
                    const p = { id: d.id, ...(d.data() || {}) };
                    const actId = p.actividadId;
                    if (!actId) return;
                    if (!periodosPorActividad.has(actId)) {
                        periodosPorActividad.set(actId, []);
                    }
                    periodosPorActividad.get(actId).push(p);
                });
                // Calcular OCs automáticas por PERÍODO (cliente+equipo+año de inicioPeriodo)
                generarOcPorPeriodo();

                // Calcular OS globales por actividad, agrupando por cliente+ubicacion+anio(inicioServicio)
                osPorActividad = new Map();
                const grupos = new Map(); // clave = cliente||UBICACION||YY -> [actividad]

                listaActividades.forEach(act => {
                    const cli = (act.cliente || '').toString();
                    const ubi = (act.ubicacion || '').toString();
                    const dIni = parseFechaDdMmAa((act.inicioServicio || '').toString());
                    if (!cli || !ubi || !dIni || isNaN(dIni.getTime())) return;
                    const yy = String(dIni.getFullYear()).slice(-2);
                    const clave = `${cli}||${ubi}||${yy}`;
                    if (!grupos.has(clave)) grupos.set(clave, []);
                    grupos.get(clave).push({ act, fecha: dIni });
                });

                grupos.forEach((arr) => {
                    arr.sort((a, b) => a.fecha.getTime() - b.fecha.getTime());
                    const yy = String(arr[0].fecha.getFullYear()).slice(-2);
                    let seq = 0;
                    arr.forEach(item => {
                        seq += 1;
                        const consecutivo = String(seq).padStart(3, '0');
                        const os = `PCT-${yy}-${consecutivo}`;
                        osPorActividad.set(item.act.id, os);
                    });
                });

            } catch (e) {
                console.error('Error al cargar actividades/periodos para trazabilidades', e);
                listaActividades = [];
                periodosPorActividad = new Map();
                osPorActividad = new Map();
            }

            agruparEquipos();
            agruparOs();
            agruparClientes();
            agruparUbicaciones();
            agruparOc();
            renderListaPrincipal();

            // Mostrar botón de migración (admin/director) y enlazar acción
            try {
                if (btnMigrarOs && (window.isAdmin || window.isDirector)) {
                    btnMigrarOs.style.display = 'inline-flex';
                    btnMigrarOs.onclick = async () => {
                        const totalActs = Array.isArray(listaActividades) ? listaActividades.length : 0;
                        const ok = confirm(`Unificar OS por cliente+ubicación según sesiones continuas. Se evaluarán ${totalActs} actividades. ¿Continuar?`);
                        if (!ok) return;
                        try {
                            const res = await migrarOsPorUbicacion(listaActividades);
                            alert(`Migración completada. Cambios aplicados: ${res.cambios}.`);
                            await cargarActividades();
                        } catch (e) {
                            console.error('Fallo migración OS', e);
                            alert('No se pudo completar la migración. Revisa la consola.');
                        }
                    };
                }
            } catch {}
        }

        function agruparEquipos() {
            const mapa = new Map();

            listaActividades.forEach(act => {
                const equiposArr = Array.isArray(act.equipos) && act.equipos.length
                    ? act.equipos
                    : (act.equipo ? [act.equipo] : []);

                equiposArr.forEach(eq => {
                    const nombreEq = (eq || '').toString().trim();
                    if (!nombreEq) return;

                    const key = nombreEq.toUpperCase();
                    if (!mapa.has(key)) {
                        mapa.set(key, {
                            nombre: nombreEq,
                            actividades: [],
                        });
                    }
                    mapa.get(key).actividades.push(act);
                });
            });

            equiposAgrupados = Array.from(mapa.values())
                .filter(grp => grp.actividades && grp.actividades.length)
                .map(grp => {
                    const clientes = new Set();
                    grp.actividades.forEach(a => {
                        if (a.cliente) clientes.add((a.cliente || '').toString());
                    });

                    let minFecha = null;
                    let maxFecha = null;

                    grp.actividades.forEach(a => {
                        const di = parseFechaDdMmAa(a.inicioServicio || '');
                        if (di && (!minFecha || di < minFecha)) minFecha = di;
                        const df = parseFechaDdMmAa(a.terminacionServicio || '');
                        if (df && (!maxFecha || df > maxFecha)) maxFecha = df;
                    });

                    return {
                        ...grp,
                        clientes: Array.from(clientes),
                        fechaInicioMin: minFecha,
                        fechaFinMax: maxFecha,
                    };
                })
                .sort((a, b) =>
                    a.nombre.toUpperCase() < b.nombre.toUpperCase() ? -1 : 1
                );
        }

        function agruparClientes() {
            const mapa = new Map(); // cliente (UPPER) -> grupo

            listaActividades.forEach(act => {
                const cliRaw = (act.cliente || '').toString().trim();
                if (!cliRaw) return;
                const cliKey = cliRaw.toUpperCase();

                if (!mapa.has(cliKey)) {
                    mapa.set(cliKey, {
                        cliente: cliKey, // mostrar en mayúsculas para consistencia
                        actividades: [],
                    });
                }
                mapa.get(cliKey).actividades.push(act);
            });

            clientesAgrupados = Array.from(mapa.values()).map(grp => {
                const equipos = new Set();
                let minFecha = null;
                let maxFecha = null;

                grp.actividades.forEach(a => {
                    const eq = (a.equipo || '').toString();
                    if (eq) equipos.add(eq);

                    const di = parseFechaDdMmAa(a.inicioServicio || '');
                    if (di && (!minFecha || di < minFecha)) minFecha = di;
                    const df = parseFechaDdMmAa(a.terminacionServicio || '');
                    if (df && (!maxFecha || df > maxFecha)) maxFecha = df;
                });

                return {
                    ...grp,
                    equipos: Array.from(equipos),
                    fechaInicioMin: minFecha,
                    fechaFinMax: maxFecha,
                };
            }).sort((a, b) => a.cliente.toUpperCase() < b.cliente.toUpperCase() ? -1 : 1);
        }

        function agruparUbicaciones() {
            const mapa = new Map(); // clave = cliente||ubicacion

            listaActividades.forEach(act => {
                const cli = (act.cliente || '').toString().trim();
                const ubi = (act.ubicacion || '').toString().trim();
                if (!cli || !ubi) return;

                const clave = `${cli}||${ubi}`;
                if (!mapa.has(clave)) {
                    mapa.set(clave, {
                        cliente: cli,
                        ubicacion: ubi,
                        actividades: [],
                    });
                }
                mapa.get(clave).actividades.push(act);
            });

            ubicacionesAgrupadas = Array.from(mapa.values()).map(grp => {
                const equipos = new Set();
                let minFecha = null;
                let maxFecha = null;

                grp.actividades.forEach(a => {
                    const eq = (a.equipo || '').toString();
                    if (eq) equipos.add(eq);

                    const di = parseFechaDdMmAa(a.inicioServicio || '');
                    if (di && (!minFecha || di < minFecha)) minFecha = di;
                    const df = parseFechaDdMmAa(a.terminacionServicio || '');
                    if (df && (!maxFecha || df > maxFecha)) maxFecha = df;
                });

                return {
                    ...grp,
                    equipos: Array.from(equipos),
                    fechaInicioMin: minFecha,
                    fechaFinMax: maxFecha,
                };
            }).sort((a, b) => {
                const ca = a.cliente.toUpperCase();
                const cb = b.cliente.toUpperCase();
                if (ca < cb) return -1;
                if (ca > cb) return 1;
                const ua = a.ubicacion.toUpperCase();
                const ub = b.ubicacion.toUpperCase();
                if (ua < ub) return -1;
                if (ua > ub) return 1;
                return 0;
            });
        }

        function agruparOc() {
            const mapa = new Map(); // clave = OC -> grupo

            // Tomar OCs desde periodos si existen, si no desde ordenSuministro en actividad
            periodosPorActividad.forEach((arrPeriodos, actId) => {
                const act = listaActividades.find(a => a.id === actId);
                if (!act) return;

                arrPeriodos.forEach(p => {
                    const oc = (ocPorPeriodo.get(p.id) || p.oc || '').toString().trim();
                    if (!oc) return;

                    if (!mapa.has(oc)) {
                        mapa.set(oc, {
                            oc,
                            actividades: [],
                            clientes: new Set(),
                            equipos: new Set(),
                            fechaInicioMin: null,
                            fechaFinMax: null,
                        });
                    }
                    const g = mapa.get(oc);
                    g.actividades.push(act);
                    const cli = (act.cliente || '').toString();
                    const eq = (act.equipo || '').toString();
                    if (cli) g.clientes.add(cli);
                    if (eq) g.equipos.add(eq);

                    const di = parseFechaDdMmAa((act.inicioServicio || '').toString());
                    const df = parseFechaDdMmAa((act.terminacionServicio || '').toString());
                    if (di && (!g.fechaInicioMin || di < g.fechaInicioMin)) g.fechaInicioMin = di;
                    if (df && (!g.fechaFinMax || df > g.fechaFinMax)) g.fechaFinMax = df;
                });
            });

            // También considerar OCs directamente en actividades sin periodos
            listaActividades.forEach(act => {
                const tienePeriodos = periodosPorActividad.get(act.id)?.length;
                if (tienePeriodos) return;
                const oc = (act.ordenSuministro || act.oc || '').toString().trim();
                if (!oc) return;

                if (!mapa.has(oc)) {
                    mapa.set(oc, {
                        oc,
                        actividades: [],
                        clientes: new Set(),
                        equipos: new Set(),
                        fechaInicioMin: null,
                        fechaFinMax: null,
                    });
                }
                const g = mapa.get(oc);
                g.actividades.push(act);
                const cli = (act.cliente || '').toString();
                const eq = (act.equipo || '').toString();
                if (cli) g.clientes.add(cli);
                if (eq) g.equipos.add(eq);

                const di = parseFechaDdMmAa((act.inicioServicio || '').toString());
                const df = parseFechaDdMmAa((act.terminacionServicio || '').toString());
                if (di && (!g.fechaInicioMin || di < g.fechaInicioMin)) g.fechaInicioMin = di;
                if (df && (!g.fechaFinMax || df > g.fechaFinMax)) g.fechaFinMax = df;
            });

            ocAgrupadas = Array.from(mapa.values()).map(g => ({
                oc: g.oc,
                actividades: g.actividades,
                clientes: Array.from(g.clientes),
                equipos: Array.from(g.equipos),
                fechaInicioMin: g.fechaInicioMin,
                fechaFinMax: g.fechaFinMax,
            })).sort((a, b) => a.oc < b.oc ? -1 : (a.oc > b.oc ? 1 : 0));
        }

        // Genera una OC numérica por período: cliente+equipo+año(inicioPeriodo)
        // Formato: 4301YYNNNN, donde YY = año, NNNN = consecutivo dentro del grupo.
        function generarOcPorPeriodo() {
            ocPorPeriodo = new Map();

            if (!listaActividades.length || !periodosPorActividad.size) return;

            const actividadesPorId = new Map();
            listaActividades.forEach(a => actividadesPorId.set(a.id, a));

            const grupos = new Map(); // clave = cliente||equipo||YY -> [ { periodo, fecha } ]

            periodosPorActividad.forEach((arrPeriodos, actId) => {
                const act = actividadesPorId.get(actId);
                if (!act) return;

                const cliente = (act.cliente || '').toString();
                const equipo  = (act.equipo || '').toString();
                if (!cliente || !equipo) return;

                arrPeriodos.forEach(p => {
                    const inicioTxt = (p.inicioPeriodo || act.inicioServicio || '').toString();
                    const dIni = parseFechaDdMmAa(inicioTxt);
                    if (!dIni || isNaN(dIni.getTime())) return;

                    const yy = String(dIni.getFullYear()).slice(-2);
                    const clave = `${cliente}||${equipo}||${yy}`;
                    if (!grupos.has(clave)) grupos.set(clave, []);
                    grupos.get(clave).push({ periodo: p, fecha: dIni });
                });
            });

            grupos.forEach(arr => {
                arr.sort((a, b) => a.fecha.getTime() - b.fecha.getTime());
                if (!arr.length) return;

                const yy = String(arr[0].fecha.getFullYear()).slice(-2);
                let seq = 0;
                arr.forEach(item => {
                    seq += 1;
                    const consecutivo = String(seq).padStart(4, '0');
                    const oc = `4301${yy}${consecutivo}`;
                    if (item.periodo && item.periodo.id) {
                        ocPorPeriodo.set(item.periodo.id, oc);
                    }
                });
            });
        }

        function formatearFechaCorta(d) {
            if (!d || !(d instanceof Date) || isNaN(d.getTime())) return '';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const aa = String(d.getFullYear()).slice(-2);
            return `${dd}/${mm}/${aa}`;
        }

        function renderListaPrincipal() {
            const filtroEq  = (inputBuscarEquipo?.value || '').toLowerCase().trim();
            const filtroCli = (inputBuscarCliente?.value || '').toLowerCase().trim();

            ulEquipos.innerHTML = '';

            // Helper para resetear estilos de botones
            const activarBoton = (activo, botones) => {
                const activeStyle = {
                    background: '#3b82f6',
                    color: '#ffffff',
                    borderColor: '#3b82f6',
                };
                const inactiveStyle = {
                    background: '#ffffff',
                    color: '#374151',
                    borderColor: '#d1d5db',
                };
                botones.forEach(btn => {
                    if (!btn) return;
                    const isActive = btn === activo;
                    btn.style.background = isActive ? activeStyle.background : inactiveStyle.background;
                    btn.style.color = isActive ? activeStyle.color : inactiveStyle.color;
                    btn.style.borderColor = isActive ? activeStyle.borderColor : inactiveStyle.borderColor;
                });
            };

            if (modoListado === 'equipo') {
                // Texto y estilos de título
                if (tituloLista) tituloLista.textContent = 'Equipos con historial';
                if (subtituloLista) subtituloLista.textContent = 'Selecciona un equipo para ver su trazabilidad.';
                activarBoton(btnModoEquipo, [btnModoEquipo, btnModoOs, btnModoCliente, btnModoUbicacion, btnModoOc]);

                let lista = equiposAgrupados.filter(grp => {
                    if (filtroEq && !grp.nombre.toLowerCase().includes(filtroEq)) return false;
                    if (filtroCli) {
                        const clientesTxt = (grp.clientes || []).join(' ').toLowerCase();
                        if (!clientesTxt.includes(filtroCli)) return false;
                    }
                    return true;
                });

                if (!lista.length) {
                    msgSinEquipos.style.display = 'block';
                    if (lblContadorEquipos) lblContadorEquipos.textContent = '0 equipos';
                    return;
                }

                msgSinEquipos.style.display = 'none';
                if (lblContadorEquipos)
                    lblContadorEquipos.textContent =
                        `${lista.length} equipo${lista.length === 1 ? '' : 's'}`;

                lista.forEach(grp => {
                    const li = document.createElement('li');
                    li.style.borderBottom = '1px solid #e5e7eb';
                    li.style.cursor = 'pointer';
                    li.style.padding = '0.45rem 0.75rem';
                    li.dataset.equipo = grp.nombre;

                    li.addEventListener('click', () => {
                        equipoSeleccionado = grp.nombre;
                        osSeleccionada = null;
                        Array.from(ulEquipos.children).forEach(el => {
                            el.style.background = '';
                        });
                        li.style.background = '#eff6ff';
                        renderTrazabilidad();
                    });

                    const titulo = document.createElement('div');
                    titulo.textContent = grp.nombre;
                    titulo.style.fontWeight = '600';
                    titulo.style.color = '#111827';
                    titulo.style.fontSize = '0.9rem';

                    const sub = document.createElement('div');
                    sub.style.marginTop = '0.1rem';
                    sub.style.fontSize = '0.78rem';
                    sub.style.color = '#6b7280';

                    const clientesTxt = (grp.clientes || []).join(' · ');
                    const fechaIni = formatearFechaCorta(grp.fechaInicioMin);
                    const fechaFin = formatearFechaCorta(grp.fechaFinMax);

                    sub.textContent =
                        `${grp.actividades.length} registro${grp.actividades.length === 1 ? '' : 's'}`
                        + (clientesTxt ? ` | ${clientesTxt}` : '')
                        + ((fechaIni || fechaFin) ? ` | ${fechaIni || '??'} - ${fechaFin || '??'}` : '');

                    li.appendChild(titulo);
                    li.appendChild(sub);

                    ulEquipos.appendChild(li);
                });
            } else if (modoListado === 'os') {
                // Modo OS
                if (tituloLista) tituloLista.textContent = 'Historial de OS';
                if (subtituloLista) subtituloLista.textContent = 'Selecciona una OS para ver su trazabilidad.';
                activarBoton(btnModoOs, [btnModoEquipo, btnModoOs, btnModoCliente, btnModoUbicacion, btnModoOc]);

                let lista = osAgrupadas.filter(grp => {
                    if (filtroEq && !grp.os.toLowerCase().includes(filtroEq)) return false;
                    if (filtroCli) {
                        const clientesTxt = (grp.clientes || []).join(' ').toLowerCase();
                        if (!clientesTxt.includes(filtroCli)) return false;
                    }
                    return true;
                });

                if (!lista.length) {
                    msgSinEquipos.style.display = 'block';
                    if (lblContadorEquipos) lblContadorEquipos.textContent = '0 OS';
                    return;
                }

                msgSinEquipos.style.display = 'none';
                if (lblContadorEquipos)
                    lblContadorEquipos.textContent = `${lista.length} OS`;

                lista.forEach(grp => {
                    const li = document.createElement('li');
                    li.style.borderBottom = '1px solid #e5e7eb';
                    li.style.cursor = 'pointer';
                    li.style.padding = '0.45rem 0.75rem';
                    li.dataset.os = grp.os;

                    li.addEventListener('click', () => {
                        osSeleccionada = grp.os;
                        equipoSeleccionado = null;
                        Array.from(ulEquipos.children).forEach(el => {
                            el.style.background = '';
                        });
                        li.style.background = '#eff6ff';
                        renderTrazabilidad();
                    });

                    const titulo = document.createElement('div');
                    titulo.textContent = grp.os;
                    titulo.style.fontWeight = '600';
                    titulo.style.color = '#111827';
                    titulo.style.fontSize = '0.9rem';

                    const sub = document.createElement('div');
                    sub.style.marginTop = '0.1rem';
                    sub.style.fontSize = '0.78rem';
                    sub.style.color = '#6b7280';

                    const clientesTxt = (grp.clientes || []).join(' · ');
                    const equiposTxt = (grp.equipos || []).join(' · ');
                    const fechaIni = formatearFechaCorta(grp.fechaInicioMin);
                    const fechaFin = formatearFechaCorta(grp.fechaFinMax);

                    sub.textContent =
                        `${grp.actividades.length} registro${grp.actividades.length === 1 ? '' : 's'}`
                        + (clientesTxt ? ` | ${clientesTxt}` : '')
                        + (equiposTxt ? ` | ${equiposTxt}` : '')
                        + ((fechaIni || fechaFin) ? ` | ${fechaIni || '??'} - ${fechaFin || '??'}` : '');

                    li.appendChild(titulo);
                    li.appendChild(sub);

                    ulEquipos.appendChild(li);
                });
            } else if (modoListado === 'cliente') {
                if (tituloLista) tituloLista.textContent = 'Clientes con historial';
                if (subtituloLista) subtituloLista.textContent = 'Selecciona un cliente para ver su trazabilidad.';
                activarBoton(btnModoCliente, [btnModoEquipo, btnModoOs, btnModoCliente, btnModoUbicacion, btnModoOc]);

                let lista = clientesAgrupados.filter(grp => {
                    if (filtroEq && !grp.cliente.toLowerCase().includes(filtroEq)) return false;
                    if (filtroCli && !grp.cliente.toLowerCase().includes(filtroCli)) return false;
                    return true;
                });

                if (!lista.length) {
                    msgSinEquipos.style.display = 'block';
                    if (lblContadorEquipos) lblContadorEquipos.textContent = '0 clientes';
                    return;
                }

                msgSinEquipos.style.display = 'none';
                if (lblContadorEquipos)
                    lblContadorEquipos.textContent = `${lista.length} cliente${lista.length === 1 ? '' : 's'}`;

                lista.forEach(grp => {
                    const li = document.createElement('li');
                    li.style.borderBottom = '1px solid #e5e7eb';
                    li.style.cursor = 'pointer';
                    li.style.padding = '0.45rem 0.75rem';
                    li.dataset.cliente = grp.cliente;

                    li.addEventListener('click', () => {
                        clienteSeleccionado = grp.cliente;
                        equipoSeleccionado = null;
                        osSeleccionada = null;
                        ubicacionSeleccionada = null;
                        ocSeleccionada = null;
                        Array.from(ulEquipos.children).forEach(el => { el.style.background = ''; });
                        li.style.background = '#eff6ff';
                        renderTrazabilidad();
                    });

                    const titulo = document.createElement('div');
                    titulo.textContent = grp.cliente;
                    titulo.style.fontWeight = '600';
                    titulo.style.color = '#111827';
                    titulo.style.fontSize = '0.9rem';

                    const sub = document.createElement('div');
                    sub.style.marginTop = '0.1rem';
                    sub.style.fontSize = '0.78rem';
                    sub.style.color = '#6b7280';

                    const equiposTxt = (grp.equipos || []).join(' · ');
                    const fechaIni = formatearFechaCorta(grp.fechaInicioMin);
                    const fechaFin = formatearFechaCorta(grp.fechaFinMax);

                    sub.textContent =
                        `${grp.actividades.length} registro${grp.actividades.length === 1 ? '' : 's'}`
                        + (equiposTxt ? ` | ${equiposTxt}` : '')
                        + ((fechaIni || fechaFin) ? ` | ${fechaIni || '??'} - ${fechaFin || '??'}` : '');

                    li.appendChild(titulo);
                    li.appendChild(sub);
                    ulEquipos.appendChild(li);
                });
            } else if (modoListado === 'ubicacion') {
                if (tituloLista) tituloLista.textContent = 'Ubicaciones con historial';
                if (subtituloLista) subtituloLista.textContent = 'Selecciona una ubicación para ver su trazabilidad.';
                activarBoton(btnModoUbicacion, [btnModoEquipo, btnModoOs, btnModoCliente, btnModoUbicacion, btnModoOc]);

                let lista = ubicacionesAgrupadas.filter(grp => {
                    const clave = `${grp.cliente} ${grp.ubicacion}`.toLowerCase();
                    if (filtroEq && !clave.includes(filtroEq)) return false;
                    if (filtroCli && !clave.includes(filtroCli)) return false;
                    return true;
                });

                if (!lista.length) {
                    msgSinEquipos.style.display = 'block';
                    if (lblContadorEquipos) lblContadorEquipos.textContent = '0 ubicaciones';
                    return;
                }

                msgSinEquipos.style.display = 'none';
                if (lblContadorEquipos)
                    lblContadorEquipos.textContent = `${lista.length} ubicación${lista.length === 1 ? '' : 'es'}`;

                lista.forEach(grp => {
                    const li = document.createElement('li');
                    li.style.borderBottom = '1px solid #e5e7eb';
                    li.style.cursor = 'pointer';
                    li.style.padding = '0.45rem 0.75rem';
                    li.dataset.cliente = grp.cliente;
                    li.dataset.ubicacion = grp.ubicacion;

                    li.addEventListener('click', () => {
                        clienteSeleccionado = grp.cliente;
                        ubicacionSeleccionada = grp.ubicacion;
                        equipoSeleccionado = null;
                        osSeleccionada = null;
                        ocSeleccionada = null;
                        Array.from(ulEquipos.children).forEach(el => { el.style.background = ''; });
                        li.style.background = '#eff6ff';
                        renderTrazabilidad();
                    });

                    const titulo = document.createElement('div');
                    titulo.textContent = `${grp.cliente} / ${grp.ubicacion}`;
                    titulo.style.fontWeight = '600';
                    titulo.style.color = '#111827';
                    titulo.style.fontSize = '0.9rem';

                    const sub = document.createElement('div');
                    sub.style.marginTop = '0.1rem';
                    sub.style.fontSize = '0.78rem';
                    sub.style.color = '#6b7280';

                    const equiposTxt = (grp.equipos || []).join(' · ');
                    const fechaIni = formatearFechaCorta(grp.fechaInicioMin);
                    const fechaFin = formatearFechaCorta(grp.fechaFinMax);

                    sub.textContent =
                        `${grp.actividades.length} registro${grp.actividades.length === 1 ? '' : 's'}`
                        + (equiposTxt ? ` | ${equiposTxt}` : '')
                        + ((fechaIni || fechaFin) ? ` | ${fechaIni || '??'} - ${fechaFin || '??'}` : '');

                    li.appendChild(titulo);
                    li.appendChild(sub);
                    ulEquipos.appendChild(li);
                });
            } else if (modoListado === 'oc') {
                if (tituloLista) tituloLista.textContent = 'Historial de OC';
                if (subtituloLista) subtituloLista.textContent = 'Selecciona una OC para ver su trazabilidad.';
                activarBoton(btnModoOc, [btnModoEquipo, btnModoOs, btnModoCliente, btnModoUbicacion, btnModoOc]);

                let lista = ocAgrupadas.filter(grp => {
                    const clave = `${grp.oc} ${(grp.clientes || []).join(' ')} ${(grp.equipos || []).join(' ')}`.toLowerCase();
                    if (filtroEq && !clave.includes(filtroEq)) return false;
                    if (filtroCli && !clave.includes(filtroCli)) return false;
                    return true;
                });

                if (!lista.length) {
                    msgSinEquipos.style.display = 'block';
                    if (lblContadorEquipos) lblContadorEquipos.textContent = '0 OC';
                    return;
                }

                msgSinEquipos.style.display = 'none';
                if (lblContadorEquipos)
                    lblContadorEquipos.textContent = `${lista.length} OC`;

                lista.forEach(grp => {
                    const li = document.createElement('li');
                    li.style.borderBottom = '1px solid #e5e7eb';
                    li.style.cursor = 'pointer';
                    li.style.padding = '0.45rem 0.75rem';
                    li.dataset.oc = grp.oc;

                    li.addEventListener('click', () => {
                        ocSeleccionada = grp.oc;
                        equipoSeleccionado = null;
                        osSeleccionada = null;
                        clienteSeleccionado = null;
                        ubicacionSeleccionada = null;
                        Array.from(ulEquipos.children).forEach(el => { el.style.background = ''; });
                        li.style.background = '#eff6ff';
                        renderTrazabilidad();
                    });

                    const titulo = document.createElement('div');
                    titulo.textContent = grp.oc;
                    titulo.style.fontWeight = '600';
                    titulo.style.color = '#111827';
                    titulo.style.fontSize = '0.9rem';

                    const sub = document.createElement('div');
                    sub.style.marginTop = '0.1rem';
                    sub.style.fontSize = '0.78rem';
                    sub.style.color = '#6b7280';

                    const clientesTxt = (grp.clientes || []).join(' · ');
                    const equiposTxt = (grp.equipos || []).join(' · ');
                    const fechaIni = formatearFechaCorta(grp.fechaInicioMin);
                    const fechaFin = formatearFechaCorta(grp.fechaFinMax);

                    sub.textContent =
                        `${grp.actividades.length} registro${grp.actividades.length === 1 ? '' : 's'}`
                        + (clientesTxt ? ` | ${clientesTxt}` : '')
                        + (equiposTxt ? ` | ${equiposTxt}` : '')
                        + ((fechaIni || fechaFin) ? ` | ${fechaIni || '??'} - ${fechaFin || '??'}` : '');

                    li.appendChild(titulo);
                    li.appendChild(sub);
                    ulEquipos.appendChild(li);
                });
            }
        }

        function agruparOs() {
            const mapa = new Map(); // clave = OS -> grupo

            listaActividades.forEach(act => {
                const os = osPorActividad.get(act.id) || (act.os || '').toString();
                if (!os) return;

                const cli = (act.cliente || '').toString();
                const equipo = (act.equipo || '').toString();

                if (!mapa.has(os)) {
                    mapa.set(os, {
                        os,
                        actividades: [],
                        clientes: new Set(),
                        equipos: new Set(),
                        fechaInicioMin: null,
                        fechaFinMax: null,
                    });
                }
                const g = mapa.get(os);
                g.actividades.push(act);
                if (cli) g.clientes.add(cli);
                if (equipo) g.equipos.add(equipo);

                const di = parseFechaDdMmAa((act.inicioServicio || '').toString());
                const df = parseFechaDdMmAa((act.terminacionServicio || '').toString());
                if (di && (!g.fechaInicioMin || di < g.fechaInicioMin)) g.fechaInicioMin = di;
                if (df && (!g.fechaFinMax || df > g.fechaFinMax)) g.fechaFinMax = df;
            });

            osAgrupadas = Array.from(mapa.values())
                .map(g => ({
                    os: g.os,
                    actividades: g.actividades,
                    clientes: Array.from(g.clientes),
                    equipos: Array.from(g.equipos),
                    fechaInicioMin: g.fechaInicioMin,
                    fechaFinMax: g.fechaFinMax,
                }))
                .sort((a, b) => a.os < b.os ? -1 : (a.os > b.os ? 1 : 0));
        }

        function renderTrazabilidad() {
            const tbody          = document.getElementById('trz-tbody');
            const msgSinTraza    = document.getElementById('trz-msg-sin-traza');
            const headerEquipo   = document.getElementById('trz-header-equipo');
            const tituloDetalle  = document.getElementById('trz-titulo-detalle');
            const lblUbicaciones = document.getElementById('trz-resumen-ubicaciones');
            const lblPeriodo     = document.getElementById('trz-resumen-periodo');

            if (!tbody) return;

            tbody.innerHTML = '';
            msgSinTraza.style.display = 'none';

            // Determinar fuente de actividades según modo
            let actividadesFuente = [];
            if (modoListado === 'equipo') {
                if (tituloDetalle) tituloDetalle.textContent = 'Trazabilidad del equipo';

                if (!equipoSeleccionado) {
                    if (headerEquipo) headerEquipo.textContent = 'Selecciona un equipo de la lista.';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                actividadesFuente = listaActividades.filter(act => {
                    const equiposArr = Array.isArray(act.equipos) && act.equipos.length
                        ? act.equipos
                        : (act.equipo ? [act.equipo] : []);
                    return equiposArr.some(eq =>
                        (eq || '').toString().trim().toUpperCase() ===
                        equipoSeleccionado.trim().toUpperCase()
                    );
                });

                if (!actividadesFuente.length) {
                    if (headerEquipo)
                        headerEquipo.textContent = `Sin registros para el equipo: ${equipoSeleccionado}`;
                    msgSinTraza.style.display = 'block';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                if (headerEquipo)
                    headerEquipo.textContent = `Equipo: ${equipoSeleccionado}`;
            } else if (modoListado === 'os') {
                if (tituloDetalle) tituloDetalle.textContent = 'Trazabilidad por OS';

                if (!osSeleccionada) {
                    if (headerEquipo) headerEquipo.textContent = 'Selecciona una OS de la lista.';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                actividadesFuente = listaActividades.filter(act => {
                    const osCalc = osPorActividad.get(act.id) || (act.os || '').toString();
                    return osCalc === osSeleccionada;
                });

                if (!actividadesFuente.length) {
                    if (headerEquipo)
                        headerEquipo.textContent = `Sin registros para la OS: ${osSeleccionada}`;
                    msgSinTraza.style.display = 'block';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                if (headerEquipo)
                    headerEquipo.textContent = `OS: ${osSeleccionada}`;
            } else if (modoListado === 'cliente') {
                if (tituloDetalle) tituloDetalle.textContent = 'Trazabilidad del cliente';

                if (!clienteSeleccionado) {
                    if (headerEquipo) headerEquipo.textContent = 'Selecciona un cliente de la lista.';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                actividadesFuente = listaActividades.filter(act =>
                    (act.cliente || '').toString().trim().toUpperCase() ===
                    clienteSeleccionado.trim().toUpperCase()
                );

                if (!actividadesFuente.length) {
                    if (headerEquipo)
                        headerEquipo.textContent = `Sin registros para el cliente: ${clienteSeleccionado}`;
                    msgSinTraza.style.display = 'block';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                if (headerEquipo)
                    headerEquipo.textContent = `Cliente: ${clienteSeleccionado}`;
            } else if (modoListado === 'ubicacion') {
                if (tituloDetalle) tituloDetalle.textContent = 'Trazabilidad por ubicación';

                if (!clienteSeleccionado || !ubicacionSeleccionada) {
                    if (headerEquipo) headerEquipo.textContent = 'Selecciona una ubicación de la lista.';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                actividadesFuente = listaActividades.filter(act =>
                    (act.cliente || '').toString().trim().toUpperCase() === clienteSeleccionado.trim().toUpperCase() &&
                    (act.ubicacion || '').toString().trim().toUpperCase() === ubicacionSeleccionada.trim().toUpperCase()
                );

                if (!actividadesFuente.length) {
                    if (headerEquipo)
                        headerEquipo.textContent = `Sin registros para ${clienteSeleccionado} / ${ubicacionSeleccionada}`;
                    msgSinTraza.style.display = 'block';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                if (headerEquipo)
                    headerEquipo.textContent = `Cliente: ${clienteSeleccionado} / Ubicación: ${ubicacionSeleccionada}`;
            } else if (modoListado === 'oc') {
                if (tituloDetalle) tituloDetalle.textContent = 'Trazabilidad por OC';

                if (!ocSeleccionada) {
                    if (headerEquipo) headerEquipo.textContent = 'Selecciona una OC de la lista.';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                // Reutilizar actividades cuyo periodo o actividad tenga esa OC
                actividadesFuente = listaActividades.filter(act => {
                    const arrPeriodos = periodosPorActividad.get(act.id) || [];
                    const tieneOcPeriodo = arrPeriodos.some(p => {
                        const ocCalc = (ocPorPeriodo.get(p.id) || p.oc || '').toString().trim();
                        return ocCalc === ocSeleccionada;
                    });
                    if (tieneOcPeriodo) return true;
                    const ocAct = (act.ordenSuministro || act.oc || '').toString().trim();
                    return ocAct === ocSeleccionada;
                });

                if (!actividadesFuente.length) {
                    if (headerEquipo)
                        headerEquipo.textContent = `Sin registros para la OC: ${ocSeleccionada}`;
                    msgSinTraza.style.display = 'block';
                    if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                    if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                    return;
                }

                if (headerEquipo)
                    headerEquipo.textContent = `OC: ${ocSeleccionada}`;
            }

            const ordenadas = [...actividadesFuente].sort((a, b) => {
                const di = parseFechaDdMmAa(a.inicioServicio || '');
                const dj = parseFechaDdMmAa(b.inicioServicio || '');
                const ta = di ? di.getTime() : 0;
                const tb = dj ? dj.getTime() : 0;
                return ta - tb;
            });

            const ubicacionesSet = new Set();
            let minFecha = null;
            let maxFecha = null;

            // Construir filas por PERÍODO (si existen), o por actividad en su defecto
            const filas = [];

            ordenadas.forEach(act => {
                const actPeriodos = periodosPorActividad.get(act.id) || [];

                if (actPeriodos.length) {
                    actPeriodos.forEach(p => {
                        const iniTxt = (p.inicioPeriodo || act.inicioServicio || '').toString();
                        const finTxt = (p.finPeriodo || act.terminacionServicio || '').toString();

                        const ocCalc = ocPorPeriodo.get(p.id) || (p.oc || act.ordenSuministro || act.oc || '').toString();

                        filas.push({
                            cliente: (act.cliente || '').toString(),
                            area: (act.areaCliente || '').toString(),
                            ubicacion: (act.ubicacion || '').toString(),
                            equipo: (act.equipo || '').toString(),
                            inicio: iniTxt,
                            fin: finTxt,
                            dias: calcularDiasEntre(iniTxt, finTxt),
                            os: osPorActividad.get(act.id) || (act.os || '').toString(),
                            oc: ocCalc,
                            factura: (p.factura || act.factura || '').toString(),
                        });
                    });
                } else {
                    const iniTxt = (act.inicioServicio || '').toString();
                    const finTxt = (act.terminacionServicio || '').toString();

                    filas.push({
                        cliente: (act.cliente || '').toString(),
                        area: (act.areaCliente || '').toString(),
                        ubicacion: (act.ubicacion || '').toString(),
                        equipo: (act.equipo || '').toString(),
                        inicio: iniTxt,
                        fin: finTxt,
                        dias: calcularDiasEntre(iniTxt, finTxt),
                        os: osPorActividad.get(act.id) || (act.os || '').toString(),
                        oc: (act.ordenSuministro || act.oc || '').toString(),
                        factura: (act.factura || '').toString(),
                    });
                }
            });

            // Ordenar filas por fecha de inicio según sortDirInicio
            filas.sort((a, b) => {
                const da = parseFechaDdMmAa(a.inicio || '');
                const db = parseFechaDdMmAa(b.inicio || '');
                const ta = da && !isNaN(da.getTime()) ? da.getTime() : 0;
                const tb = db && !isNaN(db.getTime()) ? db.getTime() : 0;
                return sortDirInicio === 'asc' ? ta - tb : tb - ta;
            });

            if (!filas.length) {
                msgSinTraza.style.display = 'block';
                if (lblUbicaciones) lblUbicaciones.textContent = '0 ubicaciones';
                if (lblPeriodo) lblPeriodo.textContent = 'Sin rango de fechas';
                return;
            }

            filas.forEach(f => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';

                const cCliente = document.createElement('td');
                cCliente.style.padding = '0.3rem 0.4rem';
                cCliente.textContent = f.cliente;

                const cArea = document.createElement('td');
                cArea.style.padding = '0.3rem 0.4rem';
                cArea.textContent = f.area;

                const cUbic = document.createElement('td');
                cUbic.style.padding = '0.3rem 0.4rem';
                cUbic.textContent = f.ubicacion;
                if (f.ubicacion) ubicacionesSet.add(f.ubicacion);

                const cEq = document.createElement('td');
                cEq.style.padding = '0.3rem 0.4rem';
                cEq.textContent = f.equipo || '';

                const cIni = document.createElement('td');
                cIni.style.padding = '0.3rem 0.4rem';
                cIni.textContent = f.inicio;

                const cFin = document.createElement('td');
                cFin.style.padding = '0.3rem 0.4rem';
                cFin.textContent = f.fin || '';

                const cDias = document.createElement('td');
                cDias.style.padding = '0.3rem 0.4rem';
                cDias.style.textAlign = 'right';
                cDias.textContent = f.dias === '' ? '' : f.dias;

                const cOs = document.createElement('td');
                cOs.style.padding = '0.3rem 0.4rem';
                cOs.textContent = f.os;

                const cOc = document.createElement('td');
                cOc.style.padding = '0.3rem 0.4rem';
                cOc.textContent = f.oc;

                const cFac = document.createElement('td');
                cFac.style.padding = '0.3rem 0.4rem';
                cFac.textContent = f.factura;

                tr.appendChild(cCliente);
                tr.appendChild(cArea);
                tr.appendChild(cUbic);
                tr.appendChild(cEq);
                tr.appendChild(cIni);
                tr.appendChild(cFin);
                tr.appendChild(cDias);
                tr.appendChild(cOs);
                tr.appendChild(cOc);
                tr.appendChild(cFac);

                tbody.appendChild(tr);

                const di = parseFechaDdMmAa(f.inicio);
                const df = parseFechaDdMmAa(f.fin);
                if (di && (!minFecha || di < minFecha)) minFecha = di;
                if (df && (!maxFecha || df > maxFecha)) maxFecha = df;
            });

            if (lblUbicaciones) {
                const numUbi = ubicacionesSet.size;
                lblUbicaciones.textContent =
                    `${numUbi} ubicacion${numUbi === 1 ? '' : 'es'}`;
            }

            if (lblPeriodo) {
                const ini = formatearFechaCorta(minFecha);
                const fin = formatearFechaCorta(maxFecha);
                if (ini || fin) {
                    lblPeriodo.textContent = `${ini || '??'} - ${fin || '??'}`;
                } else {
                    lblPeriodo.textContent = 'Sin rango de fechas';
                }
            }

            msgSinTraza.style.display = filas.length ? 'none' : 'block';
        }

        inputBuscarEquipo?.addEventListener('input', () => {
            renderListaPrincipal();
        });

        inputBuscarCliente?.addEventListener('input', () => {
            renderListaPrincipal();
        });

        // Cambiar modo de listado por equipo / por OS / cliente / ubicacion / OC
        btnModoEquipo?.addEventListener('click', () => {
            if (modoListado === 'equipo') return;
            modoListado = 'equipo';
            equipoSeleccionado = null;
            osSeleccionada = null;
            clienteSeleccionado = null;
            ubicacionSeleccionada = null;
            ocSeleccionada = null;
            renderListaPrincipal();
            renderTrazabilidad();
        });

        btnModoOs?.addEventListener('click', () => {
            if (modoListado === 'os') return;
            modoListado = 'os';
            equipoSeleccionado = null;
            osSeleccionada = null;
            clienteSeleccionado = null;
            ubicacionSeleccionada = null;
            ocSeleccionada = null;
            renderListaPrincipal();
            renderTrazabilidad();
        });

        btnModoCliente?.addEventListener('click', () => {
            if (modoListado === 'cliente') return;
            modoListado = 'cliente';
            equipoSeleccionado = null;
            osSeleccionada = null;
            clienteSeleccionado = null;
            ubicacionSeleccionada = null;
            ocSeleccionada = null;
            renderListaPrincipal();
            renderTrazabilidad();
        });

        btnModoUbicacion?.addEventListener('click', () => {
            if (modoListado === 'ubicacion') return;
            modoListado = 'ubicacion';
            equipoSeleccionado = null;
            osSeleccionada = null;
            clienteSeleccionado = null;
            ubicacionSeleccionada = null;
            ocSeleccionada = null;
            renderListaPrincipal();
            renderTrazabilidad();
        });

        btnModoOc?.addEventListener('click', () => {
            if (modoListado === 'oc') return;
            modoListado = 'oc';
            equipoSeleccionado = null;
            osSeleccionada = null;
            clienteSeleccionado = null;
            ubicacionSeleccionada = null;
            ocSeleccionada = null;
            renderListaPrincipal();
            renderTrazabilidad();
        });

        // Ordenar por inicio de servicio al hacer clic en el encabezado
        thInicio?.addEventListener('click', () => {
            sortDirInicio = sortDirInicio === 'asc' ? 'desc' : 'asc';
            renderTrazabilidad();
        });

        cargarActividades();
    }
    </script>

    <script src="nav.js"></script>
    <script src="utils.js"></script>
</body>
</html>