<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas guardadas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir menú">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="#" class="active">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspección</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administración</a></li>
                        <li><a href="trazabilidades.html" class="nav-admin-only">Trazabilidades</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main style="max-width: 100%; margin: 0; padding: 0;">
        <section class="pruebaslist-wrap" style="padding: 0.75rem 0.75rem 1rem;">
        <section class="pruebas-dashboard" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom:0.75rem;">Resumen de estado por equipo</h2>
            <section class="dashboard-cards" style="margin-bottom: 0.75rem;">
                <div class="dash-card">
                    <div class="dash-card-label">Equipos con pruebas vigentes</div>
                    <div class="dash-card-value" id="pruebas-resumen-vigentes">0</div>
                </div>
                <div class="dash-card">
                    <div class="dash-card-label">Equipos con prueba vencida</div>
                    <div class="dash-card-value" id="pruebas-resumen-vencidas">0</div>
                </div>
                <div class="dash-card">
                    <div class="dash-card-label">Equipos sin prueba registrada</div>
                    <div class="dash-card-value" id="pruebas-resumen-sin">0</div>
                </div>
            </section>

            <section style="margin-bottom: 0.75rem;">
                <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:center; font-size:0.9rem;">
                    <div id="chip-60" class="chip" style="padding:0.4rem 0.75rem; border-radius:999px; background:#eff6ff; color:#1d4ed8; cursor:pointer;">
                        60–30 días: <strong id="pruebas-alert-60">0</strong>
                    </div>
                    <div id="chip-30" class="chip" style="padding:0.4rem 0.75rem; border-radius:999px; background:#fef3c7; color:#b45309; cursor:pointer;">
                        30–15 días: <strong id="pruebas-alert-30">0</strong>
                    </div>
                    <div id="chip-15" class="chip" style="padding:0.4rem 0.75rem; border-radius:999px; background:#fee2e2; color:#b91c1c; cursor:pointer;">
                        15–0 días: <strong id="pruebas-alert-15">0</strong>
                    </div>
                </div>
            </section>

            <section style="margin-bottom:1rem; display:none;">
                <h3 style="font-size:1rem; margin-bottom:0.35rem;">Estado por equipo (última prueba)</h3>
                <p style="font-size:0.85rem; color:#6b7280; margin-bottom:0.5rem;">
                    Para cada equipo se muestra la última prueba registrada y su estado de vigencia. Este resumen no se ve afectado por el filtro de búsqueda.
                </p>
                <div class="tabla-inspecciones-wrapper" style="overflow-x:auto;">
                    <table id="tabla-pruebas-resumen" style="width:100%; border-collapse:collapse; font-size:0.9rem; min-width:900px;">
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th style="text-align:left; padding:0.4rem;">Equipo</th>
                                <th style="text-align:left; padding:0.4rem;">Descripción</th>
                                <th style="text-align:left; padding:0.4rem;">Última prueba</th>
                                <th style="text-align:left; padding:0.4rem;">Próxima prueba</th>
                                <th style="text-align:left; padding:0.4rem;">Técnico</th>
                                <th style="text-align:left; padding:0.4rem;">No. reporte / cert.</th>
                                <th style="text-align:left; padding:0.4rem;">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-pruebas-resumen"></tbody>
                    </table>
                    <p id="mensaje-sin-pruebas-resumen" style="font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:none;">
                        No hay información de pruebas para resumir por equipo.
                    </p>
                </div>
            </section>
        </section>

        <section class="pruebas-panel" style="margin-bottom: 1.5rem;">
            <h2>Pruebas y calibraciones</h2>
            <p style="font-size:0.9rem; color:#6b7280; margin-bottom:0.75rem;">
                Se muestran las pruebas registradas en Firestore y su estado de vigencia según la fecha de próxima prueba.
            </p>

            <section class="actividad-toolbar" style="margin-bottom: 0.75rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; justify-content:space-between;">
                <div class="actividad-toolbar-left" style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                    <input type="search" id="pruebas-buscar" placeholder="Buscar por equipo, producto, técnico, reporte..." style="min-width: 260px;">
                </div>
                <div class="actividad-toolbar-right" style="font-size: 0.85rem; color:#4b5563; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center;">
                    <div>
                        <span id="pruebas-contador-pendientes">0 por realizar</span>
                        <span style="margin:0 0.5rem;">·</span>
                        <span id="pruebas-contador-vencidas">0 vencidas</span>
                        <span style="margin:0 0.5rem;">·</span>
                        <span id="pruebas-contador-historico">0 en histórico</span>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <button id="btn-pruebas-eliminar">Eliminar seleccionadas</button>
                        <button id="btn-pruebas-export-csv">Exportar CSV</button>
                    </div>
                </div>
            </section>

            <section style="margin-bottom:1rem;">
                <h3 style="font-size:1rem; margin-bottom:0.35rem;">Listado de pruebas</h3>
                <p style="font-size:0.85rem; color:#6b7280; margin-bottom:0.5rem;">
                    Incluye todas las pruebas registradas. Las pruebas con próxima fecha vencida se resaltan en rojo.
                </p>
                <div class="tabla-inspecciones-wrapper" style="overflow-x:auto;">
                    <table id="tabla-pruebas-listado" style="width:100%; border-collapse:collapse; font-size:0.9rem; min-width:1050px;">
                        <thead>
                            <tr style="background:#f3f4f6;">
                                <th style="text-align:left; padding:0.4rem; width:32px;"><input type="checkbox" id="pruebas-select-todos"></th>
                                <th style="text-align:left; padding:0.4rem;">Fecha realización</th>
                                <th style="text-align:left; padding:0.4rem;">Próxima prueba</th>
                                <th style="text-align:left; padding:0.4rem;">Periodo</th>
                                <th style="text-align:left; padding:0.4rem;">Estado</th>
                                <th style="text-align:left; padding:0.4rem;">Días para próxima</th>
                                <th style="text-align:left; padding:0.4rem;">Equipo</th>
                                <th style="text-align:left; padding:0.4rem;">Producto</th>
                                <th style="text-align:left; padding:0.4rem;">Descripción</th>
                                <th style="text-align:left; padding:0.4rem;">Prueba / Calib.</th>
                                <th style="text-align:left; padding:0.4rem;">Área inspección</th>
                                <th style="text-align:left; padding:0.4rem;">No. reporte / cert.</th>
                                <th style="text-align:left; padding:0.4rem;">Resultado</th>
                                <th style="text-align:left; padding:0.4rem;">Emisor</th>
                                <th style="text-align:left; padding:0.4rem;">Técnico</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-pruebas-listado"></tbody>
                    </table>
                    <p id="mensaje-sin-pruebas-listado" style="font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:none;">
                        No hay pruebas registradas todavía.
                    </p>
                </div>
            </section>
        </section>

        </section>
    </main>

    <script src="nav.js"></script>

    <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCmutjS09d1hCjwlhuH0upkGr_TIVVBktc",
        authDomain: "xpct-tab.firebaseapp.com",
        projectId: "xpct-tab",
        storageBucket: "xpct-tab.firebasestorage.app",
        messagingSenderId: "614589989974",
        appId: "1:614589989974:web:e89a808180e4b563a8e7f7"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    window.auth = auth;

    const emailSpan = document.getElementById('nav-user-email');
    const btnLogout = document.getElementById('btn-logout');

    const ADMINS = [
        "the@unknownshoppers.com",
        "jalcz@pct.com"
    ];

    const INSPECTORES = [
        "inspector01@pct.com",
        "inspector02@pct.com"
    ];

    const CAPTURISTAS = [
    	"capturista@pct.com"
    ];

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        const email = (user.email || '').toLowerCase();
        if (emailSpan) emailSpan.textContent = email;

        const esAdmin = ADMINS.includes(email);
        const esCapturista = CAPTURISTAS.includes(email);

        // Solo admins o capturistas pueden ver esta página
        if (!esAdmin && !esCapturista) {
            window.location.href = 'login.html';
            return;
        }

        window.isAdmin = esAdmin;
        window.isInspector = false;
        window.currentUserEmail = email;

        cargarPruebasDesdeFirestore();
    });

    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } finally {
                window.location.href = 'login.html';
            }
        });
    }

    async function cargarPruebasDesdeFirestore() {
        const tbodyListado = document.getElementById('tbody-pruebas-listado');
        const msgListado = document.getElementById('mensaje-sin-pruebas-listado');
        const inputBuscar = document.getElementById('pruebas-buscar');
        const lblPend = document.getElementById('pruebas-contador-pendientes');
        const lblVenc = document.getElementById('pruebas-contador-vencidas');
        const lblHist = document.getElementById('pruebas-contador-historico');

        const tbodyResumen = document.getElementById('tbody-pruebas-resumen');
        const msgResumen = document.getElementById('mensaje-sin-pruebas-resumen');
        const lblResVig = document.getElementById('pruebas-resumen-vigentes');
        const lblResVenc = document.getElementById('pruebas-resumen-vencidas');
        const lblResSin = document.getElementById('pruebas-resumen-sin');

        const lblAlert60 = document.getElementById('pruebas-alert-60');
        const lblAlert30 = document.getElementById('pruebas-alert-30');
        const lblAlert15 = document.getElementById('pruebas-alert-15');

        // Chips de filtro por rango de días
        const chip60 = document.getElementById('chip-60');
        const chip30 = document.getElementById('chip-30');
        const chip15 = document.getElementById('chip-15');
        let filtroRango = null; // '60' | '30' | '15' | null

        const detallePanel = document.getElementById('detalle-prueba');
        const detalleContenido = document.getElementById('detalle-prueba-contenido');

        const chkSelectTodos = document.getElementById('pruebas-select-todos');
        const btnEliminar = document.getElementById('btn-pruebas-eliminar');
        const btnExportCsv = document.getElementById('btn-pruebas-export-csv');

        // Id (o clave) de la prueba actualmente seleccionada en el panel de detalle
        let pruebaSeleccionadaId = null;

        if (!tbodyListado) return;

        let pruebas = [];
        const claveLocal = 'pct_pruebas';

        // Inventario base desde invre.csv para mostrar todos los equipos, incluso sin pruebas.
        let equiposInventario = new Set();
        let descripcionPorEquipoInv = {};

        async function leerFirestore() {
            try {
                const { getFirestore, collection, getDocs } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );

                const db = getFirestore(app);
                const colRef = collection(db, 'pruebas');
                const snap = await getDocs(colRef);
                return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error al leer pruebas desde Firestore, se usará localStorage como respaldo', e);
                return null;
            }
        }

        const desdeFs = await leerFirestore();
        if (desdeFs && Array.isArray(desdeFs)) {
            pruebas = desdeFs;
        } else {
            try {
                const crudo = JSON.parse(localStorage.getItem(claveLocal) || '[]');
                if (Array.isArray(crudo)) pruebas = crudo;
            } catch {
                pruebas = [];
            }
        }

        async function cargarInventarioDesdeCsv() {
            try {
                const resp = await fetch('docs/invre.csv');
                if (!resp.ok) return;
                const texto = await resp.text();
                const lineas = texto.split(/\r?\n/).filter(l => l.trim() !== '');
                if (!lineas.length) return;

                const parse = (window && window.parseCSVLine) ? window.parseCSVLine : null;
                if (!parse) return;

                const headers = parse(lineas[0]);
                const idxEquipo = headers.indexOf('EQUIPO / ACTIVO');
                const idxDesc = headers.indexOf('DESCRIPCION');
                if (idxEquipo < 0) return;

                const setEq = new Set();
                const mapaDesc = {};

                lineas.slice(1).forEach(l => {
                    const cols = parse(l);
                    const eq = (cols[idxEquipo] || '').toString().trim();
                    if (!eq) return;
                    setEq.add(eq);
                    if (idxDesc >= 0) {
                        const desc = (cols[idxDesc] || '').toString().trim();
                        if (desc && !mapaDesc[eq]) {
                            mapaDesc[eq] = desc;
                        }
                    }
                });

                equiposInventario = setEq;
                descripcionPorEquipoInv = mapaDesc;
            } catch (e) {
                console.warn('No se pudo cargar invre.csv para resumen de pruebas', e);
            }
        }

        await cargarInventarioDesdeCsv();

        function parseFechaRealizacion(str) {
            if (!str) return null;
            const partes = String(str).split('/');
            if (partes.length !== 3) return null;
            const [ddStr, mmStr, aaStr] = partes;
            const dd = parseInt(ddStr, 10);
            const mm = parseInt(mmStr, 10);
            const aa = parseInt(aaStr, 10);
            if (!dd || !mm || isNaN(aa)) return null;
            const year = aa < 100 ? 2000 + aa : aa;
            const d = new Date(year, mm - 1, dd);
            return isNaN(d.getTime()) ? null : d;
        }

        function mostrarDetallePrueba(reg) {
            if (!detalleContenido) return;

            // Construir una clave estable para comparar selecciones repetidas
            const clave =
                (reg && reg.id) ||
                `${reg.equipo || ''}__${reg.fechaRealizacion || ''}__${reg.noReporte || ''}`;

            // Si se hace clic de nuevo sobre la misma prueba, contraer el panel
            if (pruebaSeleccionadaId && pruebaSeleccionadaId === clave) {
                detalleContenido.innerHTML =
                    'No hay ninguna prueba seleccionada.';
                pruebaSeleccionadaId = null;
                return;
            }

            // Cálculo de días para próxima prueba (mismo criterio que en el listado)
            let diasParaProximaDetalle = '';
            if (reg.proxima) {
                const d = parseProxima(reg.proxima);
                if (d) {
                    const hoy = hoySinHora();
                    const diffMs = d.getTime() - hoy.getTime();
                    let dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
                    if (dias < 0) dias = 0;
                    diasParaProximaDetalle = String(dias);
                }
            }

            const campos = [
                ['Equipo', reg.equipo || ''],
                ['Serial', reg.serial || ''],
                ['Producto', reg.producto || ''],
                ['Descripción', reg.descripcion || ''],
                ['Prueba / Calibración', reg.prueba || reg.pruebaTipo || ''],
                ['Resultado', reg.resultado || ''],
                ['Periodo', reg.periodo || ''],
                ['Fecha de prueba', reg.fechaPrueba || ''],
                ['Fecha realización', reg.fechaRealizacion || ''],
                ['Próxima prueba', reg.proxima || ''],
                ['Días para próxima', diasParaProximaDetalle],
                ['No. reporte / certificado', reg.noReporte || ''],
                ['Técnico', reg.tecnico || ''],
                ['Emisor', reg.emisor || ''],
                ['Propiedad', reg.propiedad || ''],
                ['Área a inspeccionar', reg.area || ''],
                ['Observaciones', reg.observaciones || '']
            ];

            const filasHtml = campos
                .filter(([_, valor]) => valor !== undefined && valor !== null && String(valor).trim() !== '')
                .map(([label, valor]) => `
                    <tr>
                        <th style="text-align:left; padding:0.2rem 0.5rem; width:180px; color:#4b5563; font-weight:600;">${label}</th>
                        <td style="padding:0.2rem 0.5rem;">${String(valor)}</td>
                    </tr>
                `)
                .join('');

            detalleContenido.innerHTML = `
                <table style="width:100%; border-collapse:collapse; font-size:0.88rem;">
                    <tbody>
                        ${filasHtml || '<tr><td style="padding:0.4rem; color:#6b7280;">Sin datos para esta prueba.</td></tr>'}
                    </tbody>
                </table>
            `;

            pruebaSeleccionadaId = clave;
        }

        // Construir el HTML del detalle (reutiliza las mismas filas de mostrarDetallePrueba)
        function construirDetalleHTML(reg) {
            let diasParaProximaDetalle = '';
            if (reg.proxima) {
                const d = parseProxima(reg.proxima);
                if (d) {
                    const hoy = hoySinHora();
                    const diffMs = d.getTime() - hoy.getTime();
                    let dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
                    if (dias < 0) dias = 0;
                    diasParaProximaDetalle = String(dias);
                }
            }

            const campos = [
                ['Equipo', reg.equipo || ''],
                ['Serial', reg.serial || ''],
                ['Producto', reg.producto || ''],
                ['Descripción', reg.descripcion || ''],
                ['Prueba / Calibración', reg.prueba || reg.pruebaTipo || ''],
                ['Resultado', reg.resultado || ''],
                ['Periodo', reg.periodo || ''],
                ['Fecha de prueba', reg.fechaPrueba || ''],
                ['Fecha realización', reg.fechaRealizacion || ''],
                ['Próxima prueba', reg.proxima || ''],
                ['Días para próxima', diasParaProximaDetalle],
                ['No. reporte / certificado', reg.noReporte || ''],
                ['Técnico', reg.tecnico || ''],
                ['Emisor', reg.emisor || ''],
                ['Propiedad', reg.propiedad || ''],
                ['Área a inspeccionar', reg.area || ''],
                ['Observaciones', reg.observaciones || '']
            ];

            const filasHtml = campos
                .filter(([_, valor]) => valor !== undefined && valor !== null && String(valor).trim() !== '')
                .map(([label, valor]) => `
                    <tr>
                        <th style="text-align:left; padding:0.2rem 0.5rem; width:180px; color:#4b5563; font-weight:600;">${label}</th>
                        <td style="padding:0.2rem 0.5rem;">${String(valor)}</td>
                    </tr>
                `)
                .join('');

            return `
                <div style="font-size:0.9rem; color:#111827; border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.75rem; background:#f9fafb;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.88rem;">
                        <tbody>
                            ${filasHtml || '<tr><td style="padding:0.4rem; color:#6b7280;">Sin datos para esta prueba.</td></tr>'}
                        </tbody>
                    </table>
                </div>`;
        }

        // Alterna una fila de detalle inmediatamente debajo de la fila clicada
        function toggleDetalleInline(fila, reg) {
            const tbody = fila.parentElement;
            if (!tbody) return;

            // Si ya estaba abierto justo debajo, colapsar y salir
            const next = fila.nextElementSibling;
            if (next && next.classList && next.classList.contains('pl-detalle-row')) {
                next.remove();
                fila.classList.remove('pl-active');
                return;
            }

            // Cerrar cualquier otro detalle abierto previamente
            const abiertos = tbody.querySelectorAll('tr.pl-detalle-row');
            abiertos.forEach(tr => tr.remove());
            tbody.querySelectorAll('tr.pl-active').forEach(tr => tr.classList.remove('pl-active'));

            const detalleTr = document.createElement('tr');
            detalleTr.className = 'pl-detalle-row';
            const detalleTd = document.createElement('td');
            detalleTd.colSpan = 15; // total de columnas en la tabla de listado
            detalleTd.innerHTML = construirDetalleHTML(reg);
            detalleTr.appendChild(detalleTd);
            fila.insertAdjacentElement('afterend', detalleTr);
            fila.classList.add('pl-active');
        }

        function hoySinHora() {
            const d = new Date();
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function parseProxima(str) {
            if (!str) return null;
            const s = String(str).trim();
            if (!s) return null;

            // Soportar formato dd/mm/aa igual que parseFechaRealizacion
            if (s.includes('/')) {
                const partes = s.split('/');
                if (partes.length !== 3) return null;
                const [ddStr, mmStr, aaStr] = partes;
                const dd = parseInt(ddStr, 10);
                const mm = parseInt(mmStr, 10);
                const aa = parseInt(aaStr, 10);
                if (!dd || !mm || isNaN(aa)) return null;
                const year = aa < 100 ? 2000 + aa : aa;
                const d = new Date(year, mm - 1, dd);
                if (isNaN(d.getTime())) return null;
                d.setHours(0, 0, 0, 0);
                return d;
            }

            const d = new Date(s);
            if (isNaN(d.getTime())) return null;
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function clasificarPrueba(reg) {
            const proxima = parseProxima(reg.proxima || '');
            if (!proxima) return { estado: 'SIN_FECHA', proxima: null };
            const hoy = hoySinHora();
            if (proxima < hoy) return { estado: 'VENCIDA', proxima };
            return { estado: 'VIGENTE', proxima };
        }

        function render() {
            const filtro = (inputBuscar?.value || '').toLowerCase().trim();

            tbodyListado.innerHTML = '';
            if (msgListado) msgListado.style.display = 'none';
            if (tbodyResumen) tbodyResumen.innerHTML = '';
            if (msgResumen) msgResumen.style.display = 'none';

            if (!pruebas.length && (!equiposInventario || !equiposInventario.size)) {
                if (msgListado) msgListado.style.display = 'block';
                if (msgResumen) msgResumen.style.display = 'block';
                if (lblPend) lblPend.textContent = '0 por realizar';
                if (lblVenc) lblVenc.textContent = '0 vencidas';
                if (lblHist) lblHist.textContent = '0 en histórico';
                if (lblResVig) lblResVig.textContent = '0';
                if (lblResVenc) lblResVenc.textContent = '0';
                if (lblResSin) lblResSin.textContent = '0';
                return;
            }

            const hoy = hoySinHora();

            const enriquecidas = pruebas.map(reg => {
                const clasif = clasificarPrueba(reg);
                const fechaReal = parseFechaRealizacion(reg.fechaRealizacion || '') || hoySinHora();
                return { ...reg, _clasif: clasif, _fechaRealDate: fechaReal };
            });

            const porRealizar = [];
            const historico = [...enriquecidas];

            enriquecidas.forEach(reg => {
                if (reg._clasif.estado === 'VIGENTE' || reg._clasif.estado === 'VENCIDA') {
                    porRealizar.push(reg);
                }
            });

            // Construir referencia: última ANUAL por equipo
            const anualPorEquipo = new Map();
            enriquecidas.forEach(reg => {
                const eq = (reg.equipo || '').toString();
                if (!eq) return;
                const periodo = (reg.periodo || '').toString().toUpperCase();
                if (periodo !== 'ANUAL') return;
                const actual = anualPorEquipo.get(eq);
                if (!actual || reg._fechaRealDate.getTime() > actual._fechaRealDate.getTime()) {
                    anualPorEquipo.set(eq, reg);
                }
            });

            // Resumen por equipo (última ANUAL) incluyendo equipos sin ANUAL (desde inventario)
            if (tbodyResumen && lblResVig && lblResVenc && lblResSin) {
                const listaEquiposBase = equiposInventario && equiposInventario.size
                    ? Array.from(equiposInventario)
                    : Array.from(anualPorEquipo.keys());

                if (!listaEquiposBase.length && msgResumen) {
                    msgResumen.style.display = 'block';
                }

                let cntEquiposVig = 0;
                let cntEquiposVenc = 0;
                let cntEquiposSin = 0;

                listaEquiposBase.sort((a, b) => a.localeCompare(b)).forEach(eq => {
                    const reg = anualPorEquipo.get(eq) || null;
                    const estado = reg ? reg._clasif.estado : 'SIN_PRUEBA';

                    if (estado === 'VIGENTE') cntEquiposVig += 1;
                    else if (estado === 'VENCIDA') cntEquiposVenc += 1;
                    else cntEquiposSin += 1;

                    const fila = document.createElement('tr');
                    const proximaStr = reg ? (reg.proxima || '') : '';
                    const fechaReal = reg ? (reg.fechaRealizacion || '') : '';
                    const tecnico = reg ? (reg.tecnico || '') : '';
                    const noRep = reg ? (reg.noReporte || '') : '';
                    const desc = reg && reg.descripcion
                        ? reg.descripcion
                        : (descripcionPorEquipoInv[eq] || '');

                    const badge =
                        estado === 'VIGENTE'
                            ? '<span style="padding:0.1rem 0.5rem; border-radius:999px; background:#dcfce7; color:#166534; font-size:0.75rem;">Vigente</span>'
                            : estado === 'VENCIDA'
                                ? '<span style="padding:0.1rem 0.5rem; border-radius:999px; background:#fee2e2; color:#b91c1c; font-size:0.75rem;">Vencida</span>'
                                : '<span style="padding:0.1rem 0.5rem; border-radius:999px; background:#e5e7eb; color:#374151; font-size:0.75rem;">Sin prueba</span>';

                    fila.innerHTML = `
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${eq}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${desc}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${fechaReal}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${proximaStr}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${tecnico}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${noRep}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${badge}</td>
                    `;
                    tbodyResumen.appendChild(fila);
                });

                lblResVig.textContent = String(cntEquiposVig);
                lblResVenc.textContent = String(cntEquiposVenc);
                lblResSin.textContent = String(cntEquiposSin);
            }

            // Ordenar priorizando próximas a vencer (VIGENTE con días >= 0, ascendente) según última ANUAL del equipo,
            // luego vencidas, luego sin fecha, y en cada grupo por fecha de realización desc.
            function diasHastaProxima(reg) {
                const eq = (reg.equipo || '').toString();
                const ref = anualPorEquipo.get(eq);
                if (!ref || !ref._clasif || !ref._clasif.proxima) return null;
                const hoy0 = hoySinHora();
                const diffMs = ref._clasif.proxima.getTime() - hoy0.getTime();
                let dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
                return dias;
            }

            const listaOrdenada = [...historico].sort((a, b) => {
                const da = diasHastaProxima(a);
                const db = diasHastaProxima(b);
                const ea = (anualPorEquipo.get((a.equipo || '').toString())?._clasif?.estado) || 'SIN_FECHA';
                const eb = (anualPorEquipo.get((b.equipo || '').toString())?._clasif?.estado) || 'SIN_FECHA';

                const cat = (regEstado, dias) => {
                    if (regEstado === 'VIGENTE' && dias !== null && dias >= 0) return 0; // próximas a vencer
                    if (regEstado === 'VENCIDA') return 1; // vencidas
                    return 2; // sin fecha u otros
                };

                const ca = cat(ea, da);
                const cb = cat(eb, db);
                if (ca !== cb) return ca - cb;

                if (ca === 0) {
                    // Ambos en próximas a vencer: menor días primero
                    if (da !== db) return (da ?? Number.POSITIVE_INFINITY) - (db ?? Number.POSITIVE_INFINITY);
                }

                // Mismo grupo: más reciente primero
                return b._fechaRealDate.getTime() - a._fechaRealDate.getTime();
            });

            let cntPend = 0;
            let cntVenc = 0;
            let cntHist = 0;

            // Chips: contar por equipo único
            const set60 = new Set(); // 60–30
            const set30 = new Set(); // 30–15
            const set15 = new Set(); // 15–0

            const filasVisibles = [];

            listaOrdenada.forEach(reg => {
                const textoBuscar = `${reg.equipo || ''} ${reg.producto || ''} ${reg.descripcion || ''} ${reg.tecnico || ''} ${reg.noReporte || ''}`.toLowerCase();
                if (filtro && !textoBuscar.includes(filtro)) return;

                const eq = (reg.equipo || '').toString();
                const refAnual = anualPorEquipo.get(eq) || null;
                const estado = refAnual ? refAnual._clasif.estado : 'SIN_FECHA';
                const proximaStr = refAnual ? (refAnual.proxima || '') : '';

                // Contadores: por realizar = vigentes + vencidas
                if (estado === 'VIGENTE' || estado === 'VENCIDA') {
                    cntPend += 1;
                    if (estado === 'VENCIDA') cntVenc += 1;
                }

                const fila = document.createElement('tr');

                if (estado === 'VENCIDA') {
                    fila.style.background = '#fef2f2';
                    fila.style.color = '#b91c1c';
                }

                // Cálculo de días restantes hasta la próxima prueba
                let diasParaProxima = '';
                let diasNum = null;
                if (refAnual && refAnual._clasif.proxima) {
                    const hoy = hoySinHora();
                    const diffMs = refAnual._clasif.proxima.getTime() - hoy.getTime();
                    let dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
                    if (dias < 0) dias = 0; // para vencidas mostramos 0
                    diasNum = dias;
                    diasParaProxima = String(dias);
                }

                // Contar alertas solo para pruebas vigentes con próxima fecha futura (>=0 días)
                if (estado === 'VIGENTE' && diasNum !== null && diasNum >= 0) {
                    if (diasNum >= 30 && diasNum <= 60) {
                        set60.add(eq);
                    } else if (diasNum >= 15 && diasNum < 30) {
                        set30.add(eq);
                    } else if (diasNum >= 0 && diasNum < 15) {
                        set15.add(eq);
                    }
                }

                // Aplicar filtro por rango si está activo (solo vigentes)
                if (filtroRango) {
                    if (estado !== 'VIGENTE' || diasNum === null || diasNum < 0) return;
                    if (filtroRango === '60' && !(diasNum >= 30 && diasNum <= 60)) return;
                    if (filtroRango === '30' && !(diasNum >= 15 && diasNum < 30)) return;
                    if (filtroRango === '15' && !(diasNum >= 0 && diasNum < 15)) return;
                }

                // Badge visual según estado, días restantes y resultado (solo presentación)
                const resultadoStr = (reg.resultado || '').toString().trim().toUpperCase();
                let badgeEstado;

                // Prioridad visual: resultado RECHAZADA => Inoperable
                if (resultadoStr === 'RECHAZADA') {
                    badgeEstado = '<span title="Resultado RECHAZADA: equipo inoperable" style="padding:0.1rem 0.5rem; border-radius:999px; background:#fee2e2; color:#b91c1c; font-size:0.75rem;">Inoperable</span>';
                } else if (estado === 'VENCIDA') {
                    badgeEstado = '<span title="Prueba vencida: la próxima fecha ya pasó" style="padding:0.1rem 0.5rem; border-radius:999px; background:#fee2e2; color:#b91c1c; font-size:0.75rem;">Vencida</span>';
                } else if (estado !== 'VIGENTE') {
                    badgeEstado = '<span title="Sin información de próxima prueba" style="padding:0.1rem 0.5rem; border-radius:999px; background:#e5e7eb; color:#374151; font-size:0.75rem;">Sin fecha</span>';
                } else {
                    // VIGENTE: ajustar solo apariencia por rango de días
                    if (diasNum === null) {
                        badgeEstado = '<span title="Prueba vigente" style="padding:0.1rem 0.5rem; border-radius:999px; background:#dcfce7; color:#166534; font-size:0.75rem;">Vigente</span>';
                    } else if (diasNum >= 30 && diasNum <= 60) {
                        badgeEstado = '<span title="Próximo a caducar (60 a 30 días para la próxima prueba)" style="padding:0.1rem 0.5rem; border-radius:999px; background:#eff6ff; color:#1d4ed8; font-size:0.75rem;">Próximo a caducar</span>';
                    } else if (diasNum >= 15 && diasNum < 30) {
                        badgeEstado = '<span title="Próximo a caducar (30 a 15 días para la próxima prueba)" style="padding:0.1rem 0.5rem; border-radius:999px; background:#fef3c7; color:#b45309; font-size:0.75rem;">Próximo a caducar</span>';
                    } else if (diasNum >= 0 && diasNum < 15) {
                        badgeEstado = '<span title="Próximo a caducar (menos de 15 días para la próxima prueba)" style="padding:0.1rem 0.5rem; border-radius:999px; background:#fee2e2; color:#b91c1c; font-size:0.75rem;">Próximo a caducar</span>';
                    } else {
                        // Vigente pero fuera de esos rangos (más de 60 días, etc.)
                        badgeEstado = '<span title="Prueba vigente" style="padding:0.1rem 0.5rem; border-radius:999px; background:#dcfce7; color:#166534; font-size:0.75rem;">Vigente</span>';
                    }
                }

                const idx = filasVisibles.length;
                filasVisibles.push(reg);

                const periodoActual = (reg.periodo || '').toString().trim().toUpperCase();
                const esAdmin = !!window.isAdmin;
                const periodoTexto = periodoActual || '';

                const celdaPeriodo = esAdmin
                    ? `<select class="pl-periodo" data-id="${reg.id || ''}">
                            <option value=""></option>
                            <option value="ANUAL" ${periodoActual === 'ANUAL' || !periodoActual ? 'selected' : ''}>Anual</option>
                            <option value="POST-TRABAJO" ${periodoActual === 'POST-TRABAJO' ? 'selected' : ''}>Post-trabajo</option>
                            <option value="REPARACION" ${periodoActual === 'REPARACION' ? 'selected' : ''}>Reparación</option>
                       </select>`
                    : periodoTexto;

                fila.innerHTML = `
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;"><input type="checkbox" class="prueba-select" data-idx="${idx}"></td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${reg.fechaRealizacion || ''}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${proximaStr}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${celdaPeriodo}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${badgeEstado}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${diasParaProxima}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${reg.equipo || ''}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${reg.producto || ''}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${reg.descripcion || ''}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">
                        <input type="text" class="pl-prueba" data-id="${reg.id || ''}" value="${(reg.prueba || reg.pruebaTipo || '').toString().replace(/"/g, '&quot;')}">
                    </td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${reg.area || ''}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">
                        <input type="text" class="pl-norep" data-id="${reg.id || ''}" value="${(reg.noReporte || '').toString().replace(/"/g, '&quot;')}">
                    </td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">
                        <select class="pl-resultado" data-id="${reg.id || ''}">
                            <option value=""></option>
                            <option value="ACEPTADA" ${reg.resultado === 'ACEPTADA' ? 'selected' : ''}>ACEPTADA</option>
                            <option value="RECHAZADA" ${reg.resultado === 'RECHAZADA' ? 'selected' : ''}>RECHAZADA</option>
                        </select>
                    </td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${reg.emisor || ''}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${reg.tecnico || ''}</td>
                `;

                fila.style.cursor = 'pointer';
                // Evitar que interacciones con controles activen el toggle de fila
                fila.querySelectorAll('input, select, button, a, label').forEach(el => {
                    el.addEventListener('click', (e) => e.stopPropagation());
                    el.addEventListener('mousedown', (e) => e.stopPropagation());
                });
                fila.addEventListener('click', () => {
                    toggleDetalleInline(fila, reg);
                });

                tbodyListado.appendChild(fila);
                cntHist += 1;
            });

            if (!cntHist && msgListado) msgListado.style.display = 'block';
            if (lblPend) lblPend.textContent = `${cntPend} por realizar`;
            if (lblVenc) lblVenc.textContent = `${cntVenc} vencida${cntVenc === 1 ? '' : 's'}`;
            if (lblHist) lblHist.textContent = `${cntHist} en histórico`;

            if (lblAlert60) lblAlert60.textContent = String(set60.size);
            if (lblAlert30) lblAlert30.textContent = String(set30.size);
            if (lblAlert15) lblAlert15.textContent = String(set15.size);

            // Reiniciar checkbox de selección global
            if (chkSelectTodos) chkSelectTodos.checked = false;

            // Guardar referencia a filasVisibles en el tbody para exportación
            tbodyListado._filasVisibles = filasVisibles;
        }

        if (inputBuscar) {
            inputBuscar.addEventListener('input', () => {
                render();
            });
        }

        function actualizarChipsUI() {
            [chip60, chip30, chip15].forEach(ch => ch && ch.classList.remove('chip-active'));
            if (filtroRango === '60' && chip60) chip60.classList.add('chip-active');
            if (filtroRango === '30' && chip30) chip30.classList.add('chip-active');
            if (filtroRango === '15' && chip15) chip15.classList.add('chip-active');
        }

        function toggleFiltro(r) {
            filtroRango = (filtroRango === r) ? null : r;
            actualizarChipsUI();
            render();
        }

        if (chip60) chip60.addEventListener('click', () => toggleFiltro('60'));
        if (chip30) chip30.addEventListener('click', () => toggleFiltro('30'));
        if (chip15) chip15.addEventListener('click', () => toggleFiltro('15'));

        actualizarChipsUI();
        render();

        if (chkSelectTodos) {
            chkSelectTodos.addEventListener('change', () => {
                const checks = tbodyListado.querySelectorAll('.prueba-select');
                checks.forEach(chk => {
                    chk.checked = chkSelectTodos.checked;
                });
            });
        }

        function obtenerSeleccionadas() {
            const filas = tbodyListado._filasVisibles || [];
            const checks = tbodyListado.querySelectorAll('.prueba-select:checked');
            const seleccionadas = [];
            checks.forEach(chk => {
                const idx = parseInt(chk.getAttribute('data-idx') || '-1', 10);
                if (!isNaN(idx) && idx >= 0 && idx < filas.length) {
                    seleccionadas.push(filas[idx]);
                }
            });
            // Si no hay selección explícita, usar todas las visibles
            return seleccionadas.length ? seleccionadas : filas;
        }

        async function actualizarCampoPrueba(id, nuevoValor) {
            if (!id) return;
            try {
                const { getFirestore, doc, updateDoc } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );
                const db = getFirestore(app);
                const ref = doc(db, 'pruebas', id);
                await updateDoc(ref, { prueba: nuevoValor, pruebaTipo: nuevoValor });

                // Actualizar en memoria
                pruebas = pruebas.map(reg => {
                    if (reg && reg.id === id) {
                        return { ...reg, prueba: nuevoValor, pruebaTipo: nuevoValor };
                    }
                    return reg;
                });
            } catch (e) {
                console.error('No se pudo actualizar la prueba/calibración para id ' + id, e);
                alert('No se pudo guardar el cambio de Prueba / Calib. Revisa la consola para más detalles.');
            }
        }

        async function actualizarCampoNoReporte(id, nuevoValor) {
            if (!id) return;
            try {
                const { getFirestore, doc, updateDoc } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );
                const db = getFirestore(app);
                const ref = doc(db, 'pruebas', id);
                await updateDoc(ref, { noReporte: nuevoValor });

                pruebas = pruebas.map(reg => {
                    if (reg && reg.id === id) {
                        return { ...reg, noReporte: nuevoValor };
                    }
                    return reg;
                });
            } catch (e) {
                console.error('No se pudo actualizar el No. reporte / cert. para id ' + id, e);
                alert('No se pudo guardar el cambio de No. reporte / cert. Revisa la consola para más detalles.');
            }
        }

        async function actualizarCampoResultado(id, nuevoValor) {
            if (!id) return;
            try {
                const { getFirestore, doc, updateDoc } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );
                const db = getFirestore(app);
                const ref = doc(db, 'pruebas', id);
                await updateDoc(ref, { resultado: nuevoValor });

                pruebas = pruebas.map(reg => {
                    if (reg && reg.id === id) {
                        return { ...reg, resultado: nuevoValor };
                    }
                    return reg;
                });
            } catch (e) {
                console.error('No se pudo actualizar el Resultado para id ' + id, e);
                alert('No se pudo guardar el cambio de Resultado. Revisa la consola para más detalles.');
            }
        }

        async function actualizarCampoPeriodo(id, nuevoValor) {
            if (!id) return;
            try {
                const { getFirestore, doc, updateDoc } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );
                const db = getFirestore(app);
                const ref = doc(db, 'pruebas', id);
                await updateDoc(ref, { periodo: nuevoValor || '' });

                pruebas = pruebas.map(reg => {
                    if (reg && reg.id === id) {
                        return { ...reg, periodo: nuevoValor || '' };
                    }
                    return reg;
                });
            } catch (e) {
                console.error('No se pudo actualizar el Periodo para id ' + id, e);
                alert('No se pudo guardar el cambio de Periodo. Revisa la consola para más detalles.');
            }
        }

        function exportarCsv() {
            const filas = obtenerSeleccionadas();
            if (!filas.length) {
                alert('No hay pruebas para exportar.');
                return;
            }

            const encabezados = [
                'FechaRealizacion',
                'Proxima',
                'Estado',
                'DiasParaProxima',
                'Equipo',
                'Producto',
                'Descripcion',
                'Prueba',
                'Area',
                'NoReporte',
                'Resultado',
                'Emisor',
                'Tecnico'
            ];

            function esc(val) {
                const s = String(val ?? '');
                if (/[",;\n]/.test(s)) {
                    return '"' + s.replace(/"/g, '""') + '"';
                }
                return s;
            }

            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');

            const lineas = [];
            lineas.push(encabezados.join(','));

            filas.forEach(reg => {
                const clasif = clasificarPrueba(reg);
                let dias = '';
                if (clasif.proxima) {
                    const d0 = hoySinHora();
                    const diffMs = clasif.proxima.getTime() - d0.getTime();
                    let d = Math.round(diffMs / (1000 * 60 * 60 * 24));
                    if (d < 0) d = 0;
                    dias = String(d);
                }

                const filaCsv = [
                    reg.fechaRealizacion || '',
                    reg.proxima || '',
                    clasif.estado || '',
                    dias,
                    reg.equipo || '',
                    reg.producto || '',
                    reg.descripcion || '',
                    reg.prueba || reg.pruebaTipo || '',
                    reg.area || '',
                    reg.noReporte || '',
                    reg.resultado || '',
                    reg.emisor || '',
                    reg.tecnico || ''
                ].map(esc).join(',');

                lineas.push(filaCsv);
            });

            const blob = new Blob([lineas.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pruebas_${yyyy}${mm}${dd}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        if (btnExportCsv) {
            btnExportCsv.addEventListener('click', exportarCsv);
        }

        async function eliminarSeleccionadas() {
            const filas = obtenerSeleccionadas();
            if (!filas.length) {
                alert('No hay pruebas seleccionadas para eliminar.');
                return;
            }

            const confirmar = window.confirm('Se eliminarán ' + filas.length + ' pruebas seleccionadas de Firestore. Esta acción no se puede deshacer. ¿Continuar?');
            if (!confirmar) return;

            const idsAEliminar = new Set(
                filas
                    .map(reg => (reg && reg.id ? String(reg.id) : ''))
                    .filter(id => !!id)
            );

            if (!idsAEliminar.size) {
                alert('Las pruebas actuales no tienen identificador de Firestore, no se pueden eliminar remotamente.');
                return;
            }

            try {
                const { getFirestore, doc, deleteDoc } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );

                const db = getFirestore(app);

                for (const id of idsAEliminar) {
                    try {
                        const ref = doc(db, 'pruebas', id);
                        await deleteDoc(ref);
                    } catch (e) {
                        console.warn('No se pudo eliminar la prueba con id ' + id, e);
                    }
                }

                // Filtrar las pruebas en memoria y volver a renderizar
                pruebas = pruebas.filter(reg => !(reg && reg.id && idsAEliminar.has(String(reg.id))));
                render();
                alert('Eliminación completada.');
            } catch (e) {
                console.error('Error al eliminar pruebas desde Firestore', e);
                alert('Ocurrió un error al eliminar las pruebas. Revisa la consola para más detalles.');
            }
        }

        if (btnEliminar) {
            btnEliminar.addEventListener('click', eliminarSeleccionadas);
        }

        // Delegación de eventos para inputs/selects editables de prueba, noReporte y resultado
        tbodyListado.addEventListener('change', (ev) => {
            const target = ev.target;
            if (!(target instanceof HTMLInputElement) && !(target instanceof HTMLSelectElement)) return;

            const id = target.getAttribute('data-id') || '';
            const valor = (target.value || '').trim();

            if (target.classList.contains('pl-prueba')) {
                actualizarCampoPrueba(id, valor);
            } else if (target.classList.contains('pl-norep')) {
                actualizarCampoNoReporte(id, valor);
            } else if (target.classList.contains('pl-resultado')) {
                actualizarCampoResultado(id, valor);
            } else if (target.classList.contains('pl-periodo')) {
                actualizarCampoPeriodo(id, valor || '');
            }
        });

        render();
    }
    </script>
</body>
</html>
