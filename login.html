<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | PCT</title>
    <link rel="stylesheet" href="style.css">
    <style>
      /* Scoped tweaks for login page only */
      body { background:#f3f4f6; }
      header { display:none; }
      .login-shell { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
      .card-prueba { width:100%; max-width:420px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:20px 18px; box-shadow:0 8px 30px rgba(17,24,39,0.08); }
      .card-prueba h2 { margin:0 0 10px; color:#111827; font-size:22px; }
      .campo { margin-top:10px; }
      .campo label { display:block; font-size:13px; color:#374151; margin-bottom:6px; }
      .campo input { width:100%; height:38px; border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; outline:none; }
      #btn-login { height:40px; background:#2563eb; color:#fff; border:0; border-radius:10px; font-weight:600; cursor:pointer; }
      #btn-login:disabled { background:#e5e7eb; color:#9ca3af; cursor:not-allowed; }
      .login-logo { display:flex; justify-content:center; margin-bottom:6px; }
      .login-logo img { height:40px; width:auto; }

      .remember-row { margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .remember-text { font-size:13px; color:#374151; line-height:1.2; }
      .toggle { position:relative; display:inline-flex; align-items:center; cursor:pointer; user-select:none; }
      .toggle input { position:absolute; opacity:0; width:1px; height:1px; }
      .toggle-track { width:44px; height:24px; background:#e5e7eb; border-radius:999px; border:1px solid #d1d5db; transition:background 160ms ease, border-color 160ms ease; box-shadow: inset 0 1px 2px rgba(0,0,0,0.06); }
      .toggle-thumb { position:absolute; left:2px; top:2px; width:20px; height:20px; border-radius:999px; background:#ffffff; box-shadow:0 2px 6px rgba(0,0,0,0.18); transition:transform 160ms ease; }
      .toggle input:checked + .toggle-track { background:#2563eb; border-color:#2563eb; }
      .toggle input:checked + .toggle-track .toggle-thumb { transform:translateX(20px); }
      .toggle input:focus-visible + .toggle-track { outline:3px solid rgba(37,99,235,0.25); outline-offset:2px; }
      .login-footnote { margin-top:10px; text-align:center; font-size:11px; letter-spacing:0.08em; color:#9ca3af; font-weight:700; }
    </style>
</head>
<body>
<header></header>

<main class="login-shell">
    <section class="card-prueba">
        <div class="login-logo"><img src="img/logopctch.png" alt="PCT" /></div>
        <h2>Acceso al sistema</h2>
        <div class="campo">
            <label for="login-email">Correo</label>
            <input type="email" id="login-email" placeholder="usuario@pct.com">
        </div>
        <div class="campo">
            <label for="login-password">Contrase침a</label>
            <div style="position:relative; display:flex; align-items:center;">
                <input type="password" id="login-password" placeholder="Contrase침a" style="padding-right:2.25rem; width:100%;">
                <button id="btn-toggle-pass" type="button" aria-label="Mostrar/ocultar contrase침a" style="position:absolute; right:0.35rem; background:#f3f4f6; border:1px solid #d1d5db; color:#374151; height:30px; width:36px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    游녜
                </button>
            </div>
        </div>
        <div class="campo">
            <button id="btn-login" style="margin-top:0.5rem; width:100%;">Entrar</button>
        </div>
        <div class="remember-row">
            <div class="remember-text">Recordarme en este equipo</div>
            <label class="toggle" for="login-remember">
                <input type="checkbox" id="login-remember" />
                <span class="toggle-track"><span class="toggle-thumb"></span></span>
            </label>
        </div>
        <div class="login-footnote">POWERED BY THE UNKNOWN SHOPPER</div>
        <p id="login-mensaje" style="font-size:0.85rem; color:#b91c1c; margin-top:0.25rem;"></p>
    </section>
</main>

<script>
// iOS 10 (iPad 4ta gen) / navegadores viejos no soportan <script type="module">.
// En ese caso, el login fallar칤a "en silencio" porque no se enlaza el handler del bot칩n.
(function(){
  try {
    var supportsModule = false;
    try {
      var s = document.createElement('script');
      supportsModule = ('noModule' in s);
    } catch (e) {}
    if (supportsModule) return;

    var msg = document.getElementById('login-mensaje');
    var btn = document.getElementById('btn-login');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Navegador no compatible';
    }
    if (msg) {
      msg.textContent = 'Este dispositivo/navegador no es compatible (requiere soporte de JavaScript Modules). Usa un iPhone/iPad con iOS 11+ o una computadora.';
    }
  } catch (e) {}
})();
</script>

<!-- Inicializaci칩n de Firebase (segura) -->
<script src="config.local.js"></script>
<script type="module" src="firebase-init.js"></script>
<script type="module">
import { onAuthStateChanged, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const auth = window.auth;

// Si ya est치 logueado, redirigimos seg칰n Custom Claims
onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    try {
        const token = await user.getIdTokenResult(true); // force refresh after role changes
        const role = (token?.claims?.role) || null;
        if (role) {
            // Al ingresar al sistema siempre aterriza en dashboard (index)
            location.href = 'index.html';
        } else {
            // Sin rol asignado: mostrar mensaje y reintentar refrescar claims unos segundos
            const msg = document.getElementById('login-mensaje');
            if (msg) msg.textContent = 'Tu cuenta no tiene rol asignado a칰n. Intentando actualizar permisos...';
            try {
                const btn = document.getElementById('btn-login');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Entrar';
                }
            } catch {}
            let tries = 0;
            const timer = setInterval(async () => {
                tries += 1;
                try {
                    const t = await user.getIdTokenResult(true);
                    const r = (t?.claims?.role) || null;
                    if (r) {
                        clearInterval(timer);
                        location.href = 'index.html';
                        return;
                    }
                } catch {}
                if (tries >= 10) {
                    clearInterval(timer);
                    if (msg) msg.textContent = 'Tu cuenta no tiene rol asignado. Contacta al administrador.';
                    try {
                        const btn = document.getElementById('btn-login');
                        if (btn) {
                            btn.disabled = false;
                            btn.textContent = 'Entrar';
                        }
                    } catch {}
                }
            }, 3000);
        }
    } catch (e) {
        console.error(e);
    }
});

// Manejo del bot칩n de login
const btn = document.getElementById("btn-login");
const inputEmail = document.getElementById("login-email");
const inputPass = document.getElementById("login-password");
const msg = document.getElementById("login-mensaje");
const btnTogglePass = document.getElementById('btn-toggle-pass');
const chkRemember = document.getElementById('login-remember');

// Prefill de correo y preferencia (NO se guarda contrase침a)
try {
    const savedEmail = String(localStorage.getItem('pct_saved_email') || '').trim();
    const persist = String(localStorage.getItem('pct_auth_persist') || 'session');
    if (savedEmail && inputEmail) inputEmail.value = savedEmail;
    if (chkRemember) chkRemember.checked = persist === 'local';
} catch {}

// Mostrar/ocultar contrase침a
if (btnTogglePass) {
    btnTogglePass.addEventListener('click', () => {
        const isPwd = inputPass.type === 'password';
        inputPass.type = isPwd ? 'text' : 'password';
        btnTogglePass.textContent = isPwd ? '游뗻' : '游녜';
    });
}

btn.addEventListener("click", async () => {
    msg.textContent = "";
    const email = (inputEmail.value || "").trim();
    const password = inputPass.value || "";

    if (!email || !password) {
        msg.textContent = "Ingresa correo y contrase침a.";
        return;
    }

    btn.disabled = true;
    btn.textContent = "Entrando...";

    try {
        // Persistencia seg칰n preferencia (Recordarme = local)
        const remember = !!(chkRemember && chkRemember.checked);
        try {
            await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence);
            localStorage.setItem('pct_auth_persist', remember ? 'local' : 'session');
            if (remember) {
                localStorage.setItem('pct_saved_email', email);
            } else {
                localStorage.removeItem('pct_saved_email');
            }
        } catch {}

        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged har치 la redirecci칩n
    } catch (e) {
        console.error(e);
        msg.textContent = "No se pudo iniciar sesi칩n. Verifica tus datos.";
        btn.disabled = false;
        btn.textContent = "Entrar";
    }
});
</script>
</body>
</html>