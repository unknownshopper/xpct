<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad - Administraci√≥n (Ingresos)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir men√∫">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="#" class="active">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administraci√≥n</a></li>
                        <li><a href="trazabilidades.html" class="nav-admin-only">Trazabilidades</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspecci√≥n</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>

               
            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main class="actividad-page actividadlist-wrap">
        <!-- Tarjetas resumen -->
        <section class="dashboard-cards" style="margin-bottom: 0.75rem;">
            <!-- Tarjeta 1: resumen econ√≥mico en columnas -->
            <div class="dash-card">
                <div class="dash-card-label">Resumen econ√≥mico (visibles)</div>
                <div style="display:flex; gap:0.5rem; align-items:flex-end; margin:0.35rem 0 0.5rem 0; flex-wrap:wrap;">
                    <div style="display:flex; flex-direction:column;">
                        <label for="adm-rango-inicio" style="font-size:0.72rem; color:#4b5563;">Rango ingresos: inicio (dd/mm/aa)</label>
                        <input type="text" id="adm-rango-inicio" placeholder="__/__/__" maxlength="8" style="font-size:0.8rem; padding:0.2rem 0.35rem; width:100px;">
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <label for="adm-rango-fin" style="font-size:0.72rem; color:#4b5563;">Rango ingresos: fin (dd/mm/aa)</label>
                        <input type="text" id="adm-rango-fin" placeholder="__/__/__" maxlength="8" style="font-size:0.8rem; padding:0.2rem 0.35rem; width:100px;">
                    </div>
                    <button id="adm-aplicar-rango" type="button" style="font-size:0.8rem; padding:0.3rem 0.6rem; border:1px solid #d1d5db; background:#f9fafb; border-radius:6px; cursor:pointer;">Aplicar rango</button>
                </div>
                <div class="dash-stats">
                    <div class="dash-stat-row" data-cat="CERRADOS" style="cursor:pointer;">
                        <span class="row-left">üí∞ <span>Ingresos acumulados (cerrados)</span></span>
                        <span class="badge gray" id="adm-total-cerrados">$0</span>
                    </div>
                    <div class="dash-stat-row" data-cat="ABIERTOS" style="cursor:pointer;">
                        <span class="row-left">üüß <span>Ingresos acumulados (abiertos)</span></span>
                        <span class="badge amber" id="adm-total-abiertos">$0</span>
                    </div>
                    <div class="dash-stat-row" data-cat="PARCIALES" style="cursor:pointer;">
                        <span class="row-left">üü© <span>Ingresos acumulados (parciales)</span></span>
                        <span class="badge blue" id="adm-total-parciales">$0</span>
                    </div>
                    <div class="dash-stat-row" data-cat="RENTAS" style="cursor:pointer;">
                        <span class="row-left">üìà <span>Rentas acumuladas</span></span>
                        <span class="badge blue" id="adm-total-rentas">$0</span>
                    </div>
                </div>
            </div>

            <!-- Tarjeta 2: tabuladores de estado -->
            <div class="dash-card">
                <div class="dash-card-label">Estados de actividad (visibles)</div>
                <div class="dash-stats">
                    <div class="dash-stat-row">
                        <span class="row-left">üüß <span>Abierto</span></span>
                        <span class="badge amber" id="adm-estado-abierto">0</span>
                    </div>
                    <div class="dash-stat-row">
                        <span class="row-left">üü© <span>Parcial</span></span>
                        <span class="badge blue" id="adm-estado-parcial">0</span>
                    </div>
                    <div class="dash-stat-row">
                        <span class="row-left">‚úÖ <span>Final</span></span>
                        <span class="badge gray" id="adm-estado-final">0</span>
                    </div>
                    <div class="dash-stat-row">
                        <span class="row-left">‚ö†Ô∏è <span>Conflicto</span></span>
                        <span class="badge amber" id="adm-estado-conflicto">0</span>
                    </div>
                    
                </div>
            </div>

            <!-- Tarjeta 3: Cliente / √Årea con total de equipos visibles -->
            <div class="dash-card">
                <div class="dash-card-label">Cliente / √Årea (equipos visibles)</div>
                <div class="dash-stats" id="adm-ca-list">
                    <!-- Se llena desde renderTabla() -->
                </div>
            </div>
        </section>

        <!-- Filtro, edici√≥n en lote, filtros de estado, contador y ayuda -->
        <section class="actividad-toolbar" style="margin-bottom: 0.75rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; justify-content:space-between;">
            <div class="actividad-toolbar-left" style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                <div style="display:flex; flex-direction:column;">
                    <label for="adm-lote-fecha" style="font-size:0.75rem; color:#4b5563;">Fecha lote (dd/mm/aa)</label>
                    <div style="display:flex; gap:0.25rem; align-items:center;">
                        <input type="text" id="adm-lote-fecha" placeholder="__/__/__" maxlength="8" style="font-size:0.8rem; padding:0.2rem 0.35rem; width:100px;">
                        <select id="adm-lote-tipo" title="Tipo de terminaci√≥n" style="font-size:0.8rem; padding:0.2rem 0.35rem;">
                            <option value="PARCIAL">PARCIAL</option>
                            <option value="FINAL">FINAL</option>
                        </select>
                        <button type="button" id="adm-aplicar-fecha-lote" style="font-size:0.75rem; padding:0.3rem 0.5rem;">Aplicar fecha a selecci√≥n</button>
                    </div>
                </div>
            </div>
            <div class="actividad-toolbar-right" style="font-size: 0.85rem; color:#4b5563; display:flex; gap:0.5rem; align-items:center;">
                <button id="adm-btn-actualizar" type="button" title="Actualizar desde servidor" style="font-size:0.8rem; padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; cursor:pointer;">
                    Actualizar
                </button>
                <button id="adm-btn-cambiar-cliente" type="button" title="Cambiar cliente en filas seleccionadas" style="font-size:0.8rem; padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #d1d5db; background:#ffffff; cursor:pointer;">Cambiar cliente selecci√≥n</button>
                <span id="adm-contador">0 registros</span>
            </div>
        </section>

        <!-- Panel de ayuda / tutorial, visible solo cuando el usuario lo activa -->
        <section id="adm-ayuda-panel" style="display:none; margin:0 0.75rem 0.75rem; padding:0.75rem 1rem; background:#ecfeff; border:1px solid #bae6fd; border-radius:0.5rem; font-size:0.85rem; color:#0f172a; max-width:1000px;">
            <h2 style="margin:0 0 0.4rem; font-size:0.95rem; font-weight:600;">C√≥mo usar esta vista de administraci√≥n.</h2>
            <ol style="margin:0 0 0.5rem 1.25rem; padding:0; list-style:decimal;">
                <li style="margin-bottom:0.25rem;">Arriba se muestran los totales de ingresos de los registros visibles.</li>
                <li style="margin-bottom:0.25rem;">Usa el buscador y los filtros de equipo / inicio para acotar los registros.</li>
                <li style="margin-bottom:0.25rem;">Selecciona filas, √°reas o ubicaciones completas con los checkboxes de la izquierda.</li>
                <li style="margin-bottom:0.25rem;">Aplica fecha de terminaci√≥n o precio en lote usando los controles de la barra superior.</li>
                <li style="margin-bottom:0.25rem;">Edita OC y terminaci√≥n directamente en la tabla; los cambios se guardan al salir del campo.</li>
            </ol>
            <p style="margin:0; font-size:0.8rem; color:#475569;">Tip: las actividades abiertas se muestran primero en la tabla para que puedas enfocarte en lo que sigue en servicio.</p>
        </section>

        <!-- Tabla editable -->
        <section class="detalle-equipo" style="padding: 0.75rem 0.75rem 1rem; max-width: 100%;">
            <!-- Mostrar columna Cliente para facilitar b√∫squeda con Ctrl+F -->
            <style>
              .detalle-equipo table thead th:nth-child(2),
              .detalle-equipo table tbody td:nth-child(2) {
                display: table-cell !important;
              }
            </style>
            <div class="tabla-inspecciones-wrapper" style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:0.9rem; min-width:900px;">
                    <thead>
                        <tr style="background:#f3f4f6;">
                            <th style="text-align:center; padding:0.4rem; width:32px;">
                                <input type="checkbox" id="adm-select-todos" title="Seleccionar / deseleccionar todos">
                            </th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Cliente</th>
                            <th style="text-align:left; padding:0.4rem; display:none;">√Årea</th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Ubicaci√≥n</th>
                            <th id="adm-th-equipo" style="text-align:left; padding:0.4rem; cursor:pointer;">Equipo / Activo</th>
                            <th style="text-align:left; padding:0.4rem;">Pruebas</th>
                            <th style="text-align:left; padding:0.4rem;">Descripci√≥n</th>
                            <th id="adm-th-inicio" style="text-align:left; padding:0.4rem; cursor:pointer;">Inicio del servicio</th>
                            <th style="text-align:left; padding:0.4rem;">Parcial / Final</th>
                            <th style="text-align:center; padding:0.4rem;">D√≠as en servicio</th>
                            <th style="text-align:center; padding:0.4rem;">Precio</th>
                            <th style="text-align:center; padding:0.4rem;">Ingreso acumulado</th>
                            <th style="text-align:center; padding:0.4rem;">OS</th>
                            <th style="text-align:center; padding:0.4rem;">OC</th>
                            <th style="text-align:center; padding:0.4rem;">Est-Cot</th>
                            <th style="text-align:center; padding:0.4rem;">Factura</th>
                            <th style="text-align:left; padding:0.4rem;">Acciones</th>
                        </tr>
                    </thead>
                    
                    <tbody id="adm-tbody-actividad">
                    </tbody>
                </table>
            </div>
            <p id="adm-msg-vacio" style="font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:none;">
                No hay registros de actividad todav√≠a.
            </p>
        </section>
    </main>

    <!-- Modal simple para tabulador de per√≠odos de facturaci√≥n -->
    <div id="adm-modal-tabulador" style="position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:50;">
        <div style="background:white; max-width:900px; width:95%; max-height:90vh; overflow:auto; border-radius:0.5rem; box-shadow:0 10px 40px rgba(15,23,42,0.35); padding:1rem 1.25rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
                <div>
                    <h2 style="margin:0; font-size:1.1rem; font-weight:600;">Tabulador de facturaci√≥n</h2>
                    <p id="adm-tabulador-header" style="margin:0.15rem 0 0; font-size:0.85rem; color:#4b5563;"></p>
                </div>
                <div>
                    <button id="adm-tabulador-imprimir" type="button" style="font-size:0.8rem; margin-right:0.5rem;">Imprimir</button>
                    <button id="adm-tabulador-cerrar" type="button" style="font-size:0.8rem;">Cerrar</button>
                </div>
            </div>

            <div style="margin-bottom:0.75rem; padding:0.75rem; background:#f9fafb; border-radius:0.5rem; border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 0.5rem; font-size:0.95rem; font-weight:500;">Nuevo per√≠odo</h3>
                <div style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                    <div style="flex:1 1 120px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Inicio per√≠odo</label>
                        <input id="adm-per-inicio" type="text" placeholder="__/__/__" maxlength="8" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:1 1 120px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Fin per√≠odo</label>
                        <input id="adm-per-fin" type="text" placeholder="__/__/__" maxlength="8" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Tipo</label>
                        <select id="adm-per-tipo" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                            <option value="PARCIAL">PARCIAL</option>
                            <option value="FINAL">FINAL</option>
                        </select>
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Tarifa diaria</label>
                        <input id="adm-per-tarifa" type="number" min="0" step="1" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:0 0 80px;">
                        <label style="font-size:0.75rem; color:#4b5563;">D√≠as</label>
                        <input id="adm-per-dias" type="number" min="0" step="1" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;" disabled>
                    </div>
                    <div style="flex:0 0 110px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Importe</label>
                        <input id="adm-per-importe" type="number" min="0" step="1" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;" disabled>
                    </div>
                    <div style="flex:1 1 140px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Factura</label>
                        <input id="adm-per-factura" type="text" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:1 1 140px;">
                        <label style="font-size:0.75rem; color:#4b5563;">OC</label>
                        <input id="adm-per-oc" type="text" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:2 1 220px;">
                        <label style="font-size:0.75rem; color:#4b5563;">Observaciones</label>
                        <input id="adm-per-obs" type="text" style="width:100%; font-size:0.8rem; padding:0.25rem 0.4rem; border-radius:0.25rem; border:1px solid #d1d5db;">
                    </div>
                    <div style="flex:0 0 auto;">
                        <button id="adm-per-generar" type="button" style="margin-top:1rem; font-size:0.8rem; margin-right:0.35rem;">Generar per√≠odos</button>
                        <button id="adm-per-limpiar" type="button" style="margin-top:1rem; font-size:0.8rem; margin-right:0.35rem; background:#fff7ed; border:1px solid #fed7aa;">Limpiar tabulador</button>
                        <button id="adm-per-guardar" type="button" style="margin-top:1rem; font-size:0.8rem;">Agregar per√≠odo</button>
                    </div>
                </div>
            </div>

            <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                <thead>
                    <tr style="background:#f3f4f6;">
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Inicio</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Fin</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">D√≠as</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Tarifa diaria</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Importe</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Tipo</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">OC</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Factura</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Observaciones</th>
                        <th style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="adm-tabulador-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Inicializaci√≥n segura de Firebase/Auth/Firestore: config.local.js + firebase-init.js -->
    <script src="config.local.js"></script>
    <script type="module" src="firebase-init.js"></script>
    <script type="module">
    // Edici√≥n inline de Cliente en la tabla (doble clic sobre la celda Cliente)
    (function(){
      const tbody = document.getElementById('adm-tbody-actividad');
      if (!tbody) return;

      async function guardarCliente(actividadId, nuevoCliente){
        try {
          const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
          const db = getFirestore();
          await updateDoc(doc(db, 'actividades', actividadId), { cliente: String(nuevoCliente || '').trim() });
          try {
            if (typeof window.pctAudit === 'function') {
              await window.pctAudit('actividadmin_actividades_update_cliente', { actividadId, cliente: String(nuevoCliente || '').trim() }, { throttleKey: `actividadmin_update_cliente_${actividadId}` });
            }
          } catch {}
          return true;
        } catch (e) {
          alert('No se pudo guardar el cliente: ' + (e?.message || e));
          return false;
        }
      }

      tbody.addEventListener('dblclick', async (ev) => {
        const row = ev.target.closest('tr');
        if (!row || !tbody.contains(row)) return;
        // Evitar cuando se hace doble clic sobre controles interactivos
        if (ev.target.closest('input, button, select, a, textarea')) return;

        const actividadId = row.getAttribute('data-id');
        if (!actividadId) return;

        const clienteCell = row.querySelector('td:nth-child(2)');
        const actual = (row.getAttribute('data-cliente') || clienteCell?.textContent || '').trim();
        const nuevo = prompt('Editar cliente (sin normalizar autom√°ticamente):', actual);
        if (nuevo === null) return; // cancelado
        const val = String(nuevo || '').trim();
        if (!val || val === actual) return;
        if (!confirm(`Guardar cliente como "${val}" para esta actividad?`)) return;

        const ok = await guardarCliente(actividadId, val);
        if (ok) {
          row.setAttribute('data-cliente', val);
          if (clienteCell) clienteCell.textContent = val;
        }
      });
    })();
    </script>
    <script type="module">
    // Edici√≥n por encabezado de grupo (doble clic en fila negra CLIENTE:/TERCERO:)
    (function(){
      const tbody = document.getElementById('adm-tbody-actividad');
      if (!tbody) return;

      async function actualizarClienteEn(items, nuevo, convertirTercero){
        const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        const db = getFirestore();
        let ok = 0, fail = 0;
        for (const it of items){
          try {
            const patch = { cliente: nuevo };
            if (convertirTercero) {
              patch.tipo = '';
              patch.terceroPropiedad = '';
              patch.terceroDescripcion = '';
            }
            await updateDoc(doc(db, 'actividades', it.id), patch);
            ok++;
            it.tr.setAttribute('data-cliente', nuevo);
            const c2 = it.tr.querySelector('td:nth-child(2)');
            if (c2) c2.textContent = nuevo;
          } catch(e){
            console.error('Error actualizando cliente', it.id, e);
            fail++;
          }
        }
        alert(`Cliente actualizado. √âxitos: ${ok}, Fallos: ${fail}`);
        try {
          if (typeof window.pctAudit === 'function') {
            await window.pctAudit('actividadmin_bulk_update_cliente', { count: ok, cliente: nuevo }, { throttleKey: `actividadmin_bulk_update_cliente_${String(nuevo || '').trim()}` });
          }
        } catch {}
      }

      tbody.addEventListener('dblclick', async (ev) => {
        const tr = ev.target.closest('tr');
        if (!tr || !tbody.contains(tr)) return;
        // Encabezado de grupo: no tiene data-id
        if (tr.hasAttribute('data-id')) return; // es una fila normal, no encabezado
        if (ev.target.closest('input,button,select,a,textarea')) return;

        const text = (tr.innerText || '').toUpperCase();
        if (!(text.includes('CLIENTE:') || text.includes('TERCERO:'))) return;

        // Recolectar filas de actividad bajo este encabezado hasta el siguiente encabezado
        const items = [];
        let cursor = tr.nextElementSibling;
        while (cursor && cursor.tagName === 'TR'){
          const isActividad = cursor.hasAttribute('data-id');
          if (!isActividad) {
            // ¬øEs un nuevo encabezado? (l√≠nea negra con CLIENTE:/TERCERO:)
            const t = (cursor.innerText || '').toUpperCase();
            if (t.includes('CLIENTE:') || t.includes('TERCERO:')) break; // fin del grupo actual
            // Si es una fila auxiliar (√°rea/ubicaci√≥n), seguimos avanzando
          } else {
            const id = cursor.getAttribute('data-id');
            if (id) items.push({ tr: cursor, id });
          }
          cursor = cursor.nextElementSibling;
        }
        if (!items.length){ alert('No hay filas de actividad bajo este encabezado.'); return; }
        const actual = items[0].tr.getAttribute('data-cliente') || '';
        const nuevo = prompt(`Nuevo cliente para ${items.length} fila(s) del grupo:`, actual);
        if (nuevo === null) return;
        const val = String(nuevo || '').trim();
        if (!val){ alert('Cliente no puede ir vac√≠o.'); return; }
        const convertirTercero = text.includes('TERCERO:')
          ? confirm('Este encabezado es TERCERO. ¬øConvertir estas filas a CLIENTE (quita propiedad/tercero) adem√°s de cambiar cliente?')
          : false;
        if (!confirm(`Confirmar cambio de cliente a "${val}" para ${items.length} fila(s)?`)) return;
        await actualizarClienteEn(items, val, convertirTercero);
      });
    })();
    </script>
    <script type="module">
    // Cambio de cliente en lote sobre filas seleccionadas
    (function(){
      const tbody = document.getElementById('adm-tbody-actividad');
      const btn = document.getElementById('adm-btn-cambiar-cliente');
      if (!tbody || !btn) return;

      function filasSeleccionadas(){
        const rows = [...tbody.querySelectorAll('tr')];
        const sel = [];
        rows.forEach(tr => {
          const chk = tr.querySelector('input[type="checkbox"]');
          const id = tr.getAttribute('data-id');
          if (chk && chk.checked && id) sel.push({ tr, id });
        });
        return sel;
      }

      async function aplicarCambioCliente(items, nuevo, convertirTercero){
        try {
          const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
          const db = getFirestore();
          let ok = 0, fail = 0;
          for (const it of items){
            try {
              const patch = { cliente: nuevo };
              if (convertirTercero) {
                patch.tipo = '';
                patch.terceroPropiedad = '';
                patch.terceroDescripcion = '';
              }
              await updateDoc(doc(db, 'actividades', it.id), patch);
              ok++;
              it.tr.setAttribute('data-cliente', nuevo);
              const clienteCell = it.tr.querySelector('td:nth-child(2)');
              if (clienteCell) clienteCell.textContent = nuevo;
            } catch (e) {
              console.error('Error actualizando cliente', it.id, e);
              fail++;
            }
          }
          alert(`Cliente actualizado. √âxitos: ${ok}, Fallos: ${fail}`);
          try {
            if (typeof window.pctAudit === 'function') {
              await window.pctAudit('actividadmin_bulk_update_cliente', { count: ok, cliente: nuevo }, { throttleKey: `actividadmin_bulk_update_cliente_${String(nuevo || '').trim()}` });
            }
          } catch {}
        } catch (e) {
          alert('No se pudo aplicar el cambio: ' + (e?.message||e));
        }
      }

      btn.addEventListener('click', async () => {
        const sel = filasSeleccionadas();
        if (!sel.length){ alert('Selecciona al menos una fila.'); return; }
        const actual = sel[0].tr.getAttribute('data-cliente') || '';
        const nuevo = prompt(`Nuevo cliente para ${sel.length} fila(s):`, actual);
        if (nuevo === null) return;
        const val = String(nuevo || '').trim();
        if (!val) { alert('Cliente no puede ir vac√≠o.'); return; }
        const convertirTercero = confirm('¬øTambi√©n convertir a CLIENTE? (limpia tipo=TERCERO y propiedad/tercero en las filas seleccionadas)');
        if (!confirm(`Confirmar cambio de cliente a "${val}" para ${sel.length} fila(s)?`)) return;
        await aplicarCambioCliente(sel, val, convertirTercero);
      });
    })();
    </script>
    <script type="module">
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    const APP_VERSION = '2026-01-21-1';

    const db = window.db;
    const auth = window.auth;

    // Habilitar persistencia offline (IndexedDB). Ignorar errores de multi-tab.
    try {
        const { enableIndexedDbPersistence } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
        if (db) {
            enableIndexedDbPersistence(db).catch(() => {});
        }
    } catch {}

    // Acceso por Custom Claims (Firebase): role === 'admin'

    const emailSpan = document.getElementById('nav-user-email');
    const btnLogout = document.getElementById('btn-logout');

    // Mapa de descripcion por equipo desde invre.csv
    window.mapaDescripcionPorEquipoAdm = window.mapaDescripcionPorEquipoAdm || {};
    const mapaDescripcionPorEquipoAdm = window.mapaDescripcionPorEquipoAdm;

    // Helpers de normalizaci√≥n (formato PCT-XX-NN) para usar llaves consistentes
    const __rmAcc = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const __upNoAcc = (s) => __rmAcc((s || '').toUpperCase().trim());
    function __normalizeEquipoAdm(raw) {
        const t = __upNoAcc(raw).replace(/[-\s]+/g, ' ');
        const m = t.match(/^PCT\s+([A-Z]{2,3})\s*0?(\d{1,2})$/) ||
                  t.match(/^PCT\s*([A-Z]{2,3})\s*-?\s*0?(\d{1,2})$/) ||
                  t.match(/^PCT([A-Z]{2,3})0?(\d{1,2})$/) ||
                  t.match(/^PCT\s*-\s*([A-Z]{2,3})\s*-\s*0?(\d{1,2})$/);
        if (m) return `PCT-${m[1]}-${m[2].padStart(2,'0')}`;
        const m2 = __upNoAcc(raw).match(/^PCT-[A-Z]{2,3}-\d{2}$/);
        if (m2) return m2[0];
        return __upNoAcc(raw).replace(/\s+/g, '-');
    }

    (async () => {
        try {
            const resp = await fetch('docs/invre.csv');
            if (!resp.ok) return;
            const texto = await resp.text();
            const lineas = texto.split(/\r?\n/).filter(l => l.trim() !== '');
            if (!lineas.length) return;

            const parse = (window && window.parseCSVLine) ? window.parseCSVLine : (line => {
                const out = [];
                let cur = '';
                let q = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        const next = line[i + 1];
                        if (next === '"') { cur += '"'; i++; continue; }
                        q = !q; continue;
                    }
                    if (ch === ',' && !q) { out.push(cur); cur = ''; continue; }
                    cur += ch;
                }
                out.push(cur);
                return out.map(s => s.trim());
            });

            const headers = parse(lineas[0]);
            const idxEquipo = headers.indexOf('EQUIPO / ACTIVO');
            const idxDesc = headers.indexOf('DESCRIPCION');
            if (idxEquipo < 0 || idxDesc < 0) return;

            lineas.slice(1).forEach(l => {
                const cols = parse(l);
                const eqRaw = (cols[idxEquipo] || '').toString().trim();
                const eq = __normalizeEquipoAdm(eqRaw);
                const desc = (cols[idxDesc] || '').toString().trim();
                if (!eq || !desc) return;
                if (!mapaDescripcionPorEquipoAdm[eq]) {
                    mapaDescripcionPorEquipoAdm[eq] = desc;
                }
            });
            if (window && typeof window.__admRenderTabla === 'function') {
                try { window.__admRenderTabla(); } catch {}
            }
        } catch (e) {
            console.warn('No se pudo cargar invre.csv para descripciones (admin)', e);
        }
    })();

    // Chequeo de versi√≥n para evitar cach√© viejo entre m√°quinas
    (async () => {
        try {
            const prev = localStorage.getItem('appVersion');
            if (prev !== APP_VERSION) {
                localStorage.setItem('appVersion', APP_VERSION);
                if (window.caches && caches.keys) {
                    try {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(k => caches.delete(k).catch(() => {})));
                    } catch {}
                }
                const url = new URL(window.location.href);
                url.searchParams.set('v', APP_VERSION + '-' + Date.now());
                window.location.replace(url.toString());
                return;
            }
        } catch {}
    })();

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        try {
            const email = (user.email || '').toString().toLowerCase();
            if (emailSpan) emailSpan.textContent = email;
        } catch {}

        // Migraci√≥n opcional: marcar terminaciones PARCIALES a partir de los per√≠odos de facturaci√≥n.
        // Uso sugerido: abrir consola en actividadmin.html y ejecutar
        //   marcarTerminacionesParcialesDesdePeriodos()
        // para sincronizar terminacionServicio en actividades que ya tienen per√≠odos PARCIALES
        // pero siguen marcadas como ABIERTAS.
        async function marcarTerminacionesParcialesDesdePeriodos() {
            if (!window.db) {
                console.warn('Firestore (window.db) no est√° disponible para migrar terminaciones parciales');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, query, where, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();

                // Parser local dd/mm/aa -> Date
                function parseFechaDdMmAaLocal(fechaTexto) {
                    if (!fechaTexto) return null;
                    const partes = fechaTexto.split('/');
                    if (partes.length !== 3) return null;
                    const dd = parseInt(partes[0], 10);
                    const mm = parseInt(partes[1], 10);
                    const aa = parseInt(partes[2], 10);
                    if (!dd || !mm || isNaN(aa)) return null;
                    const yyyy = 2000 + aa;
                    const d = new Date(yyyy, mm - 1, dd);
                    if (isNaN(d.getTime())) return null;
                    return d;
                }

                const colAct = collection(db, 'actividades');
                const snapAct = await getDocs(colAct);

                const candidatos = snapAct.docs
                    .map(d => ({ id: d.id, ...(d.data() || {}) }))
                    .filter(a => {
                        const tieneFin = (a.terminacionServicio || '').toString().trim() !== '';
                        const flagFinal = a.terminacionEsFinal === true;
                        // Solo actividades sin terminaci√≥n o con terminaci√≥n vac√≠a y no marcadas como FINAL
                        return !tieneFin && !flagFinal;
                    });

                if (!candidatos.length) {
                    console.log('No se encontraron actividades candidatas a marcar como PARCIAL.');
                    return;
                }

                const colPer = collection(db, 'actividadPeriodos');
                let actualizados = 0;

                for (const act of candidatos) {
                    const qPer = query(colPer, where('actividadId', '==', act.id));
                    const snapPer = await getDocs(qPer);
                    if (snapPer.empty) continue;

                    // Tomar el √∫ltimo per√≠odo por fecha de finPeriodo
                    const periodos = snapPer.docs
                        .map(d => d.data() || {})
                        .filter(p => (p.finPeriodo || '').toString().trim() !== '');
                    if (!periodos.length) continue;

                    periodos.sort((p1, p2) => {
                        const f1 = (p1.finPeriodo || '').toString();
                        const f2 = (p2.finPeriodo || '').toString();
                        const d1 = parseFechaDdMmAaLocal(f1) || new Date(2000, 0, 1);
                        const d2 = parseFechaDdMmAaLocal(f2) || new Date(2000, 0, 1);
                        return d1.getTime() - d2.getTime();
                    });

                    const ultimo = periodos[periodos.length - 1];
                    if (!ultimo || !(ultimo.finPeriodo || '').toString().trim()) continue;

                    const finUltimo = (ultimo.finPeriodo || '').toString().trim();

                    await updateDoc(doc(db, 'actividades', act.id), {
                        terminacionServicio: finUltimo,
                        terminacionEsFinal: false,
                    });
                    actualizados++;
                }

                console.log(`Marcado de terminaciones parciales completado. Actividades actualizadas: ${actualizados}`);
                try {
                    if (typeof window.pctAudit === 'function') {
                        await window.pctAudit('actividadmin_terminacion_parcial_desde_periodos', { count: actualizados }, { throttleKey: 'actividadmin_terminacion_parcial_desde_periodos' });
                    }
                } catch {}
            } catch (e) {
                console.error('Error al marcar terminaciones parciales desde per√≠odos', e);
            }
        }

        // Marcado autom√°tico de terminaciones definitivas hist√≥ricas.
        // Uso sugerido: abrir consola en actividadmin.html y ejecutar
        //   marcarTerminacionesFinalesDesdePeriodos()
        // para sincronizar terminacionEsFinal en actividades antiguas.
        async function marcarTerminacionesFinalesDesdePeriodos() {
            if (!window.db) {
                console.warn('Firestore (window.db) no est√° disponible para migrar terminaciones finales');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, query, where, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();

                const colAct = collection(db, 'actividades');
                const snapAct = await getDocs(colAct);

                const candidatos = snapAct.docs
                    .map(d => ({ id: d.id, ...(d.data() || {}) }))
                    .filter(a => {
                        const tieneFin = (a.terminacionServicio || '').toString().trim() !== '';
                        const flagFinal = a.terminacionEsFinal === true;
                        return tieneFin && !flagFinal;
                    });

                if (!candidatos.length) {
                    console.log('No se encontraron actividades candidatas a marcar como FINAL.');
                    return;
                }

                const colPer = collection(db, 'actividadPeriodos');
                let actualizados = 0;

                for (const act of candidatos) {
                    const finServ = (act.terminacionServicio || '').toString().trim();
                    if (!finServ) continue;

                    const qPer = query(colPer, where('actividadId', '==', act.id));
                    const snapPer = await getDocs(qPer);
                    if (snapPer.empty) continue;

                    const tieneFinalCoincidente = snapPer.docs.some(d => {
                        const p = d.data() || {};
                        const tipo = (p.tipoPeriodo || '').toString().toUpperCase();
                        const finPer = (p.finPeriodo || '').toString().trim();
                        return tipo === 'FINAL' && finPer === finServ;
                    });

                    if (!tieneFinalCoincidente) continue;

                    await updateDoc(doc(db, 'actividades', act.id), { terminacionEsFinal: true });
                    actualizados++;
                }

                console.log(`Marcado de terminaciones definitivas completado. Actividades actualizadas: ${actualizados}`);
                try {
                    if (typeof window.pctAudit === 'function') {
                        await window.pctAudit('actividadmin_marcar_terminacion_final', { count: actualizados }, { throttleKey: 'actividadmin_marcar_terminacion_final' });
                    }
                } catch {}
            } catch (e) {
                console.error('Error al marcar terminaciones finales desde per√≠odos', e);
            }
        }

        // Exponer funciones de migraci√≥n en window para uso puntual desde consola
        window.migrarActividadesMultiEquipo = migrarActividadesMultiEquipo;
        window.marcarTerminacionesFinalesDesdePeriodos = marcarTerminacionesFinalesDesdePeriodos;
        window.marcarTerminacionesParcialesDesdePeriodos = marcarTerminacionesParcialesDesdePeriodos;
        try {
            if (typeof migrarOsFormatoNuevo === 'function') {
                window.migrarOsFormatoNuevo = migrarOsFormatoNuevo;
            }
        } catch {}
        // Exponer generador de per√≠odos mensuales
        try {
            if (typeof generarPeriodosMensuales === 'function') {
                window.generarPeriodosMensuales = generarPeriodosMensuales;
            }
        } catch {}
        // El render se expondr√° desde el IIFE principal para evitar referencias fuera de su √°mbito
    });

    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } finally {
                window.location.href = 'login.html';
            }
        });
    }
    </script>

    <script src="nav.js"></script>
    <script src="utils.js"></script>

    <!-- L√≥gica de administraci√≥n de actividades usando Firestore -->
    <script>
    (function() {
        let listaActividad = [];
        let filtroInicioServicio = '';
        let filtroEquipo = '';
        let filtroDescripcion = '';
        let filtroEstado = 'TODOS';
        let filtroPruebas = 'TODOS'; // VIGENTE / VENCIDA / SIN_PRUEBA / TODOS
        // null = sin orden especial, 'asc' = m√°s antiguo primero, 'desc' = m√°s reciente primero
        let ordenInicioDir = null;
        // Orden por equipo / activo: null = sin orden, 'asc' / 'desc'
        let ordenEquipoDir = null;
        let ayudaActiva = false;

        // Mapa precargado de estado de pruebas por equipo, para no recalcular en cada render.
        // Estructura: { [equipo]: { estadoUltima: 'VIGENTE' | 'VENCIDA' | 'SIN_FECHA' | 'SIN_PRUEBA', ultima?: {...} } }
        let mapaPruebasPorEquipo = {};

        // Helpers de normalizaci√≥n locales (este <script> no es m√≥dulo, no ve los del bloque anterior)
        const __rmAcc_local = (s) => (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        const __upNoAcc_local = (s) => __rmAcc_local((s || '').toUpperCase().trim());
        function __normalizeEquipoAdm(raw) {
            const t = __upNoAcc_local(raw).replace(/[-\s]+/g, ' ');
            const m = t.match(/^PCT\s+([A-Z]{2,3})\s*0?(\d{1,2})$/) ||
                      t.match(/^PCT\s*([A-Z]{2,3})\s*-?\s*0?(\d{1,2})$/) ||
                      t.match(/^PCT([A-Z]{2,3})0?(\d{1,2})$/) ||
                      t.match(/^PCT\s*-\s*([A-Z]{2,3})\s*-\s*0?(\d{1,2})$/);
            if (m) return `PCT-${m[1]}-${m[2].padStart(2,'0')}`;
            const m2 = __upNoAcc_local(raw).match(/^PCT-[A-Z]{2,3}-\d{2}$/);
            if (m2) return m2[0];
            return __upNoAcc_local(raw).replace(/\s+/g, '-');
        }

        function formatearMoneda(valor) {
            const n = Number(valor) || 0;
            return n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 });
        }

        // Convierte fecha en formato dd/mm/aa a objeto Date (a√±o base 2000+aa)
        function parseFechaDdMmAa(fechaTexto) {
            if (!fechaTexto) return null;
            const partes = fechaTexto.split('/');
            if (partes.length !== 3) return null;
            const [ddStr, mmStr, aaStr] = partes;
            const dd = parseInt(ddStr, 10);
            const mm = parseInt(mmStr, 10);
            const aa = parseInt(aaStr, 10);
            if (!dd || !mm || isNaN(aa)) return null;
            const yyyy = 2000 + aa;
            const d = new Date(Date.UTC(yyyy, mm - 1, dd));
            if (isNaN(d.getTime())) return null;
            return d;
        }

        // Fuente de verdad de per√≠odos: actividadPeriodos -> resumen por actividadId
        // Nota: se carga una sola vez por sesi√≥n y se usa para mostrar terminaci√≥n/tipo/d√≠as en la lista.
        window.__admPeriodosPorActividad = window.__admPeriodosPorActividad || null; // Map
        window.__admPeriodosPromise = window.__admPeriodosPromise || null;
        async function cargarPeriodosParaVistaAdm() {
            if (window.__admPeriodosPorActividad) return window.__admPeriodosPorActividad;
            if (window.__admPeriodosPromise) return window.__admPeriodosPromise;
            window.__admPeriodosPromise = (async () => {
                try {
                    const { getFirestore, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                    const db = getFirestore();
                    const snap = await getDocs(collection(db, 'actividadPeriodos'));
                    // 1) Agrupar per√≠odos por actividad para evaluar conflicto por orden cronol√≥gico (Firestore no garantiza orden)
                    const porAct = new Map();
                    snap.forEach(docu => {
                        const p = docu.data() || {};
                        const actId = (p.actividadId || '').toString();
                        if (!actId) return;
                        const inicio = (p.inicioPeriodo || '').toString();
                        const fin = (p.finPeriodo || '').toString();
                        const tipo = (p.tipoPeriodo || '').toString().toUpperCase();
                        porAct.set(actId, (porAct.get(actId) || []).concat([{ inicio, fin, tipo, diasFacturados: Number(p.diasFacturados || 0) || 0 }]));
                    });

                    // 2) Construir resumen por actividad
                    const mapa = new Map();
                    for (const [actId, lista] of porAct.entries()) {
                        // Ordenar por fin (y luego inicio) en UTC
                        lista.sort((a, b) => {
                            const afi = a.fin ? parseFechaDdMmAa(a.fin) : null;
                            const bfi = b.fin ? parseFechaDdMmAa(b.fin) : null;
                            const ats = afi ? afi.getTime() : -1;
                            const bts = bfi ? bfi.getTime() : -1;
                            if (ats !== bts) return ats - bts;
                            const aii = a.inicio ? parseFechaDdMmAa(a.inicio) : null;
                            const bii = b.inicio ? parseFechaDdMmAa(b.inicio) : null;
                            const ais = aii ? aii.getTime() : -1;
                            const bis = bii ? bii.getTime() : -1;
                            return ais - bis;
                        });

                        let diasTotal = 0;
                        let ultimoFin = '';
                        let ultimoTipo = '';
                        let ultimoFinTs = -1;
                        let ultimoInicio = '';
                        let vioFinal = false;
                        let conflictoFinalIntermedio = false;

                        for (let i = 0; i < lista.length; i++) {
                            const p = lista[i];
                            // Recalcular d√≠as desde inicio/fin (UTC inclusivo)
                            let diasCalc = 0;
                            const dIni = p.inicio ? parseFechaDdMmAa(p.inicio) : null;
                            const dFin = p.fin ? parseFechaDdMmAa(p.fin) : null;
                            if (dIni && dFin) {
                                const diffMs = dFin.getTime() - dIni.getTime();
                                const diffDias = Math.floor(diffMs / 86400000);
                                if (diffDias >= 0) diasCalc = diffDias + 1;
                            }
                            const dias = diasCalc || p.diasFacturados || 0;
                            diasTotal += dias;

                            const ts = dFin ? dFin.getTime() : -1;
                            if (ts > ultimoFinTs) {
                                ultimoFinTs = ts;
                                ultimoFin = p.fin;
                                ultimoTipo = p.tipo;
                                ultimoInicio = p.inicio;
                            }

                            // Conflicto real: existe un FINAL y luego aparece cualquier otro per√≠odo despu√©s.
                            if (p.tipo === 'FINAL') {
                                // si no es el √∫ltimo elemento, entonces hay algo despu√©s
                                if (i < lista.length - 1) conflictoFinalIntermedio = true;
                                vioFinal = true;
                            } else {
                                if (vioFinal) conflictoFinalIntermedio = true;
                            }
                        }

                        mapa.set(actId, { diasTotal, ultimoFin, ultimoTipo, ultimoFinTs, ultimoInicio, conflictoFinalIntermedio });
                    }
                    window.__admPeriodosPorActividad = mapa;
                    return mapa;
                } catch (e) {
                    console.error('No se pudieron cargar actividadPeriodos para la vista admin', e);
                    window.__admPeriodosPorActividad = new Map();
                    return window.__admPeriodosPorActividad;
                } finally {
                    window.__admPeriodosPromise = null;
                }
            })();
            return window.__admPeriodosPromise;
        }

        // Autoformato para inputs dd/mm/aa (similar a pruebas)
        function formatearFechaDdMmAaInput(valor) {
            const soloDigitos = (valor || '').replace(/\D/g, '').slice(0, 6);
            let res = soloDigitos;
            if (soloDigitos.length >= 3 && soloDigitos.length <= 4) {
                res = soloDigitos.slice(0, 2) + '/' + soloDigitos.slice(2);
            } else if (soloDigitos.length >= 5) {
                res =
                    soloDigitos.slice(0, 2) +
                    '/' +
                    soloDigitos.slice(2, 4) +
                    '/' +
                    soloDigitos.slice(4);
            }
            return res;
        }

        async function cargarPruebasResumenPorEquipo() {
            const claveLocal = 'pct_pruebas';
            let pruebas = [];

            function hoySinHora() {
                const d = new Date();
                d.setHours(0, 0, 0, 0);
                return d;
            }

            function parseProxima(str) {
                if (!str) return null;
                const d = new Date(str);
                if (isNaN(d.getTime())) return null;
                d.setHours(0, 0, 0, 0);
                return d;
            }

            function parseFechaRealizacion(str) {
                if (!str) return null;
                const partes = String(str).split('/');
                if (partes.length !== 3) return null;
                const [ddStr, mmStr, aaStr] = partes;
                const dd = parseInt(ddStr, 10);
                const mm = parseInt(mmStr, 10);
                const aa = parseInt(aaStr, 10);
                if (!dd || !mm || isNaN(aa)) return null;
                const year = aa < 100 ? 2000 + aa : aa;
                const d = new Date(year, mm - 1, dd);
                return isNaN(d.getTime()) ? null : d;
            }

            function clasificar(reg) {
                const proxima = parseProxima(reg.proxima || '');
                if (!proxima) return { estado: 'SIN_FECHA', proxima: null };
                const hoy = hoySinHora();
                if (proxima < hoy) return { estado: 'VENCIDA', proxima };
                return { estado: 'VIGENTE', proxima };
            }

            async function leerDesdeFirestore() {
                try {
                    if (!window.db) return null;
                    const { getFirestore, collection, getDocs, getDocsFromCache } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                    const db = getFirestore();
                    const colRef = collection(db, 'pruebas');
                    let snap;
                    try { snap = await getDocsFromCache(colRef); }
                    catch { snap = await getDocs(colRef); }
                    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
                } catch (e) {
                    console.warn('No se pudieron leer pruebas desde Firestore (actividadmin)', e);
                    return null;
                }
            }

            const desdeFs = await leerDesdeFirestore();
            if (desdeFs && Array.isArray(desdeFs)) {
                pruebas = desdeFs;
            } else {
                try {
                    const crudo = JSON.parse(localStorage.getItem(claveLocal) || '[]');
                    if (Array.isArray(crudo)) pruebas = crudo;
                } catch {
                    pruebas = [];
                }
            }

            if (!pruebas.length) {
                mapaPruebasPorEquipo = {};
                return;
            }

            const enriquecidas = pruebas.map(reg => {
                const c = clasificar(reg);
                const fReal = parseFechaRealizacion(reg.fechaRealizacion || '') || hoySinHora();
                return { ...reg, _clasif: c, _fechaReal: fReal };
            });

            const porEquipo = new Map();
            enriquecidas.forEach(reg => {
                const eqRaw = (reg.equipo || '').toString();
                const eq = __normalizeEquipoAdm(eqRaw);
                if (!eq) return;
                const actual = porEquipo.get(eq);
                if (!actual || reg._fechaReal.getTime() > actual._fechaReal.getTime()) {
                    porEquipo.set(eq, reg);
                }
            });

            const mapa = {};
            porEquipo.forEach((reg, eq) => {
                mapa[eq] = {
                    estadoUltima: reg._clasif.estado,
                    ultima: reg,
                };
            });

            mapaPruebasPorEquipo = mapa;
        }

        async function cargarActividadDesdeFirestore() {
            if (!window.db) {
                console.warn('Firestore (window.db) no est√° disponible en actividadmin');
                listaActividad = [];
                renderTabla();
                return;
            }

            try {
                const { getFirestore, collection, getDocs, getDocsFromCache, query, where, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();
                const colRef = collection(db, 'actividades');

                // Construir consultas (primaria y fallback)
                const currentYear = (new Date()).getFullYear();
                const minYear = currentYear - 12; // ventana: √∫ltimos 12 a√±os
                let qPrimaria = null;
                let qFallback = null;
                try {
                    qPrimaria = query(
                        colRef,
                        where('anioInicio', '>=', minYear),
                        orderBy('anioInicio', 'asc'),
                        orderBy('inicioTs', 'desc'),
                        limit(300)
                    );
                } catch {}
                try {
                    qFallback = query(colRef, orderBy('inicioTs', 'desc'), limit(300));
                } catch {}

                let snapCache = null;
                let snapNet = null;

                // 1) Pintar r√°pido desde cach√© si existe
                try { if (qPrimaria) snapCache = await getDocsFromCache(qPrimaria); } catch {}
                if ((!snapCache || snapCache.empty) && qFallback) {
                    try { snapCache = await getDocsFromCache(qFallback); } catch {}
                }
                if (snapCache && !snapCache.empty) {
                    listaActividad = snapCache.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderTabla();
                }

                // 2) Siempre intentar refresco de red y re-render si cambia
                try { if (qPrimaria) snapNet = await getDocs(qPrimaria); } catch {}
                if ((!snapNet || snapNet.empty) && qFallback) {
                    try { snapNet = await getDocs(qFallback); } catch {}
                }
                if (snapNet && !snapNet.empty) {
                    const nuevos = snapNet.docs.map(d => ({ id: d.id, ...d.data() }));
                    const prev = Array.isArray(listaActividad) ? listaActividad : [];
                    const changed = (!prev.length) || prev.length !== nuevos.length || prev.some((r,i) => r.id !== nuevos[i]?.id);
                    listaActividad = nuevos;
                    if (changed) renderTabla();
                } else if (!snapCache || snapCache.empty) {
                    // No hubo datos ni en cach√© ni en red
                    listaActividad = [];
                    renderTabla();
                }
            } catch (e) {
                console.error('Error al cargar actividades desde Firestore (admin)', e);
                listaActividad = [];
                renderTabla();
            }
        }

        async function actualizarActividadEnFirestore(id, cambios) {
            if (!window.db) {
                console.warn('Firestore (window.db) no est√° disponible para actualizar');
                return;
            }

            try {
                const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();
                const ref = doc(db, 'actividades', id);
                await updateDoc(ref, cambios);
                try {
                    if (typeof window.pctAudit === 'function') {
                        await window.pctAudit('actividadmin_update_actividad', { actividadId: id, fields: Object.keys(cambios || {}) }, { throttleKey: `actividadmin_update_actividad_${id}` });
                    }
                } catch {}
            } catch (e) {
                console.error('Error al actualizar actividad en Firestore', e);
            }
        }

        // MIGRACI√ìN OPCIONAL: convertir documentos con `equipos` (array) en 1 doc por equipo
        // Uso: abrir consola en actividadmin.html y ejecutar: migrarActividadesMultiEquipo()
        async function migrarActividadesMultiEquipo() {
            if (!window.db) {
                console.warn('Firestore (window.db) no est√° disponible para migrar');
                return;
            }

            try {
                const { getFirestore, collection, getDocs, addDoc, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                const db = getFirestore();
                const colRef = collection(db, 'actividades');
                const snap = await getDocs(colRef);

                let migrados = 0;

                for (const d of snap.docs) {
                    const data = d.data() || {};
                    const equiposArr = Array.isArray(data.equipos) && data.equipos.length > 1
                        ? data.equipos
                        : null;

                    if (!equiposArr) continue; // nada que migrar

                    const {
                        equipos,
                        equipo,
                        ...resto
                    } = data;

                    for (const equipoNombre of equiposArr) {
                        const nuevo = {
                            ...resto,
                            equipo: equipoNombre,
                        };
                        await addDoc(colRef, nuevo);
                    }

                    await deleteDoc(doc(db, 'actividades', d.id));
                    migrados++;
                }

                console.log(`Migraci√≥n completa. Documentos origen eliminados: ${migrados}`);
                try {
                    if (typeof window.pctAudit === 'function') {
                        await window.pctAudit('actividadmin_migracion_actividades', { count: migrados }, { throttleKey: 'actividadmin_migracion_actividades' });
                    }
                } catch {}
            } catch (e) {
                console.error('Error durante la migraci√≥n de actividades multi-equipo', e);
            }
        }

        function renderTabla() {
            const tbody = document.getElementById('adm-tbody-actividad');
            const msgVacio = document.getElementById('adm-msg-vacio');
            const lblCont = document.getElementById('adm-contador');
            const inputBuscar = document.getElementById('adm-buscar');
            const inpRangoIni = document.getElementById('adm-rango-inicio');
            const inpRangoFin = document.getElementById('adm-rango-fin');
            const spanCerrados = document.getElementById('adm-total-cerrados');
            const spanAbiertos = document.getElementById('adm-total-abiertos');
            const spanParciales = document.getElementById('adm-total-parciales');
            const spanRentas = document.getElementById('adm-total-rentas');
            const spanEstAbierto = document.getElementById('adm-estado-abierto');
            const spanEstParcial = document.getElementById('adm-estado-parcial');
            const spanEstFinal = document.getElementById('adm-estado-final');
            const spanEstConflicto = document.getElementById('adm-estado-conflicto');
            const caList = document.getElementById('adm-ca-list');

            if (!tbody) return;

            // Formateo y wiring de rango de ingresos (una sola vez)
            if (!window.__admRangoWired) {
                const wireRango = (inp) => {
                    if (!inp) return;
                    inp.addEventListener('input', () => {
                        const digits = (inp.value || '').replace(/[^0-9]/g, '').slice(0, 6);
                        let out = '';
                        if (digits.length <= 2) {
                            out = digits;
                        } else if (digits.length <= 4) {
                            out = digits.slice(0,2) + '/' + digits.slice(2);
                        } else {
                            out = digits.slice(0,2) + '/' + digits.slice(2,4) + '/' + digits.slice(4,6);
                        }
                        inp.value = out;
                    });
                    inp.addEventListener('blur', () => {
                        // Recalcular al cerrar el campo
                        renderTabla();
                    });
                };
                wireRango(inpRangoIni);
                wireRango(inpRangoFin);
                window.__admRangoWired = true;
            }

            const listaBase = Array.isArray(listaActividad) ? listaActividad : [];
            // Normalizador de cliente (dedupe variantes de Halliburton/Schlumberger)
            const __normCliAdm = (s) => {
                const rmAcc = (x) => (x || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                const up = rmAcc(String(s || '').trim()).toUpperCase();
                const raw = up.replace(/[^A-Z]/g, '');
                if (
                    raw.startsWith('HALLI') || raw.includes('HALIBURT') || raw.includes('HALLIBURT') ||
                    raw.includes('HALIBURTO') || raw.includes('HALLIBURTO') || raw.includes('HALIBURON') || raw.includes('HALLIBURON')
                ) return 'HALLIBURTON';
                if (
                    raw.startsWith('SCHLUM') || raw.includes('SCHLUMBERG') || raw.includes('SLCHUL') ||
                    raw.includes('SCHLUMBERGER') || raw.includes('SCHLUMER')
                ) return 'SCHLUMBERGER';
                return up;
            };
            let filtro = (inputBuscar?.value || '').toLowerCase().trim();

            // Asegurar que el mapa de per√≠odos est√© disponible para evitar mostrar terminaciones err√≥neas.
            if (!window.__admPeriodosPorActividad && !window.__admPeriodosPromise) {
                // Primera vez: cargar y re-render.
                tbody.innerHTML = '';
                if (msgVacio) { msgVacio.style.display = 'block'; msgVacio.textContent = 'Cargando per√≠odos‚Ä¶'; }
                cargarPeriodosParaVistaAdm().then(() => {
                    if (msgVacio) { msgVacio.textContent = 'No hay registros de actividad todav√≠a.'; }
                    renderTabla();
                });
                return;
            }
            const mapaPeriodos = window.__admPeriodosPorActividad || new Map();

            tbody.innerHTML = '';

            if (!listaBase.length) {
                msgVacio.style.display = 'block';
                lblCont.textContent = '0 registros';
                if (spanCerrados) spanCerrados.textContent = '$0';
                if (spanAbiertos) spanAbiertos.textContent = '$0';
                if (spanParciales) spanParciales.textContent = '$0';
                if (spanRentas) spanRentas.textContent = '$0';
                if (spanEstAbierto) spanEstAbierto.textContent = '0';
                if (spanEstParcial) spanEstParcial.textContent = '0';
                if (spanEstFinal) spanEstFinal.textContent = '0';
                if (spanEstConflicto) spanEstConflicto.textContent = '0';
                if (caList) caList.innerHTML = '';
                return;
            }

            msgVacio.style.display = 'none';

            let totalCerrados = 0;
            let totalAbiertos = 0;
            let totalParciales = 0;
            let totalRentas = 0;
            const listAbiertos = [];
            const listParciales = [];
            const listCerrados = [];
            const listRentas = [];
            let sumaPrecios = 0;
            let cuentaPrecios = 0;
            let visibles = 0;
            let contarAbierto = 0;
            let contarParcial = 0;
            let contarFinal = 0;
            let contarConflicto = 0;
            const equiposPorClienteArea = new Map(); // key: cliente||' - '|| area -> count equipos

            // Aplicar filtros por inicio de servicio, equipo, descripci√≥n, estado de actividad y estado de pruebas
            const listaFiltrada = listaBase.filter(reg => {
                // Filtro por estado
                if (filtroEstado && filtroEstado !== 'TODOS') {
                    const finTxt = (reg.terminacionServicio || '').toString().trim();
                    let estado = 'ABIERTO';
                    if (finTxt) {
                        estado = reg.terminacionEsFinal ? 'FINAL' : 'PARCIAL';
                    }
                    if (estado !== filtroEstado) return false;
                }

                if (filtroInicioServicio) {
                    const ini = (reg.inicioServicio || '').toString();
                    if (!ini.startsWith(filtroInicioServicio)) return false;
                }

                if (filtroEquipo) {
                    const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                        ? reg.equipos
                        : (reg.equipo ? [reg.equipo] : []);
                    const matchEquipo = equiposArr.some(eq =>
                        (eq || '').toString().toLowerCase().includes(filtroEquipo)
                    );
                    if (!matchEquipo) return false;
                }

                if (filtroDescripcion) {
                    const descBase = (reg.descripcion || '').toString().toLowerCase();
                    const descPersist = (reg.equipoDescripcion || '').toString().toLowerCase();
                    const mapaDesc = (window.mapaDescripcionPorEquipoAdm || {});

                    let matchDesc = false;

                    if ((descPersist && descPersist.includes(filtroDescripcion)) ||
                        (descBase && descBase.includes(filtroDescripcion))) {
                        matchDesc = true;
                    } else {
                        const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                            ? reg.equipos
                            : (reg.equipo ? [reg.equipo] : []);
                        matchDesc = equiposArr.some(eq => {
                            const eqNorm = __normalizeEquipoAdm(eq);
                            const descInv = (mapaDesc[eqNorm] || '').toString().toLowerCase();
                            return descInv.includes(filtroDescripcion);
                        });
                    }

                    if (!matchDesc) return false;
                }

                // Filtro por estado de pruebas (utiliza el estado de CADA equipo asociado a la actividad)
                if (filtroPruebas && filtroPruebas !== 'TODOS') {
                    const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                        ? reg.equipos
                        : (reg.equipo ? [reg.equipo] : []);

                    const matchPruebas = equiposArr.some(eq => {
                        const info = mapaPruebasPorEquipo[eq] || { estadoUltima: 'SIN_PRUEBA' };
                        const estadoEq = info.estadoUltima || 'SIN_PRUEBA';
                        return estadoEq === filtroPruebas;
                    });

                    if (!matchPruebas) return false;
                }

                return true;
            });

            // Ordenar para agrupar visualmente, dando prioridad a actividades abiertas (sin terminaci√≥n)
            const listaOrdenada = [...listaFiltrada].sort((a, b) => {
                const estadoPeso = (reg) => {
                    const fin = (reg.terminacionServicio || '').toString().trim();
                    if (!fin) return 0; // abierta
                    return reg.terminacionEsFinal ? 2 : 1; // parcial (1) / final (2)
                };

                const ea = estadoPeso(a);
                const eb = estadoPeso(b);
                if (ea !== eb) return ea - eb;

                const iniA = parseFechaDdMmAa(a.inicioServicio || '');
                const iniB = parseFechaDdMmAa(b.inicioServicio || '');
                const ta = iniA ? iniA.getTime() : 0;
                const tb = iniB ? iniB.getTime() : 0;

                if (ordenInicioDir === 'asc' && ta !== tb) {
                    return ta - tb;
                }
                if (ordenInicioDir === 'desc' && ta !== tb) {
                    return tb - ta;
                }

                if (ordenEquipoDir) {
                    const eqA = (a.equipo || (Array.isArray(a.equipos) && a.equipos.length ? a.equipos[0] : '') || '').toString().toUpperCase();
                    const eqB = (b.equipo || (Array.isArray(b.equipos) && b.equipos.length ? b.equipos[0] : '') || '').toString().toUpperCase();
                    if (eqA !== eqB) {
                        if (ordenEquipoDir === 'asc') return eqA < eqB ? -1 : 1;
                        return eqA > eqB ? -1 : 1;
                    }
                }

                const ca = __normCliAdm(a.cliente || '');
                const cb = __normCliAdm(b.cliente || '');
                if (ca < cb) return -1;
                if (ca > cb) return 1;
                const aa = (a.areaCliente || '').toString().toUpperCase();
                const ab = (b.areaCliente || '').toString().toUpperCase();
                if (aa < ab) return -1;
                if (aa > ab) return 1;
                const ua = (a.ubicacion || '').toString().toUpperCase();
                const ub = (b.ubicacion || '').toString().toUpperCase();
                if (ua < ub) return -1;
                if (ua > ub) return 1;
                return 0;
            });

            let clienteActual = '';
            let areaActual = '';
            let ubicacionActual = '';

            listaOrdenada.forEach((reg) => {
                const id = reg.id;
                const cliente = reg.cliente || '';
                const clienteNorm = __normCliAdm(cliente);
                const area = reg.areaCliente || '';
                const ubicacion = reg.ubicacion || '';
                // Inicio y terminaci√≥n se guardan como texto dd/mm/aa
                const inicioTexto = reg.inicioServicio || '';
                // Si hay per√≠odos, usar su fin/tipo/d√≠as como fuente de verdad y no terminacionServicio.
                const infoPer = mapaPeriodos.get(id);
                const termTexto = infoPer?.ultimoFin ? infoPer.ultimoFin : (reg.terminacionServicio || '');
                const os = reg.os || '';
                const oc = reg.ordenSuministro || '';
                const estCot = reg.estCot || '';
                const factura = reg.factura || '';
                const precio = Number(reg.precio || 0);
                const descripcionBase = reg.descripcion || '';

                const equiposArr = Array.isArray(reg.equipos) && reg.equipos.length
                    ? reg.equipos
                    : (reg.equipo ? [reg.equipo] : []);

                const precioPorEquipo = equiposArr.length ? (precio / equiposArr.length) : precio;

                // Calcular d√≠as efectivos en servicio:
                // - Si hay terminaci√≥n, d√≠as entre inicio y terminaci√≥n (servicio cerrado).
                // - Si no hay terminaci√≥n, d√≠as entre inicio y hoy (servicio abierto).
                let dias = 0;
                if (infoPer && Number(infoPer.diasTotal || 0) > 0) {
                    dias = Number(infoPer.diasTotal || 0);
                } else {
                    const dInicio = parseFechaDdMmAa(inicioTexto);
                    const hoy = new Date();
                    const dHoyUtc = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), hoy.getUTCDate()));
                    const dFin = termTexto ? parseFechaDdMmAa(termTexto) : dHoyUtc;
                    if (dInicio && dFin) {
                        const diffMs = dFin.getTime() - dInicio.getTime();
                        const diffDias = Math.floor(diffMs / 86400000);
                        if (diffDias >= 0) dias = diffDias + 1; // inclusivo
                    }
                }

                const termInput = termTexto || '';
                const termReadOnly = !!(infoPer && infoPer.ultimoFin);
                const termTitle = termReadOnly ? 'Seg√∫n tabulador (actividadPeriodos)' : '';

                // Contar estado a nivel de actividad base
                {
                    const finTxt = (termTexto || '').toString().trim();
                    const esFinal = infoPer?.ultimoTipo ? (infoPer.ultimoTipo === 'FINAL') : (reg.terminacionEsFinal === true);
                    if (!finTxt) contarAbierto += 1; else if (esFinal) contarFinal += 1; else contarParcial += 1;
                    if (infoPer && infoPer.conflictoFinalIntermedio) contarConflicto += 1;
                }

                equiposArr.forEach(equipoNombre => {
                    const mapaDesc = (window.mapaDescripcionPorEquipoAdm || {});
                    const eqNorm = __normalizeEquipoAdm(equipoNombre);
                    const equipoMostrar = eqNorm || equipoNombre;
                    const descPersist = (reg.equipoDescripcion || '').toString();
                    const descEfectiva = descPersist || descripcionBase || mapaDesc[eqNorm] || '';
                    const esTerceroReg = ((reg.tipo || '').toString().toUpperCase() === 'TERCERO');
                    const terceroProp = (reg.terceroPropiedad || '').toString();
                    const terceroDesc = (reg.terceroDescripcion || '').toString();
                    const textoBuscar = `${cliente} ${area} ${ubicacion} ${equipoMostrar} ${descEfectiva} ${os} ${oc} ${estCot} ${factura} ${terceroProp} ${terceroDesc}`.toLowerCase();
                    if (filtro && !textoBuscar.includes(filtro)) {
                        return;
                    }

                    visibles += 1;
                    // Acumular por cliente/√°rea el total de equipos visibles (cliente normalizado)
                    const key = `${clienteNorm}|||${area}`;
                    equiposPorClienteArea.set(key, (equiposPorClienteArea.get(key) || 0) + 1);

                    const ingresoEquipo = precioPorEquipo * (dias || 0);
                    totalRentas += ingresoEquipo;

                    // Clasificar por estado de actividad base (abierto/parcial/final)
                    const finTxtBase = (termTexto || '').toString().trim();
                    const esFinalBase = infoPer?.ultimoTipo ? (infoPer.ultimoTipo === 'FINAL') : (reg.terminacionEsFinal === true);
                    if (!finTxtBase) {
                        totalAbiertos += ingresoEquipo;
                        if (ingresoEquipo > 0) listAbiertos.push({ id, cliente, area, ubicacion, equipo: equipoMostrar, inicio: inicioTexto, terminacion: termTexto, dias, precio: precioPorEquipo, ingreso: ingresoEquipo });
                    } else if (esFinalBase) {
                        totalCerrados += ingresoEquipo;
                        if (ingresoEquipo > 0) listCerrados.push({ id, cliente, area, ubicacion, equipo: equipoMostrar, inicio: inicioTexto, terminacion: termTexto, dias, precio: precioPorEquipo, ingreso: ingresoEquipo });
                    } else {
                        totalParciales += ingresoEquipo;
                        if (ingresoEquipo > 0) listParciales.push({ id, cliente, area, ubicacion, equipo: equipoMostrar, inicio: inicioTexto, terminacion: termTexto, dias, precio: precioPorEquipo, ingreso: ingresoEquipo });
                    }
                    if (ingresoEquipo > 0) listRentas.push({ id, cliente, area, ubicacion, equipo: equipoMostrar, inicio: inicioTexto, terminacion: termTexto, dias, precio: precioPorEquipo, ingreso: ingresoEquipo });

                    if (precioPorEquipo > 0) {
                        sumaPrecios += precioPorEquipo;
                        cuentaPrecios += 1;
                    }

                    // Insertar encabezados de agrupaci√≥n por cliente, √°rea y ubicaci√≥n cuando cambien
                    if (clienteNorm && clienteNorm !== clienteActual) {
                        clienteActual = clienteNorm;
                        areaActual = '';
                        const trGrupoCliente = document.createElement('tr');
                        const etiquetaGrupo = esTerceroReg ? `TERCERO: ${terceroProp || clienteActual}` : `CLIENTE: ${clienteActual}`;
                        trGrupoCliente.innerHTML = `
                            <td colspan="15" style="padding:0.5rem 0.75rem; background:#111827; font-weight:700; font-size:0.9rem; color:#f9fafb; border-top:2px solid #0f172a; border-bottom:1px solid #0f172a; text-transform:uppercase; letter-spacing:0.03em;">
                                ${etiquetaGrupo}
                            </td>
                        `;
                        tbody.appendChild(trGrupoCliente);
                    }

                    if (area && area !== areaActual) {
                        areaActual = area;
                        ubicacionActual = '';
                        const trGrupoArea = document.createElement('tr');
                        trGrupoArea.innerHTML = `
                            <td colspan="15" style="padding:0.4rem 0.75rem; background:#e5e7eb; font-weight:600; font-size:0.85rem; color:#111827; border-bottom:1px solid #cbd5e1; display:flex; align-items:center; gap:0.5rem; text-transform:uppercase; letter-spacing:0.02em;">
                                <input type="checkbox" class="adm-select-area" data-cliente="${clienteNorm}" data-area="${areaActual}" title="Seleccionar √°rea completa">
                                <span class="adm-area-title" data-cliente="${clienteNorm}" data-area="${areaActual}" title="Click para renombrar √°rea">√Årea: ${areaActual}</span>
                            </td>
                        `;
                        tbody.appendChild(trGrupoArea);
                    }

                    if (ubicacion && ubicacion !== ubicacionActual) {
                        ubicacionActual = ubicacion;
                        const trGrupoUbic = document.createElement('tr');
                        trGrupoUbic.innerHTML = `
                            <td colspan="15" style="padding:0.3rem 0.9rem; background:#f9fafb; font-weight:500; font-size:0.8rem; color:#4b5563; border-bottom:1px solid #e5e7eb; border-left:4px solid #9ca3af; display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" class="adm-select-ubic" data-cliente="${clienteNorm}" data-area="${areaActual}" data-ubicacion="${ubicacionActual}" title="Seleccionar ubicaci√≥n completa">
                                <span>Ubicaci√≥n: ${ubicacionActual}</span>
                            </td>
                        `;
                        tbody.appendChild(trGrupoUbic);
                    }

                    const tr = document.createElement('tr');

                    const infoPruebas = mapaPruebasPorEquipo[eqNorm] || { estadoUltima: 'SIN_PRUEBA' };
                    const estadoPruebas = infoPruebas.estadoUltima || 'SIN_PRUEBA';
                    const badgePruebas =
                        estadoPruebas === 'VIGENTE'
                            ? '<span style="padding:0.1rem 0.5rem; border-radius:999px; background:#dcfce7; color:#166534; font-size:0.7rem; font-weight:600;">Vigente</span>'
                            : estadoPruebas === 'VENCIDA'
                                ? '<span style="padding:0.1rem 0.5rem; border-radius:999px; background:#fee2e2; color:#b91c1c; font-size:0.7rem; font-weight:600;">Vencida</span>'
                                : '<span style="padding:0.1rem 0.5rem; border-radius:999px; background:#e5e7eb; color:#4b5563; font-size:0.7rem; font-weight:600;">Sin prueba</span>';

                    const descCellHtml = esTerceroReg
                        ? `${descEfectiva ? descEfectiva : ''}<div style="color:#6b7280; font-size:0.75rem; line-height:1.1; margin-top:2px;">Propiedad: ${terceroProp}${terceroDesc ? ` ¬∑ ${terceroDesc}` : ''}</div>`
                        : `${descEfectiva}`;

                    tr.innerHTML = `
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:center;">
                            <input type="checkbox" class="adm-select-fila" data-id="${id}" data-cliente="${cliente}" data-area="${area}" data-ubicacion="${ubicacion}">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${cliente}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${area}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${ubicacion}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left;">
                            ${equipoMostrar}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap;">
                            ${badgePruebas}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:left; max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${descCellHtml}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <input type="text" class="adm-input-inicio" data-id="${id}" value="${inicioTexto}" placeholder="dd/mm/aa" maxlength="8" style="font-size:0.8rem; width:80px;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <input type="text" class="adm-input-term" data-id="${id}" value="${termInput}" placeholder="dd/mm/aa" maxlength="8" ${termReadOnly ? 'readonly' : ''} title="${termTitle}" style="font-size:0.8rem; width:80px; ${termReadOnly ? 'background:#f3f4f6; color:#111827;' : ''}">
                            ${(() => {
                                const finTxt = termTexto.trim();
                                if (!finTxt) {
                                    // ABIERTO: sin fecha de terminaci√≥n, color naranja (alerta)
                                    return '<span style="margin-left:0.35rem; font-size:0.7rem; font-weight:600; color:#ea580c;">ABIERTO</span>';
                                }
                                const esFinal = infoPer?.ultimoTipo ? (infoPer.ultimoTipo === 'FINAL') : (reg.terminacionEsFinal === true);
                                // FINAL en rojo, PARCIAL en verde
                                const color = esFinal ? '#b91c1c' : '#16a34a';
                                const label = esFinal ? 'FINAL' : 'PARCIAL';
                                const conf = (infoPer && infoPer.conflictoFinalIntermedio) ? '<span title="Hay per√≠odos despu√©s de un FINAL o FINAL intermedio" style="margin-left:0.35rem; font-size:0.7rem; font-weight:700; color:#b45309;">CONFLICTO</span>' : '';
                                return `<span style="margin-left:0.35rem; font-size:0.7rem; font-weight:600; color:${color};">${label}</span>${conf}`;
                            })()}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:center;">
                            ${dias || ''}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:center;">
                            <input type="number" min="0" step="1" class="adm-input-precio" data-id="${id}"
                                   value="${precio || ''}" style="width:80px; font-size:0.8rem; text-align:center;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:center;">
                            ${ingresoEquipo ? formatearMoneda(ingresoEquipo) : ''}
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:center;">
                            <input type="text" class="adm-input-os" data-id="${id}" value="${os || ''}" style="font-size:0.8rem; width:110px; text-align:center;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:center;">
                            <input type="text" class="adm-input-oc" data-id="${id}" value="${oc || ''}" style="font-size:0.8rem; width:110px; text-align:center;">
                        </td>
                        <td style=\"padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:center;\">
                            <input type=\"text\" class=\"adm-input-estcot\" data-id=\"${id}\" value=\"${estCot || ''}\" style=\"font-size:0.8rem; width:110px; text-align:center;\">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:center;">
                            <input type="text" class="adm-input-factura" data-id="${id}" value="${factura || ''}" style="font-size:0.8rem; width:110px; text-align:center;">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap; text-align:left;">
                            <button type="button" class="adm-btn-eliminar" data-id="${id}" style="font-size:0.75rem; color:#b91c1c;">
                                Eliminar
                            </button>
                        </td>
                    `;

                    // Guardar datos necesarios para el tabulador en el <tr>, para abrirlo al hacer clic en la fila
                    tr.setAttribute('data-id', id);
                    tr.setAttribute('data-cliente', clienteNorm);
                    tr.setAttribute('data-area', area);
                    tr.setAttribute('data-ubicacion', ubicacion);
                    tr.setAttribute('data-equipo', equipoNombre);
                    tr.setAttribute('data-precioequipo', String(precioPorEquipo));
                    tr.setAttribute('data-os', os);
                    tr.setAttribute('data-inicio', inicioTexto);
                    tr.setAttribute('data-terminacion', termTexto);

                    tbody.appendChild(tr);
                });
            });

            const inputFechaLote = document.getElementById('adm-lote-fecha');
            if (inputFechaLote) {
                inputFechaLote.addEventListener('input', () => {
                    inputFechaLote.value = formatearFechaDdMmAaInput(inputFechaLote.value);
                });
            }

            const btnAplicarFecha = document.getElementById('adm-aplicar-fecha-lote');
            if (btnAplicarFecha) {
                btnAplicarFecha.addEventListener('click', async () => {
                    if (!(window.isAdmin || window.isDirector)) { alert('Solo admin o director pueden aplicar cambios en lote.'); return; }
                    const fechaStr = (document.getElementById('adm-lote-fecha')?.value || '').trim();
                    const tipo = (document.getElementById('adm-lote-tipo')?.value || 'PARCIAL').toString().toUpperCase();
                    if (!fechaStr) { alert('Indica una fecha (dd/mm/aa).'); return; }
                    const d = parseFechaDdMmAa(fechaStr);
                    if (!d) { alert('Formato de fecha inv√°lido. Usa dd/mm/aa'); return; }

                    const seleccionados = Array.from(tbody.querySelectorAll('.adm-select-fila:checked'));
                    if (!seleccionados.length) { alert('Selecciona al menos una fila.'); return; }

                    try {
                        const { getFirestore, doc, writeBatch, collection, query, where, getDocs, addDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                        const db = getFirestore();
                        let batch = writeBatch(db);
                        let count = 0;
                        const esFinal = (tipo === 'FINAL');
                        for (const chk of seleccionados) {
                            const id = chk.getAttribute('data-id');
                            if (!id) continue;
                            const ref = doc(db, 'actividades', id);
                            batch.update(ref, { terminacionServicio: fechaStr, terminacionEsFinal: esFinal });
                            count++;
                            if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db); }
                        }
                        await batch.commit();

                        seleccionados.forEach(chk => {
                            const id = chk.getAttribute('data-id');
                            const reg = listaActividad.find(r => r.id === id);
                            if (reg) { reg.terminacionServicio = fechaStr; reg.terminacionEsFinal = esFinal; }
                        });

                        // Generar per√≠odos intermedios seg√∫n reglas: Halliburton -> d√≠a 25, otros -> fin de mes.
                        for (const chk of seleccionados) {
                            const tr = chk.closest('tr');
                            const id = chk.getAttribute('data-id');
                            if (!id || !tr) continue;
                            const cliente = (tr.getAttribute('data-cliente') || '').toString().toUpperCase();
                            const tarifaDiaria = Number(tr.getAttribute('data-precioequipo') || 0) || 0;

                            const objetivoFin = parseFechaDdMmAa(fechaStr);
                            if (!objetivoFin) continue;

                            const colPer = collection(db, 'actividadPeriodos');
                            const qPer = query(colPer, where('actividadId', '==', id));
                            const snapPer = await getDocs(qPer);
                            const periodos = snapPer.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
                            const existente = new Set(periodos.map(p => `${(p.inicioPeriodo||'').trim()}|${(p.finPeriodo||'').trim()}`));

                            function parseDdMmAa(str){ return parseFechaDdMmAa(str) || null; }
                            function fmt(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const aa=String(d.getFullYear()%100).padStart(2,'0'); return `${dd}/${mm}/${aa}`; }
                            function eom(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
                            function day25(d){ return new Date(d.getFullYear(), d.getMonth(), 25); }
                            function nextDay(d){ const n=new Date(d.getFullYear(), d.getMonth(), d.getDate()); n.setDate(n.getDate()+1); return n; }

                            // Punto de inicio: d√≠a siguiente al √∫ltimo finPeriodo; si no hay, usar inicioServicio del <tr>
                            let inicioStr = (tr.getAttribute('data-inicio') || '').toString();
                            if (periodos.length) {
                                const ult = periodos
                                    .filter(p => (p.finPeriodo || '').toString().trim())
                                    .sort((a,b) => {
                                        const da = parseDdMmAa(a.finPeriodo || '') || new Date(2000,0,1);
                                        const dbb = parseDdMmAa(b.finPeriodo || '') || new Date(2000,0,1);
                                        return da.getTime() - dbb.getTime();
                                    })
                                    .pop();
                                if (ult && (ult.finPeriodo || '').toString().trim()) {
                                    const df = parseDdMmAa(ult.finPeriodo || '');
                                    if (df) inicioStr = fmt(nextDay(df));
                                }
                            }

                            let cursorIni = parseDdMmAa(inicioStr);
                            if (!cursorIni) continue;

                            const esHalliburton = cliente.includes('HALLIBURTON');
                            const cortes = [];

                            // Construir cortes mensuales intermedios hasta alcanzar objetivo
                            while (cursorIni.getTime() <= objetivoFin.getTime()) {
                                let corte;
                                if (esHalliburton) {
                                    const d25 = day25(cursorIni);
                                    // si el 25 es anterior al inicio, usar 25 del mes siguiente
                                    if (d25.getTime() < cursorIni.getTime()) {
                                        const nextMonth = new Date(cursorIni.getFullYear(), cursorIni.getMonth()+1, 1);
                                        corte = day25(nextMonth);
                                    } else {
                                        corte = d25;
                                    }
                                } else {
                                    let end = eom(cursorIni);
                                    if (end.getTime() < cursorIni.getTime()) {
                                        end = eom(new Date(cursorIni.getFullYear(), cursorIni.getMonth()+1, 1));
                                    }
                                    corte = end;
                                }

                                // Si el corte supera el objetivoFinal, para PARCIAL dejamos el √∫ltimo corte exactamente en la fecha objetivo.
                                // Para FINAL, generamos cortes parciales hasta el mes anterior y cerramos con FINAL al objetivo.
                                const esUltimo = (corte.getTime() >= objetivoFin.getTime());
                                const finPeriodo = esUltimo ? objetivoFin : corte;

                                // Evitar per√≠odos vac√≠os
                                if (finPeriodo.getTime() >= cursorIni.getTime()) {
                                    const dias = Math.floor((new Date(finPeriodo.getFullYear(), finPeriodo.getMonth(), finPeriodo.getDate()) - new Date(cursorIni.getFullYear(), cursorIni.getMonth(), cursorIni.getDate())) / 86400000) + 1;
                                    const importe = (dias > 0 && tarifaDiaria) ? dias * tarifaDiaria : 0;
                                    const inicioStrC = fmt(cursorIni);
                                    const finStrC = fmt(finPeriodo);
                                    const key = `${inicioStrC}|${finStrC}`;
                                    if (!existente.has(key)) {
                                        cortes.push({
                                            inicioPeriodo: inicioStrC,
                                            finPeriodo: finStrC,
                                            inicioPeriodoOrdenable: new Date(cursorIni.getFullYear(), cursorIni.getMonth(), cursorIni.getDate()).getTime(),
                                            diasFacturados: dias,
                                            tarifaDiaria,
                                            importe,
                                            tipoPeriodo: (esUltimo && esFinal) ? 'FINAL' : 'PARCIAL',
                                        });
                                        existente.add(key);
                                    }
                                }

                                if (esUltimo) break;
                                // siguiente cursor es d√≠a siguiente al corte
                                cursorIni = nextDay(corte);
                            }

                            // Escribir cortes calculados
                            for (const c of cortes) {
                                const inicioKey = (c.inicioPeriodo || '').replaceAll('/', '-');
                                const finKey = (c.finPeriodo || '').replaceAll('/', '-');
                                const periodId = `${id}__${inicioKey}__${finKey}`;
                                await setDoc(doc(colPer, periodId), {
                                    actividadId: id,
                                    ...c,
                                    factura: '',
                                    oc: '',
                                    observaciones: '',
                                    creadoEn: serverTimestamp(),
                                });
                            }

                            try {
                                if (typeof window.pctAudit === 'function') {
                                    await window.pctAudit('actividadmin_generar_periodos_por_terminacion', { actividadId: id, count: cortes.length, terminacionServicio: fechaStr, terminacionEsFinal: esFinal }, { throttleKey: `actividadmin_generar_periodos_por_terminacion_${id}_${fechaStr}` });
                                }
                            } catch {}
                        }
                    } catch (e) {
                        console.error('Error aplicando terminaci√≥n en lote', e);
                        alert('No se pudo aplicar la terminaci√≥n en lote. Intenta de nuevo.');
                    }
                });
            }

            // Aplicar PRECIO en lote a selecci√≥n (solo admin/director)
            const btnAplicarPrecio = document.getElementById('adm-aplicar-precio-lote');
            if (btnAplicarPrecio) {
                btnAplicarPrecio.addEventListener('click', async () => {
                    if (!(window.isAdmin || window.isDirector)) { alert('Solo admin o director pueden aplicar cambios en lote.'); return; }
                    const valStr = (document.getElementById('adm-lote-precio')?.value || '').trim();
                    if (valStr === '') { alert('Indica un precio para aplicar.'); return; }
                    const valorNum = Number(valStr);
                    if (!isFinite(valorNum) || valorNum < 0) { alert('Indica un precio v√°lido (n√∫mero no negativo).'); return; }

                    const seleccionados = Array.from(tbody.querySelectorAll('.adm-select-fila:checked'));
                    if (!seleccionados.length) { alert('Selecciona al menos una fila.'); return; }

                    try {
                        const { getFirestore, doc, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                        const db = getFirestore();
                        let batch = writeBatch(db);
                        let count = 0;
                        for (const chk of seleccionados) {
                            const id = chk.getAttribute('data-id');
                            if (!id) continue;
                            const ref = doc(db, 'actividades', id);
                            batch.update(ref, { precio: valorNum });
                            count++;
                            if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db); }
                        }
                        await batch.commit();

                        // Actualizar modelo local
                        seleccionados.forEach(chk => {
                            const id = chk.getAttribute('data-id');
                            const reg = listaActividad.find(r => r.id === id);
                            if (reg) reg.precio = valorNum;
                        });

                        try {
                            if (typeof window.pctAudit === 'function') {
                                await window.pctAudit('actividadmin_bulk_update_precio', { count, precio: valorNum }, { throttleKey: `actividadmin_bulk_update_precio_${valorNum}` });
                            }
                        } catch {}
                        renderTabla();
                    } catch (e) {
                        console.error('Error aplicando precio en lote', e);
                        alert('No se pudo aplicar el precio en lote. Intenta de nuevo.');
                    }
                });
            }

            // Aplicar OS/OC/Est-Cot/Factura en lote a selecci√≥n (solo admin/director)
            const btnAplicarCampos = document.getElementById('adm-aplicar-campos-lote');
            if (btnAplicarCampos) {
                btnAplicarCampos.addEventListener('click', async () => {
                    if (!(window.isAdmin || window.isDirector)) { alert('Solo admin o director pueden aplicar cambios en lote.'); return; }
                    const osVal = (document.getElementById('adm-lote-os')?.value || '').trim();
                    const ocVal = (document.getElementById('adm-lote-oc')?.value || '').trim();
                    const estCotVal = (document.getElementById('adm-lote-estcot')?.value || '').trim();
                    const facturaVal = (document.getElementById('adm-lote-factura')?.value || '').trim();

                    const updates = {};
                    if (osVal !== '') updates.os = osVal;
                    if (ocVal !== '') updates.ordenSuministro = ocVal;
                    if (estCotVal !== '') updates.estCot = estCotVal;
                    if (facturaVal !== '') updates.factura = facturaVal;

                    if (!Object.keys(updates).length) { alert('Indica al menos un campo (OS, OC, Est-Cot o Factura) para aplicar.'); return; }

                    const seleccionados = Array.from(tbody.querySelectorAll('.adm-select-fila:checked'));
                    if (!seleccionados.length) { alert('Selecciona al menos una fila.'); return; }

                    try {
                        const { getFirestore, doc, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                        const db = getFirestore();
                        let batch = writeBatch(db);
                        let count = 0;
                        for (const chk of seleccionados) {
                            const id = chk.getAttribute('data-id');
                            if (!id) continue;
                            const ref = doc(db, 'actividades', id);
                            batch.update(ref, updates);
                            count++;
                            if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db); }
                        }
                        await batch.commit();

                        // Actualizar modelo local
                        seleccionados.forEach(chk => {
                            const id = chk.getAttribute('data-id');
                            const reg = listaActividad.find(r => r.id === id);
                            if (!reg) return;
                            if (updates.os !== undefined) reg.os = updates.os;
                            if (updates.ordenSuministro !== undefined) reg.ordenSuministro = updates.ordenSuministro;
                            if (updates.estCot !== undefined) reg.estCot = updates.estCot;
                            if (updates.factura !== undefined) reg.factura = updates.factura;
                        });

                        renderTabla();
                    } catch (e) {
                        console.error('Error aplicando cambios en lote', e);
                        alert('No se pudieron aplicar los cambios en lote. Intenta de nuevo.');
                    }
                });
            }

            lblCont.textContent = `${visibles} registro${visibles === 1 ? '' : 's'}`;
            if (spanCerrados) spanCerrados.textContent = formatearMoneda(totalCerrados);
            if (spanAbiertos) spanAbiertos.textContent = formatearMoneda(totalAbiertos);
            if (spanParciales) spanParciales.textContent = formatearMoneda(totalParciales);
            if (spanRentas) spanRentas.textContent = formatearMoneda(totalRentas);
            if (spanEstAbierto) spanEstAbierto.textContent = String(contarAbierto);
            if (spanEstParcial) spanEstParcial.textContent = String(contarParcial);
            if (spanEstFinal) spanEstFinal.textContent = String(contarFinal);
            if (spanEstConflicto) spanEstConflicto.textContent = String(contarConflicto);

            // Exponer √∫ltimas listas para el modal
            window.__admLastLists = {
                ABIERTOS: listAbiertos,
                PARCIALES: listParciales,
                CERRADOS: listCerrados,
                RENTAS: listRentas,
            };

            // Wire bot√≥n aplicar rango (una vez)
            if (!window.__admRangoBtnWired) {
                const btnR = document.getElementById('adm-aplicar-rango');
                if (btnR) btnR.addEventListener('click', () => renderTabla());
                window.__admRangoBtnWired = true;
            }

            // Wire click en filas de resumen para abrir modal (una vez)
            if (!window.__admResumenClicksWired) {
                document.querySelectorAll('.dash-stats .dash-stat-row[data-cat]').forEach(row => {
                    row.addEventListener('click', () => {
                        const cat = row.getAttribute('data-cat');
                        mostrarModalLista(cat);
                    });
                });
                window.__admResumenClicksWired = true;
            }

            // Render Cliente / √Årea con totales
            if (caList) {
                const pares = Array.from(equiposPorClienteArea.entries())
                    .map(([k,v])=>{ const [c,a] = k.split('|||'); return { cliente:c||'', area:a||'', total:v }; })
                    .sort((x,y)=> (x.cliente||'').localeCompare(y.cliente||'') || (x.area||'').localeCompare(y.area||''));
                caList.innerHTML = pares.map(p=>
                    `<div class="dash-stat-row"><span class="row-left">${p.cliente} / ${p.area}</span><span class="badge gray">${p.total}</span></div>`
                ).join('');
            }

            // Autoformato dd/mm/aa y guardado autom√°tico en los inputs de inicio y terminaci√≥n

            // INICIO DEL SERVICIO
            tbody.querySelectorAll('.adm-input-inicio').forEach(input => {
                input.addEventListener('input', () => {
                    const formateada = formatearFechaDdMmAaInput(input.value);
                    input.value = formateada;
                });

                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    if (!valor) {
                        // No permitimos dejar inicio en blanco; restaurar valor previo
                        input.value = regLocal.inicioServicio || '';
                        return;
                    }

                    const d = parseFechaDdMmAa(valor);
                    if (!d) {
                        alert('Formato de fecha de inicio inv√°lido. Usa dd/mm/aa');
                        input.value = regLocal.inicioServicio || '';
                        return;
                    }

                    regLocal.inicioServicio = valor;
                    await actualizarActividadEnFirestore(id, { inicioServicio: valor });
                    renderTabla();
                });
            });

            // Renombrar √°rea desde el encabezado del grupo (solo admin)
            tbody.addEventListener('click', async (ev) => {
                const el = ev.target.closest('.adm-area-title');
                if (!el) return;
                if (!(window.isAdmin)) { alert('Solo administradores pueden renombrar √°reas.'); return; }
                const cliente = (el.getAttribute('data-cliente') || '').toString();
                const areaOld = (el.getAttribute('data-area') || '').toString();
                const nuevo = window.prompt('Nuevo nombre de √°rea:', areaOld);
                if (!nuevo) return;
                const areaNew = String(nuevo).trim().toUpperCase();
                if (!areaNew || areaNew === areaOld.toUpperCase()) return;

                // Filas del √°rea actual visibles
                const filas = Array.from(tbody.querySelectorAll('.adm-select-fila'))
                    .filter(chk => (chk.getAttribute('data-cliente') || '').toString() === cliente
                                 && (chk.getAttribute('data-area') || '').toString().toUpperCase() === areaOld.toUpperCase());
                if (!filas.length) { alert('No se encontraron filas para esta √°rea.'); return; }
                if (!confirm(`Renombrar √°rea '${areaOld}' a '${areaNew}' en ${filas.length} registro(s)?`)) return;

                // Persistir cambios
                const ops = filas.map(chk => {
                    const id = chk.getAttribute('data-id') || '';
                    if (!id) return Promise.resolve();
                    return actualizarActividadEnFirestore(id, { areaCliente: areaNew });
                });
                await Promise.allSettled(ops);
                // Re-render para reagrupar
                renderTabla();
            });

            // TERMINACI√ìN DEL SERVICIO
            tbody.querySelectorAll('.adm-input-term').forEach(input => {
                input.addEventListener('input', () => {
                    const formateada = formatearFechaDdMmAaInput(input.value);
                    input.value = formateada;
                });

                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    if (!valor) {
                        // Quitar terminaci√≥n
                        delete regLocal.terminacionServicio;
                        delete regLocal.terminacionEsFinal;
                        await actualizarActividadEnFirestore(id, { terminacionServicio: '', terminacionEsFinal: false });
                        renderTabla();
                        return;
                    }

                    const d = parseFechaDdMmAa(valor);
                    if (!d) {
                        alert('Formato de fecha inv√°lido. Usa dd/mm/aa');
                        // restaurar valor previo si lo hubiera
                        input.value = regLocal.terminacionServicio || '';
                        return;
                    }

                    regLocal.terminacionServicio = valor;
                    // Editar desde esta vista se considera, por defecto, un fin PARCIAL (no definitivo)
                    regLocal.terminacionEsFinal = false;
                    await actualizarActividadEnFirestore(id, { terminacionServicio: valor, terminacionEsFinal: false });
                    renderTabla();
                });
            });

            // Guardado autom√°tico en blur para precio
            tbody.querySelectorAll('.adm-input-precio').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valorNum = Number(input.value || 0);
                    if (isNaN(valorNum) || valorNum < 0) {
                        alert('Indica un precio v√°lido.');
                        const regLocalPrev = listaActividad.find(r => r.id === id);
                        input.value = regLocalPrev && typeof regLocalPrev.precio === 'number' ? regLocalPrev.precio : '';
                        return;
                    }

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.precio = valorNum;
                    await actualizarActividadEnFirestore(id, { precio: valorNum });
                    renderTabla();
                });
            });

            // Guardado autom√°tico en blur para OC (orden de compra / suministro) a nivel de actividad
            tbody.querySelectorAll('.adm-input-oc').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.ordenSuministro = valor;
                    await actualizarActividadEnFirestore(id, { ordenSuministro: valor });
                });
            });

            // Guardado autom√°tico en blur para OS
            tbody.querySelectorAll('.adm-input-os').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.os = valor;
                    await actualizarActividadEnFirestore(id, { os: valor });
                });
            });

            // Guardado autom√°tico en blur para Est-Cot
            tbody.querySelectorAll('.adm-input-estcot').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.estCot = valor;
                    await actualizarActividadEnFirestore(id, { estCot: valor });
                });
            });

            // Guardado autom√°tico en blur para Factura
            tbody.querySelectorAll('.adm-input-factura').forEach(input => {
                input.addEventListener('blur', async () => {
                    const id = input.getAttribute('data-id');
                    if (!id) return;

                    const valor = (input.value || '').trim();

                    const regLocal = listaActividad.find(r => r.id === id);
                    if (!regLocal) return;

                    regLocal.factura = valor;
                    await actualizarActividadEnFirestore(id, { factura: valor });
                });
            });

            tbody.querySelectorAll('.adm-btn-eliminar').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (!id) return;

                    if (!confirm('¬øEliminar esta actividad? Esta acci√≥n no se puede deshacer.')) return;

                    try {
                        const { getFirestore, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                        const db = getFirestore();
                        const ref = doc(db, 'actividades', id);
                        await deleteDoc(ref);

                        try {
                            if (typeof window.pctAudit === 'function') {
                                await window.pctAudit('actividadmin_delete_actividad', { actividadId: id }, { throttleKey: `actividadmin_delete_actividad_${id}` });
                            }
                        } catch {}

                        listaActividad = listaActividad.filter(r => r.id !== id);
                        renderTabla();
                    } catch (e) {
                        console.error('Error al eliminar actividad en Firestore', e);
                    }
                });
            });
            // L√≥gica de selecci√≥n m√∫ltiple (checkbox maestro y por √°rea)
            const chkTodos = document.getElementById('adm-select-todos');
            if (chkTodos) {
                chkTodos.checked = false;
                chkTodos.addEventListener('change', () => {
                    const filas = tbody.querySelectorAll('.adm-select-fila');
                    filas.forEach(chk => {
                        chk.checked = chkTodos.checked;
                    });

                    // Sincronizar checkboxes de √°rea
                    const areas = tbody.querySelectorAll('.adm-select-area');
                    areas.forEach(chkArea => {
                        chkArea.checked = chkTodos.checked;
                    });
                });
            }

            // L√≥gica de selecci√≥n por √°rea
            tbody.querySelectorAll('.adm-select-area').forEach(chkArea => {
                chkArea.addEventListener('change', () => {
                    const area = chkArea.getAttribute('data-area') || '';
                    const cliente = chkArea.getAttribute('data-cliente') || '';

                    const filasArea = tbody.querySelectorAll(`.adm-select-fila[data-area="${area}"][data-cliente="${cliente}"]`);
                    filasArea.forEach(chkFila => {
                        chkFila.checked = chkArea.checked;
                    });

                    // Actualizar estado del checkbox maestro
                    const todasFilas = tbody.querySelectorAll('.adm-select-fila');
                    const todasMarcadas = todasFilas.length > 0 && Array.from(todasFilas).every(chk => chk.checked);
                    if (chkTodos) {
                        chkTodos.checked = todasMarcadas;
                    }
                });
            });

            // L√≥gica de selecci√≥n por ubicaci√≥n
            tbody.querySelectorAll('.adm-select-ubic').forEach(chkUbic => {
                chkUbic.addEventListener('change', () => {
                    const ubic = chkUbic.getAttribute('data-ubicacion') || '';
                    const area = chkUbic.getAttribute('data-area') || '';
                    const cliente = chkUbic.getAttribute('data-cliente') || '';

                    // Marcar / desmarcar todas las filas de esa ubicaci√≥n dentro del cliente/√°rea
                    const filasUbic = tbody.querySelectorAll(
                        `.adm-select-fila[data-cliente="${cliente}"][data-area="${area}"][data-ubicacion="${ubic}"]`
                    );
                    filasUbic.forEach(chkFila => {
                        chkFila.checked = chkUbic.checked;
                    });

                    // Sincronizar checkbox de √°rea: marcada si todas las filas del √°rea est√°n marcadas
                    const filasArea = tbody.querySelectorAll(
                        `.adm-select-fila[data-cliente="${cliente}"][data-area="${area}"]`
                    );
                    const todasAreaMarcadas =
                        filasArea.length > 0 && Array.from(filasArea).every(chk => chk.checked);

                    const chkArea = tbody.querySelector(
                        `.adm-select-area[data-cliente="${cliente}"][data-area="${area}"]`
                    );
                    if (chkArea) {
                        chkArea.checked = todasAreaMarcadas;
                    }

                    // Actualizar estado del checkbox maestro
                    const todasFilas = tbody.querySelectorAll('.adm-select-fila');
                    const todasMarcadas =
                        todasFilas.length > 0 && Array.from(todasFilas).every(chk => chk.checked);
                    if (chkTodos) {
                        chkTodos.checked = todasMarcadas;
                    }
                });
            });

            const inputFiltroInicio = document.getElementById('adm-filtro-inicio');
            if (inputFiltroInicio) {
                inputFiltroInicio.addEventListener('input', () => {
                    const soloDigitos = (inputFiltroInicio.value || '').replace(/\D/g, '').slice(0, 6);
                    let formateado = soloDigitos;
                    if (soloDigitos.length >= 3 && soloDigitos.length <= 4) {
                        formateado = soloDigitos.slice(0, 2) + '/' + soloDigitos.slice(2);
                    } else if (soloDigitos.length >= 5) {
                        formateado =
                            soloDigitos.slice(0, 2) +
                            '/' +
                            soloDigitos.slice(2, 4) +
                            '/' +
                            soloDigitos.slice(4);
                    }
                    inputFiltroInicio.value = formateado;
                    filtroInicioServicio = formateado.trim();
                    renderTabla();
                });
            }

            const inputFiltroEquipo = document.getElementById('adm-filtro-equipo');
            if (inputFiltroEquipo) {
                inputFiltroEquipo.addEventListener('input', () => {
                    filtroEquipo = (inputFiltroEquipo.value || '').toLowerCase().trim();
                    renderTabla();
                });
            }

            const inputFiltroDescripcion = document.getElementById('adm-filtro-descripcion');
            if (inputFiltroDescripcion) {
                inputFiltroDescripcion.addEventListener('input', () => {
                    filtroDescripcion = (inputFiltroDescripcion.value || '').toLowerCase().trim();
                    renderTabla();
                });
            }

            const thInicio = document.getElementById('adm-th-inicio');
            if (thInicio) {
                thInicio.addEventListener('click', () => {
                    // Al ordenar por inicio, limpiar orden por equipo
                    ordenEquipoDir = null;
                    if (ordenInicioDir === 'asc') {
                        ordenInicioDir = 'desc';
                    } else if (ordenInicioDir === 'desc') {
                        ordenInicioDir = null; // sin orden especial, volver a agrupaci√≥n base
                    } else {
                        ordenInicioDir = 'asc';
                    }
                    renderTabla();
                });
            }

            const thEquipo = document.getElementById('adm-th-equipo');
            if (thEquipo) {
                thEquipo.addEventListener('click', () => {
                    // Al ordenar por equipo, limpiar orden por inicio
                    ordenInicioDir = null;
                    if (ordenEquipoDir === 'asc') {
                        ordenEquipoDir = 'desc';
                    } else if (ordenEquipoDir === 'desc') {
                        ordenEquipoDir = null;
                    } else {
                        ordenEquipoDir = 'asc';
                    }
                    renderTabla();
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputBuscar = document.getElementById('adm-buscar');
            if (inputBuscar) {
                inputBuscar.addEventListener('input', () => {
                    renderTabla();
                });
            }

            const btnAyuda = document.getElementById('adm-btn-ayuda');
            const panelAyuda = document.getElementById('adm-ayuda-panel');
            if (btnAyuda && panelAyuda) {
                btnAyuda.addEventListener('click', () => {
                    ayudaActiva = !ayudaActiva;
                    panelAyuda.style.display = ayudaActiva ? 'block' : 'none';
                    btnAyuda.textContent = ayudaActiva ? 'Ocultar ayuda' : 'Ver ayuda';
                });
            }

            // Bot√≥n Actualizar: fuerza lectura desde red bajo demanda
            const btnActualizar = document.getElementById('adm-btn-actualizar');
            if (btnActualizar) {
                btnActualizar.addEventListener('click', async () => {
                    try {
                        const { getFirestore, collection, getDocs, query, where, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                        const db = getFirestore();
                        const colRef = collection(db, 'actividades');
                        const currentYear = (new Date()).getFullYear();
                        const minYear = currentYear - 12;
                        const qIdx = query(
                            colRef,
                            where('anioInicio', '>=', minYear),
                            orderBy('anioInicio', 'asc'),
                            orderBy('inicioTs', 'desc'),
                            limit(300)
                        );
                        const snapNet = await getDocs(qIdx);
                        if (snapNet && !snapNet.empty) {
                            listaActividad = snapNet.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderTabla();
                        }
                    } catch (e) {
                        console.warn('No se pudo forzar actualizaci√≥n desde servidor', e);
                    }
                });
            }

            // Cargar primero el resumen de pruebas por equipo y luego las actividades
            cargarPruebasResumenPorEquipo()
                .catch(() => {})
                .finally(() => {
                    cargarActividadDesdeFirestore();
                });
            // Exponer funci√≥n de migraci√≥n s√≥lo para admins (uso desde consola)
            window.migrarActividadesMultiEquipo = migrarActividadesMultiEquipo;
        });
    })();
    </script>

    <!-- script.js para navbar, men√∫s, etc. -->
    <script src="script.js"></script>
    <!-- L√≥gica de tabulador de per√≠odos -->
    <script src="tabulador.js"></script>
</body>
</html>