<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspecciones guardadas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="margin:0;">
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir menú">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administración</a></li>
                        <li><a href="trazabilidades.html" class="nav-admin-only">Trazabilidades</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#" class="active">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspección</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>

            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main class="inspeccion-page" style="max-width: 100%; margin: 0; padding: 0;">
        <section class="inspectlist-wrap" style="padding: 0.75rem 0.75rem 1rem;">
            <h2>Inspecciones guardadas</h2>
            <p style="font-size:0.9rem; color:#6b7280; margin-bottom:0.75rem;">
                Se muestran inspecciones registradas contra las actividades actuales. Puedes filtrar y seleccionar filas para acciones futuras.
            </p>

            <section class="actividad-toolbar" style="margin-bottom: 0.75rem; display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; justify-content:space-between;">
                <div class="actividad-toolbar-left" style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                    <input type="search" id="insp-buscar" placeholder="Buscar por cliente, área, equipo, lugar..." style="min-width: 260px;">
                </div>
                <div class="actividad-toolbar-right" style="font-size: 0.85rem; color:#4b5563;">
                    <span id="insp-contador">0 registros</span>
                </div>
            </section>

            <div class="tabla-inspecciones-wrapper">
                <table id="tabla-inspecciones" style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                    <thead>
                        <tr style="background:#f3f4f6;">
                            <th style="text-align:center; padding:0.4rem; width:32px;">
                                <input type="checkbox" id="insp-select-todos" title="Seleccionar / deseleccionar todos">
                            </th>
                            <th style="text-align:left; padding:0.4rem;">Fecha (registro)</th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Cliente</th>
                            <th style="text-align:left; padding:0.4rem; display:none;">Área</th>
                            <th style="text-align:left; padding:0.4rem;">Equipo / activo</th>
                            <th style="text-align:left; padding:0.4rem;">Tipo de inspección</th>
                            <th style="text-align:left; padding:0.4rem;">Lugar</th>
                            <th style="text-align:left; padding:0.4rem;">Evaluación</th>
                            <th style="text-align:left; padding:0.4rem;">Asignado a</th>
                            <th style="text-align:left; padding:0.4rem;">Usuario</th>
                            <th style="text-align:left; padding:0.4rem;">Observaciones</th>
                            <th style="text-align:left; padding:0.4rem;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-inspecciones"></tbody>
                </table>
                <p id="mensaje-sin-inspecciones" style="font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:none;">
                    No hay inspecciones registradas todavía.
                </p>
            </div>
        </section>
    </main>

    <script src="config.local.js"></script>
    <script type="module" src="firebase-init.js"></script>
    <script type="module">
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const auth = window.auth;

    const emailSpan = document.getElementById('nav-user-email');
    const btnLogout = document.getElementById('btn-logout');

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        const email = (user.email || '').toLowerCase();
        if (emailSpan) emailSpan.textContent = email;

        try {
            const token = await user.getIdTokenResult(true);
            const role = (token?.claims?.role) || null;
            window.userRole = role;
            window.isAdmin = role === 'admin';
            window.isDirector = role === 'director';
            window.isSupervisor = role === 'supervisor';
            window.isInspector = role === 'inspector';
            window.isCapturista = role === 'capturista';
            window.currentUserEmail = email;

            // Acceso: admin, director, supervisor, inspector, capturista
            if (!(window.isAdmin || window.isDirector || window.isSupervisor || window.isInspector || window.isCapturista)) {
                window.location.href = 'login.html';
                return;
            }
        } catch {
            try { await signOut(auth); } catch {}
            window.location.href = 'login.html';
        }
    });

    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } finally {
                window.location.href = 'login.html';
            }
        });
    }
    </script>

    <script src="nav.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('tbody-inspecciones');
        const msg = document.getElementById('mensaje-sin-inspecciones');
        const inputBuscar = document.getElementById('insp-buscar');
        const lblCont = document.getElementById('insp-contador');
        const chkTodos = document.getElementById('insp-select-todos');

        const claveInspecciones = 'pct_inspecciones';

        function formatearFechaRegistro(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleString('es-MX');
        }

        function normalizarTextoClave(v) {
            return (v || '')
                .toString()
                .toUpperCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function canonCliente(v) {
            const key = normalizarTextoClave(v);
            // Correcciones puntuales de typos frecuentes (solo display/agrupación)
            const map = {
                'HALLIBURRON': 'HALLIBURTON',
                'HALLIBUTON': 'HALLIBURTON',
            };
            return map[key] || key;
        }

        async function cargarDatos() {
            tbody.innerHTML = '';
            msg.style.display = 'none';
            if (lblCont) lblCont.textContent = '0 registros';
            if (chkTodos) chkTodos.checked = false;

            let filtro = (inputBuscar?.value || '').toLowerCase().trim();

            // 1) Leer inspecciones desde Firestore
            let inspecciones = [];
            try {
                const { getFirestore, collection, getDocs } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );

                const db = getFirestore();
                const colInsp = collection(db, 'inspecciones');
                const snapInsp = await getDocs(colInsp);
                inspecciones = snapInsp.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error al leer inspecciones desde Firestore, se usará localStorage como respaldo', e);

                try {
                    const crudo = JSON.parse(localStorage.getItem(claveInspecciones) || '[]');
                    if (Array.isArray(crudo)) inspecciones = crudo;
                } catch {
                    inspecciones = [];
                }
            }

            // Mapa por actividadId para cruce rápido
            const inspeccionPorActividad = new Map();
            inspecciones.forEach((reg, idx) => {
                if (reg && reg.actividadId) {
                    inspeccionPorActividad.set(reg.actividadId, { ...reg, _indexLocal: idx });
                }
            });

            // 2) Leer actividades desde Firestore (si el rol lo permite)
            let actividadesPermitidas = true;

            // 5.1) Admin asigna Tipo de inspección cuando falta
            tbody.querySelectorAll('.insp-select-tipo').forEach(sel => {
                sel.addEventListener('change', async () => {
                    const inspId = sel.getAttribute('data-insp-id') || '';
                    const actividadId = sel.getAttribute('data-actividad-id') || '';
                    const nuevo = String(sel.value || '').trim().toUpperCase();
                    if ((!inspId && !actividadId) || !nuevo) return;
                    try {
                        const { getFirestore, doc, updateDoc } = await import(
                            'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                        );
                        const db = getFirestore();
                        if (inspId) {
                            await updateDoc(doc(db, 'inspecciones', inspId), { tipoInspeccion: nuevo });
                            try {
                                if (typeof window.pctAudit === 'function') {
                                    await window.pctAudit('inspecciones_update_tipo', { inspId, tipoInspeccion: nuevo }, { throttleKey: `inspecciones_update_tipo_${inspId}` });
                                }
                            } catch {}
                        } else {
                            // Para pendientes (sin inspección guardada aún), guardar el tipo en la actividad
                            await updateDoc(doc(db, 'actividades', actividadId), { tipoInspeccion: nuevo });
                            try {
                                if (typeof window.pctAudit === 'function') {
                                    await window.pctAudit('actividades_update_tipo_inspeccion', { actividadId, tipoInspeccion: nuevo }, { throttleKey: `actividades_update_tipo_${actividadId}` });
                                }
                            } catch {}
                        }
                        // refrescar lista
                        cargarDatos();
                    } catch (e) {
                        console.error('No se pudo actualizar tipo de inspección', e);
                    }
                });
            });

            // 2) Leer actividades desde Firestore
            // Si las reglas lo permiten, supervisor también podrá ver pendientes.
            // Solo caemos al modo "solo inspecciones" cuando Firestore rechaza con permission-denied.
            let actividades = [];
            try {
                const { getFirestore, collection, getDocs } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );

                const db = getFirestore();
                const colRef = collection(db, 'actividades');
                const snap = await getDocs(colRef);

                actividades = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                const msgErr = String(e?.message || '').toLowerCase();
                const code = (e && e.code) ? String(e.code) : '';
                const isPerm = code === 'permission-denied' || msgErr.includes('missing or insufficient permissions') || msgErr.includes('permission-denied');
                if (isPerm) {
                    actividadesPermitidas = false;
                } else {
                    console.error('Error al leer actividades para inspectlist', e);
                }
                actividades = [];
            }

            // Si no se permite leer actividades (ej. supervisor), construir el listado solo con inspecciones.
            // En este modo no es posible mostrar "pendientes" porque depende de la lista de actividades.
            if (!actividadesPermitidas && inspecciones.length) {
                actividades = inspecciones.map(insp => ({
                    id: insp.actividadId || insp.id,
                    cliente: insp.cliente || '',
                    areaCliente: insp.areaCliente || '',
                    ubicacion: insp.ubicacion || '',
                    equipo: insp.equipo || '',
                    fechaRegistro: insp.fecha || '',
                    inspectorAsignado: insp.inspectorAsignado || ''
                }));
            }

            if (!actividades.length && !inspecciones.length) {
                msg.style.display = 'block';
                return;
            }

            // Ordenar actividades por cliente y área para agrupar visualmente
            actividades.sort((a, b) => {
                const ca = (a.cliente || '').toString().toUpperCase();
                const cb = (b.cliente || '').toString().toUpperCase();
                if (ca < cb) return -1;
                if (ca > cb) return 1;
                const aa = (a.areaCliente || '').toString().toUpperCase();
                const ab = (b.areaCliente || '').toString().toUpperCase();
                if (aa < ab) return -1;
                if (aa > ab) return 1;
                return 0;
            });

            let visibles = 0;

            function renderBloque(esRealizadas) {
                let clienteActualKey = '';
                let clienteActualLabel = '';
                let areaActual = '';
                let lugarActual = '';

                // Si no hay permisos de leer actividades, solo mostramos realizadas (las inspecciones existentes)
                if (!actividadesPermitidas && !esRealizadas) {
                    return;
                }

                actividades.forEach(act => {
                    const insp = act.id ? inspeccionPorActividad.get(act.id) : null;
                    const tieneInsp = !!insp;
                    if (esRealizadas && !tieneInsp) return;
                    if (!esRealizadas && tieneInsp) return;

                    const fechaTexto = formatearFechaRegistro(insp ? insp.fecha : act.fechaRegistro);

                    let evaluacion = 'Pendiente';
                    let estadoTexto = 'Pendiente';
                    if (insp && Array.isArray(insp.parametros) && insp.parametros.length) {
                        let evaluacionCalc = 'Operativo';
                        const hayFallo = insp.parametros.some(p => {
                            const est = (p && p.estado ? String(p.estado) : '').trim().toUpperCase();
                            return est === 'MALO' || est === 'NO LEGIBLE';
                        });
                        if (hayFallo) evaluacionCalc = 'No operativo';
                        evaluacion = evaluacionCalc;
                        estadoTexto = 'Realizada';
                    }

                    const clienteRaw = insp?.cliente || act.cliente || '';
                    const cliente = canonCliente(clienteRaw);
                    const area = insp?.areaCliente || act.areaCliente || '';
                    const lugar = insp?.ubicacion || act.ubicacion || '';
                    const equipo = insp?.equipo || act.equipo || '';
                    const usuario = insp?.usuarioInspeccion || '';
                    const tipoInsp = insp?.tipoInspeccion || act.tipoInspeccion || '';
                    const observaciones = insp?.observaciones || '';
                    const asignado = act.inspectorAsignado || '';

                    const textoBuscar = `${cliente} ${area} ${equipo} ${lugar} ${usuario} ${observaciones} ${tipoInsp}`.toLowerCase();
                    if (filtro && !textoBuscar.includes(filtro)) {
                        return;
                    }

                    let asignadoHtml = asignado || (window.isInspector ? '(Sin asignar)' : '');
                    if (window.isAdmin || window.isSupervisor) {
                        const opt = (val, label) => `<option value="${val}" ${asignado === val ? 'selected' : ''}>${label}</option>`;
                        asignadoHtml = `
                            <select class="insp-select-asignado" data-actividad-id="${act.id}" style="font-size:0.8rem; padding:0.15rem 0.35rem; border-radius:999px; border:1px solid #d1d5db; background:#ffffff;">
                                <option value="">(Sin asignar)</option>
                                ${opt('inspector01@pc-t.com.mx', 'inspector01@pc-t.com.mx')}
                                ${opt('inspector02@pc-t.com.mx', 'inspector02@pc-t.com.mx')}
                                ${opt('capturista@pc-t.com.mx', 'capturista@pc-t.com.mx')}
                                ${opt('auxger@pc-t.com.mx', 'auxger@pc-t.com.mx')}
                            </select>
                        `;
                    } else if (!asignado && window.isInspector) {
                        asignadoHtml = `
                            <button type="button" class="insp-btn-claim" data-actividad-id="${act.id}" style="font-size:0.75rem; padding:0.15rem 0.5rem; border-radius:999px; border:1px solid #d1d5db; background:#e0f2fe; color:#0369a1;">Tomar</button>
                        `;
                    }

                    const accionesHtml = (insp && (window.isAdmin || window.isInspector)) ? `
                            <button type="button" class="insp-btn-editar" data-actividad-id="${act.id}" style="font-size:0.75rem; padding:0.15rem 0.5rem; border-radius:999px; border:1px solid #bfdbfe; background:#eff6ff; color:#1d4ed8; margin-right:0.25rem;">Editar</button>
                            <button type="button" class="insp-btn-eliminar" data-actividad-id="${act.id}" style="font-size:0.75rem; padding:0.15rem 0.5rem; border-radius:999px; border:1px solid #fecaca; background:#fef2f2; color:#b91c1c;">Eliminar</button>
                        ` : '';

                    // Insertar encabezados de agrupación por cliente y área cuando cambien
                    const clienteKey = normalizarTextoClave(cliente);
                    if (cliente && clienteKey !== clienteActualKey) {
                        clienteActualKey = clienteKey;
                        clienteActualLabel = cliente;
                        areaActual = '';
                        lugarActual = '';
                        const trGrupoCliente = document.createElement('tr');
                        trGrupoCliente.className = 'insp-group-cliente';
                        trGrupoCliente.innerHTML = `
                            <td colspan="12" style="padding:0.45rem 0.6rem; background:#e5e7eb; font-weight:600; font-size:0.9rem; color:#111827; border-bottom:1px solid #d1d5db; text-transform:uppercase; letter-spacing:0.02em; cursor:pointer;">
                                Cliente: ${clienteActualLabel}
                            </td>
                        `;
                        tbody.appendChild(trGrupoCliente);
                    }

                    if (area && area !== areaActual) {
                        areaActual = area;
                        lugarActual = '';
                        const trGrupoArea = document.createElement('tr');
                        trGrupoArea.className = 'insp-group-area';
                        trGrupoArea.innerHTML = `
                            <td colspan="12" style="padding:0.35rem 0.6rem; background:#f3f4f6; font-weight:500; font-size:0.85rem; color:#374151; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" class="insp-select-area" data-cliente="${cliente}" data-area="${areaActual}" title="Seleccionar área completa">
                                <span>Área: ${areaActual}</span>
                            </td>
                        `;
                        tbody.appendChild(trGrupoArea);
                    }

                    if (lugar && lugar !== lugarActual) {
                        lugarActual = lugar;
                        const trGrupoUbic = document.createElement('tr');
                        trGrupoUbic.className = 'insp-group-ubic';
                        trGrupoUbic.innerHTML = `
                            <td colspan="12" style="padding:0.3rem 0.9rem; background:#f9fafb; font-weight:500; font-size:0.8rem; color:#4b5563; border-bottom:1px solid #e5e7eb; border-left:4px solid #9ca3af; cursor:pointer;">
                                Ubicación: ${lugarActual}
                            </td>
                        `;
                        tbody.appendChild(trGrupoUbic);
                    }

                    const tr = document.createElement('tr');
                    tr.setAttribute('data-actividad-id', act.id || '');
                    if (!insp) {
                        tr.classList.add('insp-fila-pendiente');
                        tr.style.cursor = 'pointer';
                    }

                    const tipoInspHtml = (window.isAdmin || window.isSupervisor)
                        ? `
                            <select class="insp-select-tipo" data-insp-id="${insp?.id || ''}" data-actividad-id="${act.id || ''}" style="font-size:0.8rem; padding:0.15rem 0.35rem; border-radius:0.5rem; border:1px solid #d1d5db; background:#ffffff;">
                                <option value="" ${!tipoInsp ? 'selected' : ''}>(Asignar)</option>
                                <option value="PRE-TRABAJO" ${String(tipoInsp).toUpperCase()==='PRE-TRABAJO' ? 'selected' : ''}>Pre-trabajo</option>
                                <option value="POST-TRABAJO" ${String(tipoInsp).toUpperCase()==='POST-TRABAJO' ? 'selected' : ''}>Post-trabajo</option>
                                <option value="RECEPCION" ${String(tipoInsp).toUpperCase()==='RECEPCION' ? 'selected' : ''}>Recepción</option>
                            </select>
                          `
                        : (tipoInsp || '');

                    tr.innerHTML = `
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; text-align:center;">
                            <input type="checkbox" class="insp-select-fila" data-actividad-id="${act.id}" data-cliente="${cliente}" data-area="${area}">
                        </td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${fechaTexto}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${cliente}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; display:none;">${area}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${equipo}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${tipoInspHtml}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${lugar}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${insp ? `${estadoTexto} - ${evaluacion}` : 'Pendiente'}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${asignadoHtml}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${usuario}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${observaciones}</td>
                        <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">
                            ${accionesHtml}
                        </td>
                    `;

                    tbody.appendChild(tr);
                    visibles += 1;
                });
            }

            // Primero bloque de pendientes
            renderBloque(false);

            // Insertar separador y luego bloque de realizadas (si hay)
            const hayRealizadas = Array.from(actividades).some(act => inspeccionPorActividad.has(act.id));
            if (hayRealizadas) {
                const trSep = document.createElement('tr');
                trSep.innerHTML = `
                    <td colspan="12" style="padding:0.5rem 0.75rem; background:#111827; color:#f9fafb; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.03em; border-top:2px solid #0f172a; border-bottom:1px solid #0f172a;">
                        Inspecciones realizadas
                    </td>
                `;
                tbody.appendChild(trSep);

                renderBloque(true);
            }

            if (!visibles) {
                msg.style.display = 'block';
            }
            if (lblCont) {
                lblCont.textContent = `${visibles} registro${visibles === 1 ? '' : 's'}`;
            }

            // 4) Permitir abrir la inspección desde una fila pendiente
            tbody.querySelectorAll('tr.insp-fila-pendiente').forEach(tr => {
                tr.addEventListener('click', (ev) => {
                    // No disparar cuando se hace clic en botones, selects, enlaces o checkboxes dentro de la fila
                    if (ev.target.closest('button, select, a, input[type="checkbox"]')) return;

                    const actividadId = tr.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    window.location.href = `inspeccion.html?actividadId=${encodeURIComponent(actividadId)}`;
                });
            });

            // 5) Manejar asignación de inspector (admin)
            tbody.querySelectorAll('.insp-select-asignado').forEach(sel => {
                sel.addEventListener('change', async () => {
                    const actividadId = sel.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    const nuevo = sel.value || '';

                    try {
                        const { getFirestore, doc, updateDoc } = await import(
                            'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                        );

                        const db = getFirestore();
                        const ref = doc(db, 'actividades', actividadId);
                        await updateDoc(ref, { inspectorAsignado: nuevo });
                        try {
                            if (typeof window.pctAudit === 'function') {
                                await window.pctAudit('actividades_assign_inspector', { actividadId, inspectorAsignado: nuevo }, { throttleKey: `actividades_assign_inspector_${actividadId}` });
                            }
                        } catch {}
                    } catch (e) {
                        console.error('No se pudo actualizar la asignación de inspector', e);
                    }
                });
            });

            // 6) Inspectores pueden reclamar inspecciones no asignadas
            tbody.querySelectorAll('.insp-btn-claim').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const actividadId = btn.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    const email = (window.currentUserEmail || '').toLowerCase();
                    if (!email || !window.isInspector) return;

                    try {
                        const { getFirestore, doc, updateDoc } = await import(
                            'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                        );

                        const db = getFirestore();
                        const ref = doc(db, 'actividades', actividadId);
                        await updateDoc(ref, { inspectorAsignado: email });

                        try {
                            if (typeof window.pctAudit === 'function') {
                                await window.pctAudit('actividades_take_inspector', { actividadId, inspectorAsignado: email }, { throttleKey: `actividades_take_inspector_${actividadId}` });
                            }
                        } catch {}

                        cargarDatos();
                    } catch (e) {
                        console.error('No se pudo tomar la inspección', e);
                    }
                });
            });

            // 7) Editar inspecciones realizadas (reabrir formato)
            tbody.querySelectorAll('.insp-btn-editar').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const actividadId = btn.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;
                    window.location.href = `inspeccion.html?actividadId=${encodeURIComponent(actividadId)}`;
                });
            });

            // 8) Manejar eliminación de inspecciones realizadas (no toca actividades)
            tbody.querySelectorAll('.insp-btn-eliminar').forEach(btn => {
                btn.addEventListener('click', () => {
                    const actividadId = btn.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    if (!confirm('¿Eliminar esta inspección? Esta acción no se puede deshacer.')) return;

                    (async () => {
                        try {
                            // Eliminar de Firestore
                            const { getFirestore, collection, query, where, getDocs, deleteDoc, doc } = await import(
                                'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                            );

                            const db = getFirestore();
                            const colInsp = collection(db, 'inspecciones');
                            const q = query(colInsp, where('actividadId', '==', actividadId));
                            const snap = await getDocs(q);
                            const ops = snap.docs.map(d => deleteDoc(doc(db, 'inspecciones', d.id)));
                            await Promise.all(ops);
                            try {
                                if (typeof window.pctAudit === 'function') {
                                    await window.pctAudit('inspecciones_delete_by_actividad', { actividadId, count: ops.length }, { throttleKey: `inspecciones_delete_by_actividad_${actividadId}` });
                                }
                            } catch {}
                        } catch (e) {
                            console.error('No se pudo eliminar la inspección en Firestore', e);
                        }

                        // También limpiar en localStorage como respaldo
                        let actuales = [];
                        try {
                            actuales = JSON.parse(localStorage.getItem(claveInspecciones) || '[]');
                            if (!Array.isArray(actuales)) actuales = [];
                        } catch {
                            actuales = [];
                        }

                        actuales = actuales.filter(reg => reg.actividadId !== actividadId);
                        localStorage.setItem(claveInspecciones, JSON.stringify(actuales));

                        cargarDatos();
                    })();
                });
            });

            // 9) Lógica de selección múltiple
            const filasChk = tbody.querySelectorAll('.insp-select-fila');
            if (chkTodos) {
                chkTodos.checked = filasChk.length > 0 && Array.from(filasChk).every(chk => chk.checked);
                chkTodos.onchange = () => {
                    const marcado = chkTodos.checked;
                    filasChk.forEach(chk => {
                        chk.checked = marcado;
                    });
                    // sincronizar áreas
                    tbody.querySelectorAll('.insp-select-area').forEach(chkArea => {
                        chkArea.checked = marcado;
                    });
                };
            }

            // Selección por área
            tbody.querySelectorAll('.insp-select-area').forEach(chkArea => {
                chkArea.addEventListener('change', () => {
                    const area = chkArea.getAttribute('data-area') || '';
                    const cliente = chkArea.getAttribute('data-cliente') || '';
                    const filasArea = tbody.querySelectorAll(`.insp-select-fila[data-area="${area}"][data-cliente="${cliente}"]`);
                    filasArea.forEach(chkFila => {
                        chkFila.checked = chkArea.checked;
                    });

                    const todasFilas = tbody.querySelectorAll('.insp-select-fila');
                    const todasMarcadas = todasFilas.length > 0 && Array.from(todasFilas).every(chk => chk.checked);
                    if (chkTodos) chkTodos.checked = todasMarcadas;
                });
            });

            // Actualizar maestro cuando se hace clic individualmente
            filasChk.forEach(chkFila => {
                chkFila.addEventListener('change', () => {
                    const todasFilas = tbody.querySelectorAll('.insp-select-fila');
                    const todasMarcadas = todasFilas.length > 0 && Array.from(todasFilas).every(c => c.checked);
                    if (chkTodos) chkTodos.checked = todasMarcadas;

                    // Actualizar cada área
                    tbody.querySelectorAll('.insp-select-area').forEach(chkArea => {
                        const area = chkArea.getAttribute('data-area') || '';
                        const cliente = chkArea.getAttribute('data-cliente') || '';
                        const filasArea = tbody.querySelectorAll(`.insp-select-fila[data-area="${area}"][data-cliente="${cliente}"]`);
                        const todasAreaMarcadas = filasArea.length > 0 && Array.from(filasArea).every(c => c.checked);
                        chkArea.checked = todasAreaMarcadas;
                    });
                });
            });

            // 10) Colapsado básico por cliente, área y ubicación
            const colapsarDesde = (tr, nivel) => {
                const colapsado = tr.dataset.colapsado === '1';
                tr.dataset.colapsado = colapsado ? '0' : '1';
                let fila = tr.nextElementSibling;
                while (fila) {
                    if (fila.classList.contains('insp-group-cliente')) break;
                    if (nivel === 'area' && fila.classList.contains('insp-group-area')) break;
                    if (nivel === 'ubic' && (fila.classList.contains('insp-group-area') || fila.classList.contains('insp-group-ubic'))) break;
                    fila.style.display = colapsado ? '' : 'none';
                    fila = fila.nextElementSibling;
                }
            };

            tbody.querySelectorAll('.insp-group-cliente').forEach(tr => {
                tr.addEventListener('click', () => colapsarDesde(tr, 'cliente'));
            });
            tbody.querySelectorAll('.insp-group-area').forEach(tr => {
                tr.addEventListener('click', () => colapsarDesde(tr, 'area'));
            });
            tbody.querySelectorAll('.insp-group-ubic').forEach(tr => {
                tr.addEventListener('click', () => colapsarDesde(tr, 'ubic'));
            });
        }

        if (inputBuscar) {
            inputBuscar.addEventListener('input', () => {
                cargarDatos();
            });
        }

        cargarDatos();
    });
    </script>
</body>
</html>
