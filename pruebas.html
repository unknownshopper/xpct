<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas y calibraciones</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir menú">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="#" class="active">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspección</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="#">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administración</a></li>
                        <li><a href="trazabilidades.html" class="nav-admin-only">Trazabilidades</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main class="pruebas-page">
        

        <section class="card-prueba">
            <h2>Información desde inventario</h2>
            <div class="grid-inventario-prueba">
                <div class="campo">
                    <label for="inv-equipo">Equipo / Activo (inventario)</label>
                    <input type="text" id="inv-equipo" list="lista-equipos-pruebas" placeholder="Equipo/Activo (inventario)">
                    <datalist id="lista-equipos-pruebas"></datalist>
                </div>
                <div class="campo">
                    <label for="inv-serial">Serial</label>
                    <input type="text" id="inv-serial" list="lista-seriales-pruebas" placeholder="SERIAL">
                    <datalist id="lista-seriales-pruebas"></datalist>
                </div>

                <div class="campo">
                    <label for="inv-edo">Edo. general</label>
                    <input type="text" id="inv-edo" placeholder="EDO_GENERAL">
                </div>
                <div class="campo">
                    <label for="inv-propiedad">Propiedad</label>
                    <input type="text" id="inv-propiedad" placeholder="PROPIEDAD">
                </div>

                <div class="campo">
                    <label for="inv-producto">Producto</label>
                    <input type="text" id="inv-producto" placeholder="PRODUCTO">
                </div>
                <div class="campo">
                    <label for="inv-descripcion">Descripción</label>
                    <input type="text" id="inv-descripcion" placeholder="DESCRIPCION">
                </div>

                <div class="campo">
                    <label for="inv-prueba">Prueba / Calibración</label>
                    <select id="inv-prueba" required>
                        <option value="">Selecciona...</option>
                    </select>
                </div>
                <div class="campo" id="campo-prueba-detalle" style="display:none;">
                    <label for="inv-prueba-detalle">Detalle de prueba (área específica)</label>
                    <select id="inv-prueba-detalle">
                        <option value="">Selecciona...</option>
                        <option value="ROSCA MARIPOSA">Rosca/Mariposa</option>
                        <option value="RETENEDOR">Retenedor</option>
                    </select>
                </div>
                <div class="campo">
                    <label for="inv-material">Material</label>
                    <input type="text" id="inv-material" placeholder="Material">
                </div>
                <div class="campo">
                    <label for="inv-area">Área de prueba</label>
                    <input type="text" id="inv-area" placeholder="ÁREA DE PRUEBA">
                </div>

                <div class="campo">
                    <label for="inv-periodo">Periodo</label>
                    <select id="inv-periodo">
                        <option value="ANUAL" selected>Anual</option>
                        <option value="POST-TRABAJO">Post-trabajo</option>
                        <option value="REPARACION">Reparación</option>
                    </select>
                </div>

                <div class="campo">
                    <label for="inv-fecha-realizacion">Fecha realización</label>
                    <input type="text" id="inv-fecha-realizacion" placeholder="__/__/__" maxlength="8" required>
                </div>
                <div class="campo">
                    <label for="inv-no-reporte">No. de reporte / certificado</label>
                    <input type="text" id="inv-no-reporte" placeholder="NO. DE REPORTE / CERTIFICADO" required>
                </div>

                <div class="campo">
                    <label for="inv-ejecucion">Ejecución</label>
                    <select id="inv-ejecucion">
                        <option value="INTERNO">INTERNO</option>
                        <option value="EXTERNO">EXTERNO</option>
                    </select>
                </div>
                <div class="campo">
                    <label for="inv-emisor">Emisor</label>
                    <input type="text" id="inv-emisor" placeholder="EMISOR" required>
                </div>

                <div class="campo">
                    <label for="inv-tecnico">Técnico</label>
                    <input type="text" id="inv-tecnico" placeholder="TECNICO" required>
                </div>
                <div class="campo">
                    <label for="prueba-resultado">Resultado</label>
                    <select id="prueba-resultado" name="prueba-resultado" required>
                        <option value="">Selecciona...</option>
                        <option value="ACEPTADA">ACEPTADA</option>
                        <option value="RECHAZADA">RECHAZADA</option>
                    </select>
                </div>
                <div class="campo">
                    <label for="inv-proxima">Próxima prueba</label>
                    <input type="text" id="inv-proxima" placeholder="dd/mm/aa" maxlength="8">
                </div>

                <div class="campo">
                    <label for="inv-contador">Contador</label>
                    <input type="text" id="inv-contador" placeholder="CONTADOR">
                </div>
            </div>
        </section>

        <section class="card-prueba">
            <h2>Observaciones</h2>
            <div class="campo">
                <label for="prueba-observaciones">Observaciones</label>
                <textarea id="prueba-observaciones" rows="4" placeholder="Notas, condiciones de ensayo, evidencias, etc."></textarea>
            </div>
        </section>

        <section class="card-prueba" style="display:flex; justify-content:space-between; align-items:center;">
            <button id="btn-guardar-prueba">Guardar prueba</button>
            <a href="pruebaslist.html" class="link-inspecciones" id="link-ver-pruebas">Ver pruebas guardadas</a>
        </section>
    </main>

    <script src="config.local.js"></script>
    <script type="module" src="firebase-init.js"></script>
    <script type="module">
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const auth = window.auth;
        const db = window.db;

        const emailSpan = document.getElementById('nav-user-email');
        const btnLogout = document.getElementById('btn-logout');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'website.html';
                return;
            }

            const email = (user.email || '').toLowerCase();
            if (emailSpan) emailSpan.textContent = email;
            window.currentUserEmail = email;

            try {
                const token = await user.getIdTokenResult(true);
                const role = (token?.claims?.role) || null;
                window.userRole = role;
                window.isAdmin = role === 'admin';
                window.isDirector = role === 'director';
                window.isInspector = role === 'inspector';
                window.isCapturista = role === 'capturista';

                // Acceso permitido: admin, director, inspector, capturista
                // Inspector puede registrar pruebas (modo offline-first con lista local del día)

                try {
                    const linkVer = document.getElementById('link-ver-pruebas');
                    if (linkVer && window.isInspector) {
                        linkVer.href = 'pruebaslist.html?local=1';
                    }
                } catch {}

                // El campo Técnico queda abierto para que lo capture el usuario (sin autocompletar ni bloquear)
            } catch {}
        });

        if (btnLogout) {
            btnLogout.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } finally {
                    window.location.href = 'website.html';
                }
            });
        }
    </script>

    <script src="nav.js"></script>
    <script src="utils.js"></script>
    <script src="inspector-pruebas-store.js"></script>
    <script src="pruebas.js"></script>
</body>
</html>
