<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspecciones guardadas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="margin:0;">
    <header>
        <div class="logo">
            <img src="img/logopctch.png" alt="Logo PCT">
        </div>
        <button class="nav-toggle" type="button" aria-label="Abrir menú">
            &#9776;
        </button>
        <nav class="nav-main">
            <ul>
                <li><a href="index.html">Inicio</a></li>

                <li class="nav-item-has-dropdown">
                    <a href="actividad.html">Actividad</a>
                    <ul class="nav-dropdown">
                        <li><a href="actividad.html">Registrar actividad</a></li>
                        <li><a href="actividadlist.html">Listado de actividades</a></li>
                        <li><a href="actividadmin.html" class="nav-admin-only">Administración</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="pruebas.html">Pruebas</a>
                    <ul class="nav-dropdown">
                        <li><a href="pruebas.html">Registrar prueba</a></li>
                        <li><a href="pruebaslist.html">Listado de pruebas</a></li>
                    </ul>
                </li>

                <li class="nav-item-has-dropdown">
                    <a href="inspeccion.html" class="active">Inspecciones</a>
                    <ul class="nav-dropdown">
                        <li><a href="inspeccion.html">Nueva inspección</a></li>
                        <li><a href="inspectlist.html">Listado de inspecciones</a></li>
                    </ul>
                </li>

            </ul>
        </nav>
        <div class="user-info">
            <span class="user-info-email" id="nav-user-email"></span>
            <button id="btn-logout">Salir</button>
        </div>
    </header>

    <main class="inspeccion-page" style="max-width: 100%; margin: 0; padding: 0;">
        <section class="inspectlist-wrap">
            <h2>Inspecciones guardadas (local)</h2>
            <p style="font-size:0.9rem; color:#6b7280; margin-bottom:0.75rem;">
                Estos datos se almacenan solo en este navegador usando <code>localStorage</code>. Más adelante se pueden enviar a Firebase u otro backend.
            </p>
            <div class="tabla-inspecciones-wrapper">
                <table id="tabla-inspecciones" style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                    <thead>
                        <tr style="background:#f3f4f6;">
                            <th style="text-align:left; padding:0.4rem;">Fecha (registro)</th>
                            <th style="text-align:left; padding:0.4rem;">Cliente</th>
                            <th style="text-align:left; padding:0.4rem;">Área</th>
                            <th style="text-align:left; padding:0.4rem;">Equipo / activo</th>
                            <th style="text-align:left; padding:0.4rem;">Lugar</th>
                            <th style="text-align:left; padding:0.4rem;">Evaluación</th>
                            <th style="text-align:left; padding:0.4rem;">Asignado a</th>
                            <th style="text-align:left; padding:0.4rem;">Usuario</th>
                            <th style="text-align:left; padding:0.4rem;">Observaciones</th>
                            <th style="text-align:left; padding:0.4rem;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-inspecciones"></tbody>
                </table>
                <p id="mensaje-sin-inspecciones" style="font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:none;">
                    No hay inspecciones guardadas todavía.
                </p>
            </div>
        </section>
    </main>

    <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCmutjS09d1hCjwlhuH0upkGr_TIVVBktc",
        authDomain: "xpct-tab.firebaseapp.com",
        projectId: "xpct-tab",
        storageBucket: "xpct-tab.firebasestorage.app",
        messagingSenderId: "614589989974",
        appId: "1:614589989974:web:e89a808180e4b563a8e7f7"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    window.auth = auth;

    const ADMINS = [
        "the@unknownshoppers.com",
        "jalcz@pct.com"
    ];
    const INSPECTORES = [
        "inspector01@pct.com",
        "inspector02@pct.com"
    ];

    const emailSpan = document.getElementById('nav-user-email');
    const btnLogout = document.getElementById('btn-logout');

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        const email = (user.email || '').toLowerCase();
        if (emailSpan) emailSpan.textContent = email;

        window.isAdmin = ADMINS.includes(email);
        window.isInspector = INSPECTORES.includes(email);
        window.currentUserEmail = email;

        // Solo admins e inspectores pueden ver esta página
        if (!ADMINS.includes(email) && !INSPECTORES.includes(email)) {
            window.location.href = 'login.html';
        }
    });

    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } finally {
                window.location.href = 'login.html';
            }
        });
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('tbody-inspecciones');
        const msg = document.getElementById('mensaje-sin-inspecciones');

        const claveInspecciones = 'pct_inspecciones';

        function formatearFechaRegistro(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleString('es-MX');
        }

        async function cargarDatos() {
            tbody.innerHTML = '';
            msg.style.display = 'none';

            // 1) Leer inspecciones desde Firestore
            let inspecciones = [];
            try {
                const { getFirestore, collection, getDocs } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );

                const db = getFirestore();
                const colInsp = collection(db, 'inspecciones');
                const snapInsp = await getDocs(colInsp);
                inspecciones = snapInsp.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error al leer inspecciones desde Firestore, se usará localStorage como respaldo', e);

                try {
                    const crudo = JSON.parse(localStorage.getItem(claveInspecciones) || '[]');
                    if (Array.isArray(crudo)) inspecciones = crudo;
                } catch {
                    inspecciones = [];
                }
            }

            // Mapa por actividadId para cruce rápido
            const inspeccionPorActividad = new Map();
            inspecciones.forEach((reg, idx) => {
                if (reg && reg.actividadId) {
                    inspeccionPorActividad.set(reg.actividadId, { ...reg, _indexLocal: idx });
                }
            });

            // 2) Leer actividades desde Firestore
            let actividades = [];
            try {
                const { getFirestore, collection, getDocs } = await import(
                    'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                );

                const db = getFirestore();
                const colRef = collection(db, 'actividades');
                const snap = await getDocs(colRef);

                actividades = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error('Error al leer actividades para inspectlist', e);
                actividades = [];
            }

            if (!actividades.length && !inspecciones.length) {
                msg.style.display = 'block';
                return;
            }

            // 3) Construir filas a partir de actividades, marcando si hay inspección realizada
            actividades.forEach(act => {
                const insp = act.id ? inspeccionPorActividad.get(act.id) : null;

                const tr = document.createElement('tr');

                const fechaTexto = formatearFechaRegistro(insp ? insp.fecha : act.fechaRegistro);

                let evaluacion = 'Pendiente';
                if (insp && Array.isArray(insp.parametros) && insp.parametros.length) {
                    let evaluacionCalc = 'Operativo';
                    const hayFallo = insp.parametros.some(p => {
                        const est = (p && p.estado ? String(p.estado) : '').trim().toUpperCase();
                        return est === 'MALO' || est === 'NO LEGIBLE';
                    });
                    if (hayFallo) evaluacionCalc = 'No operativo';
                    evaluacion = evaluacionCalc;
                }

                const cliente = insp?.cliente || act.cliente || '';
                const area = insp?.areaCliente || act.areaCliente || '';
                const lugar = insp?.ubicacion || act.ubicacion || '';
                const equipo = insp?.equipo || act.equipo || '';
                const usuario = insp?.usuarioInspeccion || '';
                const observaciones = insp?.observaciones || '';
                const asignado = act.inspectorAsignado || '';

                let asignadoHtml = asignado || (window.isInspector ? '(Sin asignar)' : '');
                if (window.isAdmin) {
                    const opt = (val, label) => `<option value="${val}" ${asignado === val ? 'selected' : ''}>${label}</option>`;
                    asignadoHtml = `
                        <select class="insp-select-asignado" data-actividad-id="${act.id}" style="font-size:0.8rem; padding:0.15rem 0.35rem; border-radius:999px; border:1px solid #d1d5db; background:#ffffff;">
                            <option value="">(Sin asignar)</option>
                            ${opt('inspector01@pct.com', 'inspector01@pct.com')}
                            ${opt('inspector02@pct.com', 'inspector02@pct.com')}
                        </select>
                    `;
                } else if (!asignado && window.isInspector) {
                    asignadoHtml = `
                        <button type="button" class="insp-btn-claim" data-actividad-id="${act.id}" style="font-size:0.75rem; padding:0.15rem 0.5rem; border-radius:999px; border:1px solid #d1d5db; background:#e0f2fe; color:#0369a1;">Tomar</button>
                    `;
                }

                tr.innerHTML = `
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${fechaTexto}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${cliente}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${area}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${equipo}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${lugar}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">${evaluacion}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${asignadoHtml}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${usuario}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb;">${observaciones}</td>
                    <td style="padding:0.35rem; border-bottom:1px solid #e5e7eb; white-space:nowrap;">
                        ${insp ? `<button type="button" class="insp-btn-eliminar" data-actividad-id="${act.id}" style="font-size:0.75rem; padding:0.15rem 0.5rem; border-radius:999px; border:1px solid #fecaca; background:#fef2f2; color:#b91c1c;">Eliminar inspección</button>` : ''}
                    </td>
                `;

                tbody.appendChild(tr);
            });

            // 4) Manejar asignación de inspector (admin)
            tbody.querySelectorAll('.insp-select-asignado').forEach(sel => {
                sel.addEventListener('change', async () => {
                    const actividadId = sel.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    const nuevo = sel.value || '';

                    try {
                        const { getFirestore, doc, updateDoc } = await import(
                            'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                        );

                        const db = getFirestore();
                        const ref = doc(db, 'actividades', actividadId);
                        await updateDoc(ref, { inspectorAsignado: nuevo });
                    } catch (e) {
                        console.error('No se pudo actualizar la asignación de inspector', e);
                    }
                });
            });

            // 5) Inspectores pueden reclamar inspecciones no asignadas
            tbody.querySelectorAll('.insp-btn-claim').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const actividadId = btn.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    const email = (window.currentUserEmail || '').toLowerCase();
                    if (!email || !window.isInspector) return;

                    try {
                        const { getFirestore, doc, updateDoc } = await import(
                            'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                        );

                        const db = getFirestore();
                        const ref = doc(db, 'actividades', actividadId);
                        await updateDoc(ref, { inspectorAsignado: email });

                        cargarDatos();
                    } catch (e) {
                        console.error('No se pudo reclamar la inspección', e);
                    }
                });
            });

            // 6) Manejar eliminación de inspecciones realizadas (no toca actividades)
            tbody.querySelectorAll('.insp-btn-eliminar').forEach(btn => {
                btn.addEventListener('click', () => {
                    const actividadId = btn.getAttribute('data-actividad-id') || '';
                    if (!actividadId) return;

                    if (!confirm('¿Eliminar esta inspección? Esta acción no se puede deshacer.')) return;

                    (async () => {
                        try {
                            // Eliminar de Firestore
                            const { getFirestore, collection, query, where, getDocs, deleteDoc, doc } = await import(
                                'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js'
                            );

                            const db = getFirestore();
                            const colInsp = collection(db, 'inspecciones');
                            const q = query(colInsp, where('actividadId', '==', actividadId));
                            const snap = await getDocs(q);
                            const ops = snap.docs.map(d => deleteDoc(doc(db, 'inspecciones', d.id)));
                            await Promise.all(ops);
                        } catch (e) {
                            console.error('No se pudo eliminar la inspección en Firestore', e);
                        }

                        // También limpiar en localStorage como respaldo
                        let actuales = [];
                        try {
                            actuales = JSON.parse(localStorage.getItem(claveInspecciones) || '[]');
                            if (!Array.isArray(actuales)) actuales = [];
                        } catch {
                            actuales = [];
                        }

                        actuales = actuales.filter(reg => reg.actividadId !== actividadId);
                        localStorage.setItem(claveInspecciones, JSON.stringify(actuales));

                        cargarDatos();
                    })();
                });
            });
        }

        cargarDatos();
    });
    </script>
</body>
</html>
